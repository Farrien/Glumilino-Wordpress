tinymce.PluginManager.add("wpeditimage",function(J){function I(a){return !(!J.dom.getAttrib(a,"data-mce-placeholder")&&!J.dom.getAttrib(a,"data-mce-object"))}function H(a){var d=J.$(a).parents("[contenteditable]");return d&&"false"===d.attr("contenteditable")}function G(a){return a.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(K,r,q){var p,o,n,m,l,k;return p=r.match(/id=['"]([^'"]*)['"] ?/),p&&(r=r.replace(p[0],"")),o=r.match(/align=['"]([^'"]*)['"] ?/),o&&(r=r.replace(o[0],"")),n=r.match(/class=['"]([^'"]*)['"] ?/),n&&(r=r.replace(n[0],"")),k=r.match(/width=['"]([0-9]*)['"] ?/),k&&(r=r.replace(k[0],"")),q=t(q),l=q.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i),l&&l[2]?(m=t(l[2]),l=t(l[1])):(m=t(r).replace(/caption=['"]/,"").replace(/['"]$/,""),l=q),p=p&&p[1]?p[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",n=n&&n[1]?" "+n[1].replace(/[<>&]+/g,""):"",!k&&l&&(k=l.match(/width=['"]([0-9]*)['"]/)),k&&k[1]&&(k=k[1]),k&&m?(k=parseInt(k,10),J.getParam("wpeditimage_html5_captions")||(k+=10),'<div class="mceTemp"><dl id="'+p+'" class="wp-caption '+o+n+'" style="width: '+k+'px"><dt class="wp-caption-dt">'+l+'</dt><dd class="wp-caption-dd">'+m+"</dd></dl></div>"):q})}function F(b){return b.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,d){var f="";return d.indexOf("<img ")===-1||d.indexOf("</p>")!==-1?d.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(f=d.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(j,i,p,o){var n,m,l,k;return k=p.match(/width="([0-9]*)"/),k=k&&k[1]?k[1]:"",m=i.match(/class="([^"]*)"/),m=m&&m[1]?m[1]:"",l=m.match(/align[a-z]+/i)||"alignnone",k&&o?(n=i.match(/id="([^"]*)"/),n=n&&n[1]?n[1]:"",m=m.replace(/wp-caption ?|align[a-z]+ ?/gi,""),m&&(m=' class="'+m+'"'),o=o.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(c){return c.replace(/[\r\n\t]+/," ")}),o=o.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+n+'" align="'+l+'" width="'+k+'"'+m+"]"+p+" "+o+"[/caption]"):("alignnone"!==l[0]&&(p=p.replace(/><img/,' class="'+l[0]+'"><img')),p)}),f.indexOf("[caption")===-1&&(f=d.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),f)})}function E(P){var O,N,M,L,K,r,q,p,o=[],n=J.dom,a=/^\d+$/;return M={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},M.url=n.getAttrib(P,"src"),M.alt=n.getAttrib(P,"alt"),M.title=n.getAttrib(P,"title"),q=n.getAttrib(P,"width"),p=n.getAttrib(P,"height"),(!a.test(q)||parseInt(q,10)<1)&&(q=P.naturalWidth||P.width),(!a.test(p)||parseInt(p,10)<1)&&(p=P.naturalHeight||P.height),M.customWidth=M.width=q,M.customHeight=M.height=p,O=tinymce.explode(P.className," "),N=[],tinymce.each(O,function(b){/^wp-image/.test(b)?M.attachment_id=parseInt(b.replace("wp-image-",""),10):/^align/.test(b)?M.align=b.replace("align",""):/^size/.test(b)?M.size=b.replace("size-",""):N.push(b)}),M.extraClasses=N.join(" "),L=n.getParents(P,".wp-caption"),L.length&&(L=L[0],O=L.className.split(" "),tinymce.each(O,function(b){/^align/.test(b)?M.align=b.replace("align",""):b&&"wp-caption"!==b&&o.push(b)}),M.captionClassName=o.join(" "),K=n.select("dd.wp-caption-dd",L),K.length&&(K=K[0],M.caption=J.serializer.serialize(K).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),P.parentNode&&"A"===P.parentNode.nodeName&&(r=P.parentNode,M.linkUrl=n.getAttrib(r,"href"),M.linkTargetBlank="_blank"===n.getAttrib(r,"target"),M.linkRel=n.getAttrib(r,"rel"),M.linkClassName=r.className),M}function D(b){return b&&!(!b.textContent&&!b.innerText)}function C(a){return !a||a.indexOf("<")===-1&&a.indexOf(">")===-1?a:(x||(x=new tinymce.html.Serializer({},J.schema)),x.serialize(J.parser.parse(a,{forced_root_block:!1})))}function B(ac,ab){var aa,Z,Y,X,W,V,U,T,S,R,Q,P,O,N,M,L,K,h,g,a=J.dom;aa=tinymce.explode(ab.extraClasses," "),aa||(aa=[]),ab.caption||aa.push("align"+ab.align),ab.attachment_id&&(aa.push("wp-image-"+ab.attachment_id),ab.size&&"custom"!==ab.size&&aa.push("size-"+ab.size)),N=ab.width,M=ab.height,"custom"===ab.size&&(N=ab.customWidth,M=ab.customHeight),P={src:ab.url,width:N||null,height:M||null,title:ab.title||null,"class":aa.join(" ")||null},a.setAttribs(ac,P),J.$(ac).attr("alt",ab.alt||""),O={href:ab.linkUrl,rel:ab.linkRel||null,target:ab.linkTargetBlank?"_blank":null,"class":ab.linkClassName||null},ac.parentNode&&"A"===ac.parentNode.nodeName&&!D(ac.parentNode)?ab.linkUrl?a.setAttribs(ac.parentNode,O):a.remove(ac.parentNode,!0):ab.linkUrl&&((U=a.getParent(ac,"a"))&&a.insertAfter(ac,U),U=a.create("a",O),ac.parentNode.insertBefore(U,ac),U.appendChild(ac)),T=J.dom.getParent(ac,".mceTemp"),Y=ac.parentNode&&"A"===ac.parentNode.nodeName&&!D(ac.parentNode)?ac.parentNode:ac,ab.caption?(ab.caption=C(ab.caption),Q=ab.attachment_id?"attachment_"+ab.attachment_id:null,L="align"+(ab.align||"none"),Z="wp-caption "+L,ab.captionClassName&&(Z+=" "+ab.captionClassName.replace(/[<>&]+/g,"")),J.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),T?(R=a.select("dl.wp-caption",T),R.length&&a.setAttribs(R,{id:Q,"class":Z,style:"width: "+N+"px"}),S=a.select(".wp-caption-dd",T),S.length&&a.setHTML(S[0],ab.caption)):(Q=Q?'id="'+Q+'" ':"",X="<dl "+Q+'class="'+Z+'" style="width: '+N+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+ab.caption+"</dd></dl>",V=a.create("div",{"class":"mceTemp"},X),(W=a.getParent(Y,"p"))?W.parentNode.insertBefore(V,W):Y.parentNode.insertBefore(V,Y),J.$(V).find("dt.wp-caption-dt").append(Y),W&&a.isEmpty(W)&&a.remove(W))):T&&(W=a.create("p"),T.parentNode.insertBefore(W,T),W.appendChild(Y),a.remove(T)),K=J.$(ac),h=K.attr("srcset"),g=K.attr("src"),h&&g&&(g=g.replace(/[?#].*/,""),h.indexOf(g)===-1&&K.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:J,metadata:ab,image:ac}),J.nodeChanged()}function A(a){var h,g,f;return"undefined"!=typeof wp&&wp.media?(f=E(a),wp.media.events.trigger("editor:image-edit",{editor:J,metadata:f,image:a}),h=wp.media({frame:"image",state:"image-details",metadata:f}),wp.media.events.trigger("editor:frame-create",{frame:h}),g=function(b){J.focus(),J.undoManager.transact(function(){B(a,b)}),h.detach()},h.state("image-details").on("update",g),h.state("replace-image").on("replace",g),h.on("close",function(){J.focus(),h.detach()}),void h.open()):void J.execCommand("mceImage")}function z(a){var d=J.dom.getParent(a,"div.mceTemp");d||"IMG"!==a.nodeName||(d=J.dom.getParent(a,"a")),d?(d.nextSibling?J.selection.select(d.nextSibling):d.previousSibling?J.selection.select(d.previousSibling):J.selection.select(d.parentNode),J.selection.collapse(!0),J.dom.remove(d)):J.dom.remove(a),J.nodeChanged(),J.undoManager.add()}var y,x,w,v,u=tinymce.each,t=tinymce.trim,s=tinymce.Env.iOS;return J.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){z(J.selection.getNode())}}),J.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){A(J.selection.getNode())}}),u({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(a,f){var e=f.slice(5);J.addButton("wp_img_"+f,{tooltip:a,icon:"dashicon dashicons-align-"+e,cmd:"alignnone"===f?"wpAlignNone":"Justify"+e.slice(0,1).toUpperCase()+e.slice(1),onPostRender:function(){var c=this;J.on("NodeChange",function(g){var b;"IMG"===g.element.nodeName&&(b=J.dom.getParent(g.element,".wp-caption")||g.element,"alignnone"===f?c.active(!/\balign(left|center|right)\b/.test(b.className)):c.active(J.dom.hasClass(b,f)))})}})}),J.once("preinit",function(){J.wp&&J.wp._createToolbar&&(y=J.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),J.on("wptoolbar",function(b){"IMG"!==b.element.nodeName||I(b.element)||(b.toolbar=y)}),s&&J.on("init",function(){J.on("touchstart",function(b){"IMG"!==b.target.nodeName||H(b.target)||(w=!0)}),J.dom.bind(J.getDoc(),"touchmove",function(){w=!1}),J.on("touchend",function(a){if(w&&"IMG"===a.target.nodeName&&!H(a.target)){var c=a.target;w=!1,window.setTimeout(function(){J.selection.select(c),J.nodeChanged()},100)}else{y&&y.hide()}})}),J.on("init",function(){var a=J.dom,d=J.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";a.addClass(J.getBody(),d),J.on("wpLoadImageForm",function(e){if(!J.getParam("wpeditimage_disable_captions")){var f={type:"textbox",flex:1,name:"wpcaption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"};e.data.splice(e.data.length-1,0,f)}}),J.on("wpNewImageRefresh",function(b){var f,e;(f=a.getParent(b.node,"dl.wp-caption"))&&(f.style.width||(e=parseInt(b.node.clientWidth,10)+10,e=e?e+"px":"50%",a.setStyle(f,"width",e)))}),J.on("wpImageFormSubmit",function(Q){var P,O,N,M,L=Q.imgData.data,K=Q.imgData.node,r=Q.imgData.wpcaption,q="",p="",h="",b=null;return L.id="__wp-temp-img-id",Q.imgData.cancel=!0,L.style||(L.style=null),L.src?(r&&(r=r.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(c){return c.replace(/[\r\n\t]+/," ")}),r=r.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />"),r=C(r)),K?(b=K.id||null,a.setAttribs(K,L),P=a.getParent(K,"dl.wp-caption"),r?P?(O=a.select("dd.wp-caption-dd",P)[0])&&(O.innerHTML=r):(K.className&&(q=K.className.match(/wp-image-([0-9]+)/),p=K.className.match(/align(left|right|center|none)/)),p?(p=p[0],K.className=K.className.replace(/align(left|right|center|none)/g,"")):p="alignnone",p=' class="wp-caption '+p+'"',q&&(q=' id="attachment_'+q[1]+'"'),h=L.width||K.clientWidth,h&&(h=parseInt(h,10),J.getParam("wpeditimage_html5_captions")||(h+=10),h=' style="width: '+h+'px"'),N=K.parentNode&&"A"===K.parentNode.nodeName?K.parentNode:K,M="<dl "+q+p+h+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+r+"</dd></dl>",P=a.create("div",{"class":"mceTemp"},M),(O=a.getParent(N,"p"))?O.parentNode.insertBefore(P,O):N.parentNode.insertBefore(P,N),J.$(P).find("dt.wp-caption-dt").append(N),O&&a.isEmpty(O)&&a.remove(O)):P&&(M="A"===K.parentNode.nodeName?a.getOuterHTML(K.parentNode):a.getOuterHTML(K),O=a.create("p",{},M),a.insertAfter(O,P.parentNode),J.selection.select(O),J.nodeChanged(),a.remove(P.parentNode))):(M=a.createHTML("img",L),r?(N=J.selection.getNode(),L.width&&(h=parseInt(L.width,10),J.getParam("wpeditimage_html5_captions")||(h+=10),h=' style="width: '+h+'px"'),M='<dl class="wp-caption alignnone"'+h+'><dt class="wp-caption-dt">'+M+'</dt><dd class="wp-caption-dd">'+r+"</dd></dl>",O="P"===N.nodeName?N:a.getParent(N,"p"),O&&"P"===O.nodeName?(P=a.create("div",{"class":"mceTemp"},M),O.parentNode.insertBefore(P,O),J.selection.select(P),J.nodeChanged(),a.isEmpty(O)&&a.remove(O)):J.selection.setContent('<div class="mceTemp">'+M+"</div>")):J.selection.setContent(M)),K=a.get("__wp-temp-img-id"),a.setAttrib(K,"id",b||null),void (Q.imgData.node=K)):void (K&&((P=a.getParent(K,"div.mceTemp"))?a.remove(P):"A"===K.parentNode.nodeName?a.remove(K.parentNode):a.remove(K),J.nodeChanged()))}),J.on("wpLoadImageData",function(i){var h,g=i.imgData.data,b=i.imgData.node;(h=a.getParent(b,"dl.wp-caption"))&&(h=a.select("dd.wp-caption-dd",h)[0],h&&(g.wpcaption=J.serializer.serialize(h).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")))}),tinymce.Env.ie&&tinymce.Env.ie>10&&a.bind(J.getBody(),"mscontrolselect",function(b){"IMG"===b.target.nodeName&&a.getParent(b.target,".wp-caption")?J.getBody().focus():"DL"===b.target.nodeName&&a.hasClass(b.target,"wp-caption")&&b.target.focus()})}),J.on("ObjectResized",function(a){var d=a.target;"IMG"===d.nodeName&&J.undoManager.transact(function(){var g,c,b=J.dom;d.className=d.className.replace(/\bsize-[^ ]+/,""),(g=b.getParent(d,".wp-caption"))&&(c=a.width||b.getAttrib(d,"width"),c&&(c=parseInt(c,10),J.getParam("wpeditimage_html5_captions")||(c+=10),b.setStyle(g,"width",c+"px")))})}),J.on("pastePostProcess",function(a){J.dom.getParent(J.selection.getNode(),"dd.wp-caption-dd")&&(J.$("img, audio, video, object, embed, iframe, script, style",a.node).remove(),J.$("*",a.node).each(function(d,e){J.dom.isBlock(e)&&(tinymce.trim(e.textContent||e.innerText)?(J.dom.insertAfter(J.dom.create("br"),e),J.dom.remove(e,!0)):J.dom.remove(e))}),J.$("br",a.node).each(function(d,e){e.nextSibling&&"BR"!==e.nextSibling.nodeName&&e.previousSibling&&"BR"!==e.previousSibling.nodeName||J.dom.remove(e)}),v=!0)}),J.on("BeforeExecCommand",function(r){var q,p,o,n,m,l,k=r.command,a=J.dom;if("mceInsertContent"===k||"Indent"===k||"Outdent"===k){if(q=J.selection.getNode(),l=a.getParent(q,"div.mceTemp")){if("mceInsertContent"!==k){return r.preventDefault(),r.stopImmediatePropagation(),!1}if(v){return void (v=!1)}p=a.create("p"),a.insertAfter(p,l),J.selection.setCursorLocation(p,0),J.nodeChanged()}}else{if("JustifyLeft"===k||"JustifyRight"===k||"JustifyCenter"===k||"wpAlignNone"===k){if(q=J.selection.getNode(),n="align"+k.slice(7).toLowerCase(),o=J.dom.getParent(q,".wp-caption"),"IMG"!==q.nodeName&&!o){return}q=o||q,m=J.dom.hasClass(q,n)?" alignnone":" "+n,q.className=t(q.className.replace(/ ?align(left|center|right|none)/g,"")+m),J.nodeChanged(),r.preventDefault(),y&&y.reposition(),J.fire("ExecCommand",{command:k,ui:r.ui,value:r.value})}}}),J.on("keydown",function(r){var q,p,o,n,m=J.selection,l=r.keyCode,k=J.dom,a=tinymce.util.VK;if(l===a.ENTER){q=m.getNode(),p=k.getParent(q,"div.mceTemp"),p&&(k.events.cancel(r),tinymce.each(k.select("dt, dd",p),function(b){k.isEmpty(b)&&k.remove(b)}),n=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',o=k.create("p",null,n),"DD"===q.nodeName?k.insertAfter(o,p):p.parentNode.insertBefore(o,p),J.nodeChanged(),m.setCursorLocation(o,0))}else{if((l===a.DELETE||l===a.BACKSPACE)&&(q=m.getNode(),"DIV"===q.nodeName&&k.hasClass(q,"mceTemp")?p=q:"IMG"!==q.nodeName&&"DT"!==q.nodeName&&"A"!==q.nodeName||(p=k.getParent(q,"div.mceTemp")),p)){return k.events.cancel(r),z(q),!1}}}),tinymce.Env.gecko&&J.on("undo redo",function(){"IMG"===J.selection.getNode().nodeName&&J.selection.collapse()}),J.wpSetImgCaption=function(b){return G(b)},J.wpGetImgCaption=function(b){return F(b)},J.on("beforeGetContent",function(a){"raw"!==a.format&&J.$('img[id="__wp-temp-img-id"]').attr("id",null)}),J.on("BeforeSetContent",function(a){"raw"!==a.format&&(a.content=J.wpSetImgCaption(a.content))}),J.on("PostProcess",function(a){a.get&&(a.content=J.wpGetImgCaption(a.content))}),function(){var a;J.on("dragstart",function(){var b=J.selection.getNode();"IMG"===b.nodeName&&(a=J.dom.getParent(b,".mceTemp"),a||"A"!==b.parentNode.nodeName||D(b.parentNode)||(a=b.parentNode))}),J.on("drop",function(g){var f=J.dom,b=tinymce.dom.RangeUtils.getCaretRangeFromPoint(g.clientX,g.clientY,J.getDoc());b&&f.getParent(b.startContainer,".mceTemp")?g.preventDefault():a&&(g.preventDefault(),J.undoManager.transact(function(){b&&J.selection.setRng(b),J.selection.setNode(a),f.remove(a)})),a=null})}(),J.wp=J.wp||{},J.wp.isPlaceholder=I,{_do_shcode:G,_get_shcode:F}});
tinymce.PluginManager.add("wpeditimage",function(e){var j,q,p,b,c=tinymce.each,n=tinymce.trim,d=tinymce.Env.iOS;function o(s){return !!(e.dom.getAttrib(s,"data-mce-placeholder")||e.dom.getAttrib(s,"data-mce-object"))}e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){k(e.selection.getNode())}});e.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){f(e.selection.getNode())}});c({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,s){var u=s.slice(5);e.addButton("wp_img_"+s,{tooltip:t,icon:"dashicon dashicons-align-"+u,cmd:"alignnone"===s?"wpAlignNone":"Justify"+u.slice(0,1).toUpperCase()+u.slice(1),onPostRender:function(){var v=this;e.on("NodeChange",function(x){var w;if(x.element.nodeName!=="IMG"){return}w=e.dom.getParent(x.element,".wp-caption")||x.element;if("alignnone"===s){v.active(!/\balign(left|center|right)\b/.test(w.className))}else{v.active(e.dom.hasClass(w,s))}})}})});e.once("preinit",function(){if(e.wp&&e.wp._createToolbar){j=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"])}});e.on("wptoolbar",function(s){if(s.element.nodeName==="IMG"&&!o(s.element)){s.toolbar=j}});function l(t){var s=e.$(t).parents("[contenteditable]");return s&&s.attr("contenteditable")==="false"}if(d){e.on("init",function(){e.on("touchstart",function(s){if(s.target.nodeName==="IMG"&&!l(s.target)){p=true}});e.dom.bind(e.getDoc(),"touchmove",function(){p=false});e.on("touchend",function(t){if(p&&t.target.nodeName==="IMG"&&!l(t.target)){var s=t.target;p=false;window.setTimeout(function(){e.selection.select(s);e.nodeChanged()},100)}else{if(j){j.hide()}}})})}function a(s){return s.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(A,z,y){var u,x,v,B,w,t;u=z.match(/id=['"]([^'"]*)['"] ?/);if(u){z=z.replace(u[0],"")}x=z.match(/align=['"]([^'"]*)['"] ?/);if(x){z=z.replace(x[0],"")}v=z.match(/class=['"]([^'"]*)['"] ?/);if(v){z=z.replace(v[0],"")}t=z.match(/width=['"]([0-9]*)['"] ?/);if(t){z=z.replace(t[0],"")}y=n(y);w=y.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i);if(w&&w[2]){B=n(w[2]);w=n(w[1])}else{B=n(z).replace(/caption=['"]/,"").replace(/['"]$/,"");w=y}u=(u&&u[1])?u[1].replace(/[<>&]+/g,""):"";x=(x&&x[1])?x[1]:"alignnone";v=(v&&v[1])?" "+v[1].replace(/[<>&]+/g,""):"";if(!t&&w){t=w.match(/width=['"]([0-9]*)['"]/)}if(t&&t[1]){t=t[1]}if(!t||!B){return y}t=parseInt(t,10);if(!e.getParam("wpeditimage_html5_captions")){t+=10}return'<div class="mceTemp"><dl id="'+u+'" class="wp-caption '+x+v+'" style="width: '+t+'px"><dt class="wp-caption-dt">'+w+'</dt><dd class="wp-caption-dd">'+B+"</dd></dl></div>"})}function g(s){return s.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(v,u){var t="";if(u.indexOf("<img ")===-1||u.indexOf("</p>")!==-1){return u.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,"")}t=u.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(x,w,D,y){var C,z,B,A;A=D.match(/width="([0-9]*)"/);A=(A&&A[1])?A[1]:"";z=w.match(/class="([^"]*)"/);z=(z&&z[1])?z[1]:"";B=z.match(/align[a-z]+/i)||"alignnone";if(!A||!y){if("alignnone"!==B[0]){D=D.replace(/><img/,' class="'+B[0]+'"><img')}return D}C=w.match(/id="([^"]*)"/);C=(C&&C[1])?C[1]:"";z=z.replace(/wp-caption ?|align[a-z]+ ?/gi,"");if(z){z=' class="'+z+'"'}y=y.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(E){return E.replace(/[\r\n\t]+/," ")});y=y.replace(/\s*\n\s*/g,"<br />");return'[caption id="'+C+'" align="'+B+'" width="'+A+'"'+z+"]"+D+" "+y+"[/caption]"});if(t.indexOf("[caption")===-1){t=u.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")}return t})}function r(B){var t,u,A,y,D,z,s,C,x=[],w=e.dom,v=/^\d+$/;A={attachment_id:false,size:"custom",caption:"",align:"none",extraClasses:"",link:false,linkUrl:"",linkClassName:"",linkTargetBlank:false,linkRel:"",title:""};A.url=w.getAttrib(B,"src");A.alt=w.getAttrib(B,"alt");A.title=w.getAttrib(B,"title");s=w.getAttrib(B,"width");C=w.getAttrib(B,"height");if(!v.test(s)||parseInt(s,10)<1){s=B.naturalWidth||B.width}if(!v.test(C)||parseInt(C,10)<1){C=B.naturalHeight||B.height}A.customWidth=A.width=s;A.customHeight=A.height=C;t=tinymce.explode(B.className," ");u=[];tinymce.each(t,function(E){if(/^wp-image/.test(E)){A.attachment_id=parseInt(E.replace("wp-image-",""),10)}else{if(/^align/.test(E)){A.align=E.replace("align","")}else{if(/^size/.test(E)){A.size=E.replace("size-","")}else{u.push(E)}}}});A.extraClasses=u.join(" ");y=w.getParents(B,".wp-caption");if(y.length){y=y[0];t=y.className.split(" ");tinymce.each(t,function(E){if(/^align/.test(E)){A.align=E.replace("align","")}else{if(E&&E!=="wp-caption"){x.push(E)}}});A.captionClassName=x.join(" ");D=w.select("dd.wp-caption-dd",y);if(D.length){D=D[0];A.caption=e.serializer.serialize(D).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")}}if(B.parentNode&&B.parentNode.nodeName==="A"){z=B.parentNode;A.linkUrl=w.getAttrib(z,"href");A.linkTargetBlank=w.getAttrib(z,"target")==="_blank"?true:false;A.linkRel=w.getAttrib(z,"rel");A.linkClassName=z.className}return A}function m(s){return s&&!!(s.textContent||s.innerText)}function h(s){if(!s||(s.indexOf("<")===-1&&s.indexOf(">")===-1)){return s}if(!q){q=new tinymce.html.Serializer({},e.schema)}return q.serialize(e.parser.parse(s,{forced_root_block:false}))}function i(y,L){var M,t,E,x,v,w,s,D,N,I,A,B,K,C,z,H,F,G,u,J=e.dom;M=tinymce.explode(L.extraClasses," ");if(!M){M=[]}if(!L.caption){M.push("align"+L.align)}if(L.attachment_id){M.push("wp-image-"+L.attachment_id);if(L.size&&L.size!=="custom"){M.push("size-"+L.size)}}C=L.width;z=L.height;if(L.size==="custom"){C=L.customWidth;z=L.customHeight}B={src:L.url,width:C||null,height:z||null,title:L.title||null,"class":M.join(" ")||null};J.setAttribs(y,B);e.$(y).attr("alt",L.alt||"");K={href:L.linkUrl,rel:L.linkRel||null,target:L.linkTargetBlank?"_blank":null,"class":L.linkClassName||null};if(y.parentNode&&y.parentNode.nodeName==="A"&&!m(y.parentNode)){if(L.linkUrl){J.setAttribs(y.parentNode,K)}else{J.remove(y.parentNode,true)}}else{if(L.linkUrl){if(s=J.getParent(y,"a")){J.insertAfter(y,s)}s=J.create("a",K);y.parentNode.insertBefore(s,y);s.appendChild(y)}}D=e.dom.getParent(y,".mceTemp");if(y.parentNode&&y.parentNode.nodeName==="A"&&!m(y.parentNode)){E=y.parentNode}else{E=y}if(L.caption){L.caption=h(L.caption);A=L.attachment_id?"attachment_"+L.attachment_id:null;H="align"+(L.align||"none");t="wp-caption "+H;if(L.captionClassName){t+=" "+L.captionClassName.replace(/[<>&]+/g,"")}if(!e.getParam("wpeditimage_html5_captions")){C=parseInt(C,10);C+=10}if(D){I=J.select("dl.wp-caption",D);if(I.length){J.setAttribs(I,{id:A,"class":t,style:"width: "+C+"px"})}N=J.select(".wp-caption-dd",D);if(N.length){J.setHTML(N[0],L.caption)}}else{A=A?'id="'+A+'" ':"";x="<dl "+A+'class="'+t+'" style="width: '+C+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+L.caption+"</dd></dl>";w=J.create("div",{"class":"mceTemp"},x);if(v=J.getParent(E,"p")){v.parentNode.insertBefore(w,v)}else{E.parentNode.insertBefore(w,E)}e.$(w).find("dt.wp-caption-dt").append(E);if(v&&J.isEmpty(v)){J.remove(v)}}}else{if(D){v=J.create("p");D.parentNode.insertBefore(v,D);v.appendChild(E);J.remove(D)}}F=e.$(y);G=F.attr("srcset");u=F.attr("src");if(G&&u){u=u.replace(/[?#].*/,"");if(G.indexOf(u)===-1){F.attr("srcset",null).attr("sizes",null)}}if(wp.media.events){wp.media.events.trigger("editor:image-update",{editor:e,metadata:L,image:y})}e.nodeChanged()}function f(s){var u,v,t;if(typeof wp==="undefined"||!wp.media){e.execCommand("mceImage");return}t=r(s);wp.media.events.trigger("editor:image-edit",{editor:e,metadata:t,image:s});u=wp.media({frame:"image",state:"image-details",metadata:t});wp.media.events.trigger("editor:frame-create",{frame:u});v=function(w){e.focus();e.undoManager.transact(function(){i(s,w)});u.detach()};u.state("image-details").on("update",v);u.state("replace-image").on("replace",v);u.on("close",function(){e.focus();u.detach()});u.open()}function k(t){var s=e.dom.getParent(t,"div.mceTemp");if(!s&&t.nodeName==="IMG"){s=e.dom.getParent(t,"a")}if(s){if(s.nextSibling){e.selection.select(s.nextSibling)}else{if(s.previousSibling){e.selection.select(s.previousSibling)}else{e.selection.select(s.parentNode)}}e.selection.collapse(true);e.dom.remove(s)}else{e.dom.remove(t)}e.nodeChanged();e.undoManager.add()}e.on("init",function(){var t=e.dom,s=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),s);e.on("wpLoadImageForm",function(u){if(e.getParam("wpeditimage_disable_captions")){return}var v={type:"textbox",flex:1,name:"wpcaption",minHeight:60,multiline:true,scroll:true,label:"Image caption"};u.data.splice(u.data.length-1,0,v)});e.on("wpNewImageRefresh",function(v){var u,w;if(u=t.getParent(v.node,"dl.wp-caption")){if(!u.style.width){w=parseInt(v.node.clientWidth,10)+10;w=w?w+"px":"50%";t.setStyle(u,"width",w)}}});e.on("wpImageFormSubmit",function(u){var y=u.imgData.data,D=u.imgData.node,E=u.imgData.wpcaption,C="",F="",A="",v=null,w,B,x,z;y.id="__wp-temp-img-id";u.imgData.cancel=true;if(!y.style){y.style=null}if(!y.src){if(D){if(w=t.getParent(D,"div.mceTemp")){t.remove(w)}else{if(D.parentNode.nodeName==="A"){t.remove(D.parentNode)}else{t.remove(D)}}e.nodeChanged()}return}if(E){E=E.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(G){return G.replace(/[\r\n\t]+/," ")});E=E.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />");E=h(E)}if(!D){z=t.createHTML("img",y);if(E){x=e.selection.getNode();if(y.width){A=parseInt(y.width,10);if(!e.getParam("wpeditimage_html5_captions")){A+=10}A=' style="width: '+A+'px"'}z='<dl class="wp-caption alignnone"'+A+'><dt class="wp-caption-dt">'+z+'</dt><dd class="wp-caption-dd">'+E+"</dd></dl>";if(x.nodeName==="P"){B=x}else{B=t.getParent(x,"p")}if(B&&B.nodeName==="P"){w=t.create("div",{"class":"mceTemp"},z);B.parentNode.insertBefore(w,B);e.selection.select(w);e.nodeChanged();if(t.isEmpty(B)){t.remove(B)}}else{e.selection.setContent('<div class="mceTemp">'+z+"</div>")}}else{e.selection.setContent(z)}}else{v=D.id||null;t.setAttribs(D,y);w=t.getParent(D,"dl.wp-caption");if(E){if(w){if(B=t.select("dd.wp-caption-dd",w)[0]){B.innerHTML=E}}else{if(D.className){C=D.className.match(/wp-image-([0-9]+)/);F=D.className.match(/align(left|right|center|none)/)}if(F){F=F[0];D.className=D.className.replace(/align(left|right|center|none)/g,"")}else{F="alignnone"}F=' class="wp-caption '+F+'"';if(C){C=' id="attachment_'+C[1]+'"'}A=y.width||D.clientWidth;if(A){A=parseInt(A,10);if(!e.getParam("wpeditimage_html5_captions")){A+=10}A=' style="width: '+A+'px"'}if(D.parentNode&&D.parentNode.nodeName==="A"){x=D.parentNode}else{x=D}z="<dl "+C+F+A+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+E+"</dd></dl>";w=t.create("div",{"class":"mceTemp"},z);if(B=t.getParent(x,"p")){B.parentNode.insertBefore(w,B)}else{x.parentNode.insertBefore(w,x)}e.$(w).find("dt.wp-caption-dt").append(x);if(B&&t.isEmpty(B)){t.remove(B)}}}else{if(w){if(D.parentNode.nodeName==="A"){z=t.getOuterHTML(D.parentNode)}else{z=t.getOuterHTML(D)}B=t.create("p",{},z);t.insertAfter(B,w.parentNode);e.selection.select(B);e.nodeChanged();t.remove(w.parentNode)}}}D=t.get("__wp-temp-img-id");t.setAttrib(D,"id",v||null);u.imgData.node=D});e.on("wpLoadImageData",function(v){var u,x=v.imgData.data,w=v.imgData.node;if(u=t.getParent(w,"dl.wp-caption")){u=t.select("dd.wp-caption-dd",u)[0];if(u){x.wpcaption=e.serializer.serialize(u).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")}}});if(tinymce.Env.ie&&tinymce.Env.ie>10){t.bind(e.getBody(),"mscontrolselect",function(u){if(u.target.nodeName==="IMG"&&t.getParent(u.target,".wp-caption")){e.getBody().focus()}else{if(u.target.nodeName==="DL"&&t.hasClass(u.target,"wp-caption")){u.target.focus()}}})}});e.on("ObjectResized",function(t){var s=t.target;if(s.nodeName==="IMG"){e.undoManager.transact(function(){var v,u,w=e.dom;s.className=s.className.replace(/\bsize-[^ ]+/,"");if(v=w.getParent(s,".wp-caption")){u=t.width||w.getAttrib(s,"width");if(u){u=parseInt(u,10);if(!e.getParam("wpeditimage_html5_captions")){u+=10}w.setStyle(v,"width",u+"px")}}})}});e.on("pastePostProcess",function(s){if(e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")){e.$("img, audio, video, object, embed, iframe, script, style",s.node).remove();e.$("*",s.node).each(function(t,u){if(e.dom.isBlock(u)){if(tinymce.trim(u.textContent||u.innerText)){e.dom.insertAfter(e.dom.create("br"),u);e.dom.remove(u,true)}else{e.dom.remove(u)}}});e.$("br",s.node).each(function(t,u){if(!u.nextSibling||u.nextSibling.nodeName==="BR"||!u.previousSibling||u.previousSibling.nodeName==="BR"){e.dom.remove(u)}});b=true}});e.on("BeforeExecCommand",function(t){var y,u,s,A,v,w,x=t.command,z=e.dom;if(x==="mceInsertContent"||x==="Indent"||x==="Outdent"){y=e.selection.getNode();w=z.getParent(y,"div.mceTemp");if(w){if(x==="mceInsertContent"){if(b){b=false;return}u=z.create("p");z.insertAfter(u,w);e.selection.setCursorLocation(u,0);e.nodeChanged()}else{t.preventDefault();t.stopImmediatePropagation();return false}}}else{if(x==="JustifyLeft"||x==="JustifyRight"||x==="JustifyCenter"||x==="wpAlignNone"){y=e.selection.getNode();A="align"+x.slice(7).toLowerCase();s=e.dom.getParent(y,".wp-caption");if(y.nodeName!=="IMG"&&!s){return}y=s||y;if(e.dom.hasClass(y,A)){v=" alignnone"}else{v=" "+A}y.className=n(y.className.replace(/ ?align(left|center|right|none)/g,"")+v);e.nodeChanged();t.preventDefault();if(j){j.reposition()}e.fire("ExecCommand",{command:x,ui:t.ui,value:t.value})}}});e.on("keydown",function(s){var u,t,w,x,z=e.selection,A=s.keyCode,v=e.dom,y=tinymce.util.VK;if(A===y.ENTER){u=z.getNode();t=v.getParent(u,"div.mceTemp");if(t){v.events.cancel(s);tinymce.each(v.select("dt, dd",t),function(B){if(v.isEmpty(B)){v.remove(B)}});x=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />';w=v.create("p",null,x);if(u.nodeName==="DD"){v.insertAfter(w,t)}else{t.parentNode.insertBefore(w,t)}e.nodeChanged();z.setCursorLocation(w,0)}}else{if(A===y.DELETE||A===y.BACKSPACE){u=z.getNode();if(u.nodeName==="DIV"&&v.hasClass(u,"mceTemp")){t=u}else{if(u.nodeName==="IMG"||u.nodeName==="DT"||u.nodeName==="A"){t=v.getParent(u,"div.mceTemp")}}if(t){v.events.cancel(s);k(u);return false}}}});if(tinymce.Env.gecko){e.on("undo redo",function(){if(e.selection.getNode().nodeName==="IMG"){e.selection.collapse()}})}e.wpSetImgCaption=function(s){return a(s)};e.wpGetImgCaption=function(s){return g(s)};e.on("beforeGetContent",function(s){if(s.format!=="raw"){e.$('img[id="__wp-temp-img-id"]').attr("id",null)}});e.on("BeforeSetContent",function(s){if(s.format!=="raw"){s.content=e.wpSetImgCaption(s.content)}});e.on("PostProcess",function(s){if(s.get){s.content=e.wpGetImgCaption(s.content)}});(function(){var s;e.on("dragstart",function(){var t=e.selection.getNode();if(t.nodeName==="IMG"){s=e.dom.getParent(t,".mceTemp");if(!s&&t.parentNode.nodeName==="A"&&!m(t.parentNode)){s=t.parentNode}}});e.on("drop",function(u){var v=e.dom,t=tinymce.dom.RangeUtils.getCaretRangeFromPoint(u.clientX,u.clientY,e.getDoc());if(t&&v.getParent(t.startContainer,".mceTemp")){u.preventDefault()}else{if(s){u.preventDefault();e.undoManager.transact(function(){if(t){e.selection.setRng(t)}e.selection.setNode(s);v.remove(s)})}}s=null})})();e.wp=e.wp||{};e.wp.isPlaceholder=o;return{_do_shcode:a,_get_shcode:g}});
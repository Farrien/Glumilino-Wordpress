tinymce.PluginManager.add("wpgallery",function(g){function f(b){return b.replace(/\[gallery([^\]]*)\]/g,function(c){return j("wp-gallery",c)})}function j(d,c){return c=window.encodeURIComponent(c),'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+d+'" data-wp-media="'+c+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />'}function i(d){function c(k,e){return e=new RegExp(e+'="([^"]+)"').exec(k),e?window.decodeURIComponent(e[1]):""}return d.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(b,k){var e=c(k,"data-wp-media");return e?"<p>"+e+"</p>":b})}function h(a){var m,l,k;"IMG"===a.nodeName&&"undefined"!=typeof wp&&wp.media&&(k=window.decodeURIComponent(g.dom.getAttrib(a,"data-wp-media")),g.dom.hasClass(a,"wp-gallery")&&wp.media.gallery&&(m=wp.media.gallery,l=m.edit(k),l.state("gallery-edit").on("update",function(c){var b=m.shortcode(c).string();g.dom.setAttrib(a,"data-wp-media",window.encodeURIComponent(b)),l.detach()})))}g.addCommand("WP_Gallery",function(){h(g.selection.getNode())}),g.on("mouseup",function(a){function l(){k.removeClass(k.select("img.wp-media-selected"),"wp-media-selected")}var k=g.dom,e=a.target;"IMG"===e.nodeName&&k.getAttrib(e,"data-wp-media")?2!==a.button&&(k.hasClass(e,"wp-media-selected")?h(e):(l(),k.addClass(e,"wp-media-selected"))):l()}),g.on("ResolveName",function(a){var k=g.dom,e=a.target;"IMG"===e.nodeName&&k.getAttrib(e,"data-wp-media")&&k.hasClass(e,"wp-gallery")&&(a.name="gallery")}),g.on("BeforeSetContent",function(a){g.plugins.wpview&&"undefined"!=typeof wp&&wp.mce||(a.content=f(a.content))}),g.on("PostProcess",function(b){b.get&&(b.content=i(b.content))})});
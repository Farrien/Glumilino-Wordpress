tinymce.PluginManager.add("wpgallery",function(d){function e(f){return f.replace(/\[gallery([^\]]*)\]/g,function(g){return c("wp-gallery",g)})}function c(f,g){g=window.encodeURIComponent(g);return'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+f+'" data-wp-media="'+g+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />'}function a(g){function f(i,h){h=new RegExp(h+'="([^"]+)"').exec(i);return h?window.decodeURIComponent(h[1]):""}return g.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(h,j){var i=f(j,"data-wp-media");if(i){return"<p>"+i+"</p>"}return h})}function b(g){var f,i,h;if(g.nodeName!=="IMG"){return}if(typeof wp==="undefined"||!wp.media){return}h=window.decodeURIComponent(d.dom.getAttrib(g,"data-wp-media"));if(d.dom.hasClass(g,"wp-gallery")&&wp.media.gallery){f=wp.media.gallery;i=f.edit(h);i.state("gallery-edit").on("update",function(j){var k=f.shortcode(j).string();d.dom.setAttrib(g,"data-wp-media",window.encodeURIComponent(k));i.detach()})}}d.addCommand("WP_Gallery",function(){b(d.selection.getNode())});d.on("mouseup",function(h){var i=d.dom,g=h.target;function f(){i.removeClass(i.select("img.wp-media-selected"),"wp-media-selected")}if(g.nodeName==="IMG"&&i.getAttrib(g,"data-wp-media")){if(h.button!==2){if(i.hasClass(g,"wp-media-selected")){b(g)}else{f();i.addClass(g,"wp-media-selected")}}}else{f()}});d.on("ResolveName",function(g){var h=d.dom,f=g.target;if(f.nodeName==="IMG"&&h.getAttrib(f,"data-wp-media")){if(h.hasClass(f,"wp-gallery")){g.name="gallery"}}});d.on("BeforeSetContent",function(f){if(!d.plugins.wpview||typeof wp==="undefined"||!wp.mce){f.content=e(f.content)}});d.on("PostProcess",function(f){if(f.get){f.content=a(f.content)}})});
(function(b,c){if(b.Env.ie&&b.Env.ie<9){return}function a(d){return d.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}b.PluginManager.add("wptextpattern",function(h){var m=b.util.VK;var f=h.settings.wptextpattern||{};var o=f.space||[{regExp:/^[*-]\s/,cmd:"InsertUnorderedList"},{regExp:/^1[.)]\s/,cmd:"InsertOrderedList"}];var i=f.enter||[{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:">",format:"blockquote"},{regExp:/^(-){3,}$/,element:"hr"}];var g=f.inline||[{delimiter:"`",format:"code"}];var e;h.on("selectionchange",function(){e=null});h.on("keydown",function(p){if((e&&p.keyCode===27)||(e==="space"&&p.keyCode===m.BACKSPACE)){h.undoManager.undo();p.preventDefault();p.stopImmediatePropagation()}if(m.metaKeyPressed(p)){return}if(p.keyCode===m.ENTER){j()}else{if(p.keyCode===m.SPACEBAR){c(d)}else{if(p.keyCode>47&&!(p.keyCode>=91&&p.keyCode<=93)){c(k)}}}},true);function k(){var p=h.selection.getRng();var q=p.startContainer;var r=p.startOffset;var v;var w;var t;var x;var u;if(!q||q.nodeType!==3||!q.data.length||!r){return}var s=q.data.slice(0,r);var y=q.data.charAt(r-1);b.each(g,function(E){if(y!==E.delimiter.slice(-1)){return}var z=a(E.delimiter);var C=E.delimiter.charAt(0);var B=new RegExp("(.*)"+z+".+"+z+"$");var A=s.match(B);if(!A){return}v=A[1].length;w=r-E.delimiter.length;var D=s.charAt(v-1);var F=s.charAt(v+E.delimiter.length);if(v&&/\S/.test(D)){if(/\s/.test(F)||D===C){return}}if((new RegExp("^[\\s"+a(C)+"]+$")).test(s.slice(v,w))){return}t=E;return false});if(!t){return}x=h.formatter.get(t.format);if(x&&x[0].inline){h.undoManager.add();h.undoManager.transact(function(){q.insertData(r,"\uFEFF");q=q.splitText(v);u=q.splitText(r-v);q.deleteData(0,t.delimiter.length);q.deleteData(q.data.length-t.delimiter.length,t.delimiter.length);h.formatter.apply(t.format,{},q);h.selection.setCursorLocation(u,1)});c(function(){e="space";h.once("selectionchange",function(){var z;if(u){z=u.data.indexOf("\uFEFF");if(z!==-1){u.deleteData(z,z+1)}}})})}}function l(q){var p=h.dom.getParent(q,"p"),r;if(!p){return}while(r=p.firstChild){if(r.nodeType!==3){p=r}else{break}}if(!r){return}if(!r.data){if(r.nextSibling&&r.nextSibling.nodeType===3){r=r.nextSibling}else{r=null}}return r}function d(){var p=h.selection.getRng(),r=p.startContainer,q,s;if(!r||l(r)!==r){return}q=r.parentNode;s=r.data;b.each(o,function(u){var t=s.match(u.regExp);if(!t||p.startOffset!==t[0].length){return}h.undoManager.add();h.undoManager.transact(function(){r.deleteData(0,t[0].length);if(!q.innerHTML){q.appendChild(document.createElement("br"))}h.selection.setCursorLocation(q);h.execCommand(u.cmd)});c(function(){e="space"});return false})}function j(){var p=h.selection.getRng(),v=p.startContainer,s=l(v),q=i.length,u,t,r;if(!s){return}u=s.data;while(q--){if(i[q].start){if(u.indexOf(i[q].start)===0){t=i[q];break}}else{if(i[q].regExp){if(i[q].regExp.test(u)){t=i[q];break}}}}if(!t){return}if(s===v&&b.trim(u)===t.start){return}h.once("keyup",function(){h.undoManager.add();h.undoManager.transact(function(){if(t.format){h.formatter.apply(t.format,{},s);s.replaceData(0,s.data.length,n(s.data.slice(t.start.length)))}else{if(t.element){r=s.parentNode&&s.parentNode.parentNode;if(r){r.replaceChild(document.createElement(t.element),s.parentNode)}}}});c(function(){e="enter"})})}function n(p){return p?p.replace(/^\s+/,""):""}})})(window.tinymce,window.setTimeout);
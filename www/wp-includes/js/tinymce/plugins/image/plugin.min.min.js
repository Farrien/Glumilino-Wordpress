tinymce.PluginManager.add("image",function(h){function j(c,a){var d=document.createElement("img");function e(m,n){if(d.parentNode){d.parentNode.removeChild(d)}a({width:m,height:n})}d.onload=function(){e(Math.max(d.width,d.clientWidth),Math.max(d.height,d.clientHeight))};d.onerror=function(){e()};var b=d.style;b.visibility="hidden";b.position="fixed";b.bottom=b.left=0;b.width=b.height="auto";document.body.appendChild(d);d.src=c}function i(b,d,a){function c(e,l){l=l||[];tinymce.each(e,function(k){var n={text:k.text||k.title};if(k.menu){n.menu=c(k.menu)}else{n.value=k.value;d(n)}l.push(n)});return l}return c(b,a||[])}function f(a){return function(){var b=h.settings.image_list;if(typeof b=="string"){tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}})}else{if(typeof b=="function"){b(a)}else{a(b)}}}}function g(D){var J,a={},A=h.dom,M,C;var E,G,z,K,I=h.settings.image_dimensions!==false;function N(){var k,m,n,l;k=J.find("#width")[0];m=J.find("#height")[0];if(!k||!m){return}n=k.value();l=m.value();if(J.find("#constrain")[0].checked()&&E&&G&&n&&l){if(E!=n){l=Math.round((n/E)*l);if(!isNaN(l)){m.value(l)}}else{n=Math.round((l/G)*n);if(!isNaN(n)){k.value(n)}}}E=n;G=l}function H(){var k,n;function m(o){function p(){o.onload=o.onerror=null;if(h.selection){h.selection.select(o);h.nodeChanged()}}o.onload=function(){if(!a.width&&!a.height&&I){A.setAttribs(o,{width:o.clientWidth,height:o.clientHeight});h.fire("wpNewImageRefresh",{node:o})}p()};o.onerror=p}F();N();a=tinymce.extend(a,J.toJSON());var l=a.wpcaption;if(!a.alt){a.alt=""}if(!a.title){a.title=""}if(a.width===""){a.width=null}if(a.height===""){a.height=null}if(!a.style){a.style=null}a={src:a.src,alt:a.alt,title:a.title,width:a.width,height:a.height,style:a.style,caption:a.caption,"class":a["class"]};h.undoManager.transact(function(){var o={node:M,data:a,wpcaption:l};h.fire("wpImageFormSubmit",{imgData:o});if(o.cancel){m(o.node);return}if(!a.src){if(M){A.remove(M);h.focus();h.nodeChanged()}return}if(a.title===""){a.title=null}if(!M){a.id="__mcenew";h.focus();h.selection.setContent(A.createHTML("img",a));M=A.get("__mcenew");A.setAttrib(M,"id",null)}else{A.setAttribs(M,a)}h.editorUpload.uploadImagesAuto();if(a.caption===false){if(A.is(M.parentNode,"figure.image")){k=M.parentNode;A.insertAfter(M,k);A.remove(k)}}function p(r){return h.schema.getTextBlockElements()[r.nodeName]}if(a.caption===true){if(!A.is(M.parentNode,"figure.image")){n=M;M=M.cloneNode(true);k=A.create("figure",{"class":"image"});k.appendChild(M);k.appendChild(A.create("figcaption",{contentEditable:true},"Caption"));k.contentEditable=false;var q=A.getParent(n,p);if(q){A.split(q,n,k)}else{A.replace(k,n)}h.selection.select(k)}return}m(M)})}function c(k){if(k){k=k.replace(/px$/,"")}return k}function B(n){var l,k,m,o=n.meta||{};if(z){z.value(h.convertURL(this.value(),"src"))}tinymce.each(o,function(p,q){J.find("#"+q).value(p)});if(!o.width&&!o.height){l=h.convertURL(this.value(),"src");k=h.settings.image_prepend_url;m=new RegExp("^(?:[a-z]+:)?//","i");if(k&&!m.test(l)&&l.substring(0,k.length)!==k){l=k+l}this.value(l);j(h.documentBaseURI.toAbsolute(this.value()),function(p){if(p.width&&p.height&&I){E=p.width;G=p.height;J.find("#width").value(E);J.find("#height").value(G)}})}}function b(k){k.meta=J.toJSON()}M=h.selection.getNode();C=A.getParent(M,"figure.image");if(C){M=A.select("img",C)[0]}if(M&&(M.nodeName!="IMG"||M.getAttribute("data-mce-object")||M.getAttribute("data-mce-placeholder"))){M=null}if(M){E=A.getAttrib(M,"width");G=A.getAttrib(M,"height");a={src:A.getAttrib(M,"src"),alt:A.getAttrib(M,"alt"),title:A.getAttrib(M,"title"),"class":A.getAttrib(M,"class"),width:E,height:G,caption:!!C};h.fire("wpLoadImageData",{imgData:{data:a,node:M}})}if(D){z={type:"listbox",label:"Image list",values:i(D,function(k){k.value=h.convertURL(k.value||k.url,"src")},[{text:"None",value:""}]),value:a.src&&h.convertURL(a.src,"src"),onselect:function(l){var k=J.find("#alt");if(!k.value()||(l.lastControl&&k.value()==l.lastControl.text())){k.value(l.control.text())}J.find("#src").value(l.control.value()).fire("change")},onPostRender:function(){z=this}}}if(h.settings.image_class_list){K={name:"class",type:"listbox",label:"Class",values:i(h.settings.image_class_list,function(k){if(k.value){k.textStyle=function(){return h.formatter.getCssText({inline:"img",classes:[k.value]})}}})}}var d=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:B,onbeforecall:b},z];if(h.settings.image_description!==false){d.push({name:"alt",type:"textbox",label:"Image description"})}if(h.settings.image_title){d.push({name:"title",type:"textbox",label:"Image Title"})}if(I){d.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:N,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:N,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}d.push(K);if(h.settings.image_caption&&tinymce.Env.ceFalse){d.push({name:"caption",type:"checkbox",label:"Caption"})}h.fire("wpLoadImageForm",{data:d});function e(k){if(k.margin){var l=k.margin.split(" ");switch(l.length){case 1:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[0];k["margin-bottom"]=k["margin-bottom"]||l[0];k["margin-left"]=k["margin-left"]||l[0];break;case 2:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[0];k["margin-left"]=k["margin-left"]||l[1];break;case 3:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[2];k["margin-left"]=k["margin-left"]||l[1];break;case 4:k["margin-top"]=k["margin-top"]||l[0];k["margin-right"]=k["margin-right"]||l[1];k["margin-bottom"]=k["margin-bottom"]||l[2];k["margin-left"]=k["margin-left"]||l[3]}delete k.margin}return k}function F(){function m(n){if(n.length>0&&/^[0-9]+$/.test(n)){n+="px"}return n}if(!h.settings.image_advtab){return}var k=J.toJSON(),l=A.parseStyle(k.style);l=e(l);if(k.vspace){l["margin-top"]=l["margin-bottom"]=m(k.vspace)}if(k.hspace){l["margin-left"]=l["margin-right"]=m(k.hspace)}if(k.border){l["border-width"]=m(k.border)}J.find("#style").value(A.serializeStyle(A.parseStyle(A.serializeStyle(l))))}function L(){if(!h.settings.image_advtab){return}var k=J.toJSON(),l=A.parseStyle(k.style);J.find("#vspace").value("");J.find("#hspace").value("");l=e(l);if((l["margin-top"]&&l["margin-bottom"])||(l["margin-right"]&&l["margin-left"])){if(l["margin-top"]===l["margin-bottom"]){J.find("#vspace").value(c(l["margin-top"]))}else{J.find("#vspace").value("")}if(l["margin-right"]===l["margin-left"]){J.find("#hspace").value(c(l["margin-right"]))}else{J.find("#hspace").value("")}}if(l["border-width"]){J.find("#border").value(c(l["border-width"]))}J.find("#style").value(A.serializeStyle(A.parseStyle(A.serializeStyle(l))))}if(h.settings.image_advtab){if(M){if(M.style.marginLeft&&M.style.marginRight&&M.style.marginLeft===M.style.marginRight){a.hspace=c(M.style.marginLeft)}if(M.style.marginTop&&M.style.marginBottom&&M.style.marginTop===M.style.marginBottom){a.vspace=c(M.style.marginTop)}if(M.style.borderWidth){a.border=c(M.style.borderWidth)}a.style=h.dom.serializeStyle(h.dom.parseStyle(h.dom.getAttrib(M,"style")))}J=h.windowManager.open({title:"Insert/edit image",data:a,bodyType:"tabpanel",body:[{title:"General",type:"form",items:d},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:L},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:F},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:H})}else{J=h.windowManager.open({title:"Insert/edit image",data:a,body:d,onSubmit:H})}}h.on("preInit",function(){function a(c){var d=c.attr("class");return d&&/\bimage\b/.test(d)}function b(c){return function(n){var e=n.length,d;function o(k){k.attr("contenteditable",c?"true":null)}while(e--){d=n[e];if(a(d)){d.attr("contenteditable",c?"false":null);tinymce.each(d.getAll("figcaption"),o)}}}}h.parser.addNodeFilter("figure",b(true));h.serializer.addNodeFilter("figure",b(false))});h.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:f(g),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"});h.addMenuItem("image",{icon:"image",text:"Image",onclick:f(g),context:"insert",prependToContext:true});h.addCommand("mceImage",f(g))});
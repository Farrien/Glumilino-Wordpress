wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=(function(e,b,c,d){var a;a={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}};a.init=function(){var f=this;f.preview=d.preview;if(!b.isEmpty(f.selectiveRefreshableWidgets)){f.addPartials()}f.buildWidgetSelectors();f.highlightControls();f.preview.bind("highlight-widget",f.highlightWidget);d.preview.bind("active",function(){f.highlightControls()})};a.WidgetPartial=d.selectiveRefresh.Partial.extend({initialize:function(i,g){var f=this,h;h=i.match(/^widget\[(.+)]$/);if(!h){throw new Error("Illegal id for widget partial.")}f.widgetId=h[1];f.widgetIdParts=a.parseWidgetId(f.widgetId);g=g||{};g.params=b.extend({settings:[a.getWidgetSettingId(f.widgetId)],containerInclusive:true},g.params||{});d.selectiveRefresh.Partial.prototype.initialize.call(f,i,g)},refresh:function(){var f=this,g;if(!a.selectiveRefreshableWidgets[f.widgetIdParts.idBase]){g=e.Deferred();g.reject();f.fallback();return g.promise()}else{return d.selectiveRefresh.Partial.prototype.refresh.call(f)}},renderContent:function(g){var f=this;if(d.selectiveRefresh.Partial.prototype.renderContent.call(f,g)){d.preview.send("widget-updated",f.widgetId);d.selectiveRefresh.trigger("widget-updated",f)}}});a.SidebarPartial=d.selectiveRefresh.Partial.extend({initialize:function(i,g){var f=this,h;h=i.match(/^sidebar\[(.+)]$/);if(!h){throw new Error("Illegal id for sidebar partial.")}f.sidebarId=h[1];g=g||{};g.params=b.extend({settings:["sidebars_widgets["+f.sidebarId+"]"]},g.params||{});d.selectiveRefresh.Partial.prototype.initialize.call(f,i,g);if(!f.params.sidebarArgs){throw new Error("The sidebarArgs param was not provided.")}if(f.params.settings.length>1){throw new Error("Expected SidebarPartial to only have one associated setting")}},ready:function(){var f=this;b.each(f.settings(),function(g){d(g).bind(b.bind(f.handleSettingChange,f))});d.selectiveRefresh.bind("partial-content-rendered",function(h){var g=(h.partial.extended(a.WidgetPartial)&&(-1!==b.indexOf(f.getWidgetIds(),h.partial.widgetId)));if(g){d.selectiveRefresh.trigger("sidebar-updated",f)}});d.bind("change",function(g){var h,i;i=a.parseWidgetSettingId(g.id);if(!i){return}h=i.idBase;if(i.number){h+="-"+String(i.number)}if(-1!==b.indexOf(f.getWidgetIds(),h)){f.ensureWidgetPlacementContainers(h)}})},findDynamicSidebarBoundaryNodes:function(){var f=this,g,h={},i;g=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/;i=function(j){b.each(j,function(k){var l;if(8===k.nodeType){l=k.nodeValue.match(g);if(!l||l[2]!==f.sidebarId){return}if(b.isUndefined(h[l[3]])){h[l[3]]={before:null,after:null,instanceNumber:parseInt(l[3],10)}}if("dynamic_sidebar_before"===l[1]){h[l[3]].before=k}else{h[l[3]].after=k}}else{if(1===k.nodeType){i(k.childNodes)}}})};i(document.body.childNodes);return b.values(h)},placements:function(){var f=this;return b.map(f.findDynamicSidebarBoundaryNodes(),function(g){return new d.selectiveRefresh.Placement({partial:f,container:null,startNode:g.before,endNode:g.after,context:{instanceNumber:g.instanceNumber}})})},getWidgetIds:function(){var g=this,h,f;h=g.settings()[0];if(!h){throw new Error("Missing associated setting.")}if(!d.has(h)){throw new Error("Setting does not exist.")}f=d(h).get();if(!b.isArray(f)){throw new Error("Expected setting to be array of widget IDs")}return f.slice(0)},reflowWidgets:function(){var j=this,g,f,i,h=[];f=j.getWidgetIds();g=j.placements();i={};b.each(f,function(k){var l=d.selectiveRefresh.partial("widget["+k+"]");if(l){i[k]=l}});b.each(g,function(n){var o=[],m=false,l,k=-1;b.each(i,function(p){b.each(p.placements(),function(q){if(n.context.instanceNumber===q.context.sidebar_instance_number){l=q.container.index();o.push({partial:p,placement:q,position:l});if(l<k){m=true}k=l}})});if(m){b.each(o,function(p){n.endNode.parentNode.insertBefore(p.placement.container[0],n.endNode);d.selectiveRefresh.trigger("partial-content-moved",p.placement)});h.push(n)}});if(h.length>0){d.selectiveRefresh.trigger("sidebar-updated",j)}return h},ensureWidgetPlacementContainers:function(g){var i=this,j,h=false,f="widget["+g+"]";j=d.selectiveRefresh.partial(f);if(!j){j=new a.WidgetPartial(f,{params:{}})}b.each(i.placements(),function(m){var l,k;l=b.find(j.placements(),function(n){return(n.context.sidebar_instance_number===m.context.instanceNumber)});if(l){return}k=e(i.params.sidebarArgs.before_widget.replace(/%1\$s/g,g).replace(/%2\$s/g,"widget")+i.params.sidebarArgs.after_widget);if(!k[0]){return}k.attr("data-customize-partial-id",j.id);k.attr("data-customize-partial-type","widget");k.attr("data-customize-widget-id",g);k.data("customize-partial-placement-context",{sidebar_id:i.sidebarId,sidebar_instance_number:m.context.instanceNumber});m.endNode.parentNode.insertBefore(k[0],m.endNode);h=true});d.selectiveRefresh.partial.add(j.id,j);if(h){i.reflowWidgets()}return j},handleSettingChange:function(i,l){var k=this,g,j,f,h=[];g=((l.length>0&&0===i.length)||(i.length>0&&0===l.length));if(g){k.fallback();return}j=b.difference(l,i);b.each(j,function(m){var n=d.selectiveRefresh.partial("widget["+m+"]");if(n){b.each(n.placements(),function(p){var o=(p.context.sidebar_id===k.sidebarId||(p.context.sidebar_args&&p.context.sidebar_args.id===k.sidebarId));if(o){p.container.remove()}})}});f=b.difference(i,l);b.each(f,function(m){var n=k.ensureWidgetPlacementContainers(m);h.push(n)});b.each(h,function(m){m.refresh()});d.selectiveRefresh.trigger("sidebar-updated",k)},refresh:function(){var g=this,f=e.Deferred();f.fail(function(){g.fallback()});if(0===g.placements().length){f.reject()}else{b.each(g.reflowWidgets(),function(h){d.selectiveRefresh.trigger("partial-content-rendered",h)});f.resolve()}return f.promise()}});d.selectiveRefresh.partialConstructor.sidebar=a.SidebarPartial;d.selectiveRefresh.partialConstructor.widget=a.WidgetPartial;a.addPartials=function(){b.each(a.registeredSidebars,function(h){var f,g="sidebar["+h.id+"]";f=d.selectiveRefresh.partial(g);if(!f){f=new a.SidebarPartial(g,{params:{sidebarArgs:h}});d.selectiveRefresh.partial.add(f.id,f)}})};a.buildWidgetSelectors=function(){var f=this;e.each(f.registeredSidebars,function(j,k){var l=[k.before_widget,k.before_title,k.after_title,k.after_widget].join(""),h,g,m;h=e(l);g=h.prop("tagName")||"";m=h.prop("className")||"";if(!m){return}m=m.replace(/\S*%[12]\$s\S*/g,"");m=m.replace(/^\s+|\s+$/g,"");if(m){g+="."+m.split(/\s+/).join(".")}f.widgetSelectors.push(g)})};a.highlightWidget=function(f){var g=e(document.body),h=e("#"+f);g.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget");h.addClass("widget-customizer-highlighted-widget");setTimeout(function(){h.removeClass("widget-customizer-highlighted-widget")},500)};a.highlightControls=function(){var g=this,f=this.widgetSelectors.join(",");if(!d.settings.channel){return}e(f).attr("title",this.l10n.widgetTooltip);e(document).on("mouseenter",f,function(){g.preview.send("highlight-widget-control",e(this).prop("id"))});e(document).on("click",f,function(h){if(!h.shiftKey){return}h.preventDefault();g.preview.send("focus-widget-control",e(this).prop("id"))})};a.parseWidgetId=function(g){var h,f={idBase:"",number:null};h=g.match(/^(.+)-(\d+)$/);if(h){f.idBase=h[1];f.number=parseInt(h[2],10)}else{f.idBase=g}return f};a.parseWidgetSettingId=function(h){var g,f={idBase:"",number:null};g=h.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/);if(!g){return null}f.idBase=g[1];if(g[2]){f.number=parseInt(g[2],10)}return f};a.getWidgetSettingId=function(g){var f=this.parseWidgetId(g),h;h="widget_"+f.idBase;if(f.number){h+="["+String(f.number)+"]"}return h};d.bind("preview-ready",function(){e.extend(a,_wpWidgetCustomizerPreviewSettings);a.init()});return a})(jQuery,_,wp,wp.customize);
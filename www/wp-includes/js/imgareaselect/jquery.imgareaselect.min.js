(function(e){var b=Math.abs,a=Math.max,d=Math.min,c=Math.round;function f(){return e("<div/>")}e.imgAreaSelect=function(S,ag){var O=e(S),v,C=f(),G=f(),au=f().add(f()).add(f()).add(f()),x=f().add(f()).add(f()).add(f()),aC=e([]),an,V,at,aD={left:0,top:0},U,aE,q,Y={left:0,top:0},g=0,ao="absolute",ar,aq,ae,ad,u,r,ap,l,y,aI,al,F,p,E,m,aG={x1:0,y1:0,x2:0,y2:0,width:0,height:0},H=document.documentElement,W=navigator.userAgent,ac,T,Q,P,M,R,K;function ab(h){return h+aD.left-Y.left}function aa(h){return h+aD.top-Y.top}function az(h){return h-aD.left+Y.left}function ay(h){return h-aD.top+Y.top}function B(h){return a(h.pageX||0,j(h).x)-Y.left}function A(h){return a(h.pageY||0,j(h).y)-Y.top}function j(i){var h=i.originalEvent||{};if(h.touches&&h.touches.length){return{x:h.touches[0].pageX,y:h.touches[0].pageY}}else{return{x:0,y:0}}}function ax(h){var o=h||ae,i=h||ad;return{x1:c(aG.x1*o),y1:c(aG.y1*i),x2:c(aG.x2*o),y2:c(aG.y2*i),width:c(aG.x2*o)-c(aG.x1*o),height:c(aG.y2*i)-c(aG.y1*i)}}function av(i,w,h,o,aJ){var aL=aJ||ae,aK=aJ||ad;aG={x1:c(i/aL||0),y1:c(w/aK||0),x2:c(h/aL||0),y2:c(o/aK||0)};aG.width=aG.x2-aG.x1;aG.height=aG.y2-aG.y1}function n(){if(!v||!O.width()){return}aD={left:c(O.offset().left),top:c(O.offset().top)};U=O.innerWidth();aE=O.innerHeight();aD.top+=(O.outerHeight()-aE)>>1;aD.left+=(O.outerWidth()-U)>>1;r=c(ag.minWidth/ae)||0;ap=c(ag.minHeight/ad)||0;l=c(d(ag.maxWidth/ae||1<<24,U));y=c(d(ag.maxHeight/ad||1<<24,aE));if(e().jquery=="1.3.2"&&ao=="fixed"&&!H.getBoundingClientRect){aD.top+=a(document.body.scrollTop,H.scrollTop);aD.left+=a(document.body.scrollLeft,H.scrollLeft)}Y=/absolute|relative/.test(q.css("position"))?{left:c(q.offset().left)-q.scrollLeft(),top:c(q.offset().top)-q.scrollTop()}:ao=="fixed"?{left:e(document).scrollLeft(),top:e(document).scrollTop()}:{left:0,top:0};V=ab(0);at=aa(0);if(aG.x2>U||aG.y2>aE){aF()}}function L(h){if(!al){return}C.css({left:ab(aG.x1),top:aa(aG.y1)}).add(G).width(M=aG.width).height(R=aG.height);G.add(au).add(aC).css({left:0,top:0});au.width(a(M-au.outerWidth()+au.innerWidth(),0)).height(a(R-au.outerHeight()+au.innerHeight(),0));e(x[0]).css({left:V,top:at,width:aG.x1,height:aE});e(x[1]).css({left:V+aG.x1,top:at,width:M,height:aG.y1});e(x[2]).css({left:V+aG.x2,top:at,width:U-aG.x2,height:aE});e(x[3]).css({left:V+aG.x1,top:at+aG.y2,width:M,height:aE-aG.y2});M-=aC.outerWidth();R-=aC.outerHeight();switch(aC.length){case 8:e(aC[4]).css({left:M>>1});e(aC[5]).css({left:M,top:R>>1});e(aC[6]).css({left:M>>1,top:R});e(aC[7]).css({top:R>>1});case 4:aC.slice(1,3).css({left:M});aC.slice(2,4).css({top:R})}if(h!==false){if(e.imgAreaSelect.onKeyPress!=aA){e(document).unbind(e.imgAreaSelect.keyPress,e.imgAreaSelect.onKeyPress)}if(ag.keys){e(document)[e.imgAreaSelect.keyPress](e.imgAreaSelect.onKeyPress=aA)}}if(ak&&au.outerWidth()-au.innerWidth()==2){au.css("margin",0);setTimeout(function(){au.css("margin","auto")},0)}}function z(h){n();L(h);F=ab(aG.x1);p=aa(aG.y1);E=ab(aG.x2);m=aa(aG.y2)}function aj(h,i){ag.fadeSpeed?h.fadeOut(ag.fadeSpeed,i):h.hide()}function J(i){var h=az(B(i))-aG.x1,o=ay(A(i))-aG.y1;if(!K){n();K=true;C.one("mouseout",function(){K=false})}u="";if(ag.resizable){if(o<=ag.resizeMargin){u="n"}else{if(o>=aG.height-ag.resizeMargin){u="s"}}if(h<=ag.resizeMargin){u+="w"}else{if(h>=aG.width-ag.resizeMargin){u+="e"}}}C.css("cursor",u?u+"-resize":ag.movable?"move":"");if(an){an.toggle()}}function k(h){e("body").css("cursor","");if(ag.autoHide||aG.width*aG.height==0){aj(C.add(x),function(){e(this).hide()})}e(document).off("mousemove touchmove",ah);C.on("mousemove touchmove",J);ag.onSelectEnd(S,ax())}function aB(h){if(h.type=="mousedown"&&h.which!=1){return false}J(h);n();if(u){e("body").css("cursor",u+"-resize");F=ab(aG[/w/.test(u)?"x2":"x1"]);p=aa(aG[/n/.test(u)?"y2":"y1"]);e(document).on("mousemove touchmove",ah).one("mouseup touchend",k);C.off("mousemove touchmove",J)}else{if(ag.movable){ar=V+aG.x1-B(h);aq=at+aG.y1-A(h);C.off("mousemove touchmove",J);e(document).on("mousemove touchmove",af).one("mouseup touchend",function(){ag.onSelectEnd(S,ax());e(document).off("mousemove touchmove",af);C.on("mousemove touchmove",J)})}else{O.mousedown(h)}}return false}function N(h){if(aI){if(h){E=a(V,d(V+U,F+b(m-p)*aI*(E>F||-1)));m=c(a(at,d(at+aE,p+b(E-F)/aI*(m>p||-1))));E=c(E)}else{m=a(at,d(at+aE,p+b(E-F)/aI*(m>p||-1)));E=c(a(V,d(V+U,F+b(m-p)*aI*(E>F||-1))));m=c(m)}}}function aF(){F=d(F,V+U);p=d(p,at+aE);if(b(E-F)<r){E=F-r*(E<F||-1);if(E<V){F=V+r}else{if(E>V+U){F=V+U-r}}}if(b(m-p)<ap){m=p-ap*(m<p||-1);if(m<at){p=at+ap}else{if(m>at+aE){p=at+aE-ap}}}E=a(V,d(E,V+U));m=a(at,d(m,at+aE));N(b(E-F)<b(m-p)*aI);if(b(E-F)>l){E=F-l*(E<F||-1);N()}if(b(m-p)>y){m=p-y*(m<p||-1);N(true)}aG={x1:az(d(F,E)),x2:az(a(F,E)),y1:ay(d(p,m)),y2:ay(a(p,m)),width:b(E-F),height:b(m-p)};L();ag.onSelectChange(S,ax())}function ah(h){E=/w|e|^$/.test(u)||aI?B(h):ab(aG.x2);m=/n|s|^$/.test(u)||aI?A(h):aa(aG.y2);aF();return false}function X(h,i){E=(F=h)+aG.width;m=(p=i)+aG.height;e.extend(aG,{x1:az(F),y1:ay(p),x2:az(E),y2:ay(m)});L();ag.onSelectChange(S,ax())}function af(h){F=a(V,d(ar+B(h),V+U-aG.width));p=a(at,d(aq+A(h),at+aE-aG.height));X(F,p);h.preventDefault();return false}function s(){e(document).off("mousemove touchmove",s);n();E=F;m=p;aF();u="";if(!x.is(":visible")){C.add(x).hide().fadeIn(ag.fadeSpeed||0)}al=true;e(document).off("mouseup touchend",Z).on("mousemove touchmove",ah).one("mouseup touchend",k);C.off("mousemove touchmove",J);ag.onSelectStart(S,ax())}function Z(){e(document).off("mousemove touchmove",s).off("mouseup touchend",Z);aj(C.add(x));av(az(F),ay(p),az(F),ay(p));if(!(this instanceof e.imgAreaSelect)){ag.onSelectChange(S,ax());ag.onSelectEnd(S,ax())}}function aH(h){if(h.which!=1||x.is(":animated")){return false}n();ar=F=B(h);aq=p=A(h);e(document).on({"mousemove touchmove":s,"mouseup touchend":Z});return false}function am(){z(false)}function t(){v=true;ai(ag=e.extend({classPrefix:"imgareaselect",movable:true,parent:"body",resizable:true,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},ag));C.add(x).css({visibility:""});if(ag.show){al=true;n();L();C.add(x).hide().fadeIn(ag.fadeSpeed||0)}setTimeout(function(){ag.onInit(S,ax())},0)}var aA=function(w){var h=ag.keys,aJ,o,i=w.keyCode;aJ=!isNaN(h.alt)&&(w.altKey||w.originalEvent.altKey)?h.alt:!isNaN(h.ctrl)&&w.ctrlKey?h.ctrl:!isNaN(h.shift)&&w.shiftKey?h.shift:!isNaN(h.arrows)?h.arrows:10;if(h.arrows=="resize"||(h.shift=="resize"&&w.shiftKey)||(h.ctrl=="resize"&&w.ctrlKey)||(h.alt=="resize"&&(w.altKey||w.originalEvent.altKey))){switch(i){case 37:aJ=-aJ;case 39:o=a(F,E);F=d(F,E);E=a(o+aJ,F);N();break;case 38:aJ=-aJ;case 40:o=a(p,m);p=d(p,m);m=a(o+aJ,p);N(true);break;default:return}aF()}else{F=d(F,E);p=d(p,m);switch(i){case 37:X(a(F-aJ,V),p);break;case 38:X(F,a(p-aJ,at));break;case 39:X(F+d(aJ,U-az(E)),p);break;case 40:X(F,p+d(aJ,aE-ay(m)));break;default:return}}return false};function I(h,o){for(var i in o){if(ag[i]!==undefined){h.css(o[i],ag[i])}}}function ai(h){if(h.parent){(q=e(h.parent)).append(C.add(x))}e.extend(ag,h);n();if(h.handles!=null){aC.remove();aC=e([]);Q=h.handles?h.handles=="corners"?4:8:0;while(Q--){aC=aC.add(f())}aC.addClass(ag.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:g+1||1});if(!parseInt(aC.css("width"))>=0){aC.width(5).height(5)}if(P=ag.borderWidth){aC.css({borderWidth:P,borderStyle:"solid"})}I(aC,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}ae=ag.imageWidth/U||1;ad=ag.imageHeight/aE||1;if(h.x1!=null){av(h.x1,h.y1,h.x2,h.y2);h.show=!h.hide}if(h.keys){ag.keys=e.extend({shift:1,ctrl:"resize"},h.keys)}x.addClass(ag.classPrefix+"-outer");G.addClass(ag.classPrefix+"-selection");for(Q=0;Q++<4;){e(au[Q-1]).addClass(ag.classPrefix+"-border"+Q)}I(G,{selectionColor:"background-color",selectionOpacity:"opacity"});I(au,{borderOpacity:"opacity",borderWidth:"border-width"});I(x,{outerColor:"background-color",outerOpacity:"opacity"});if(P=ag.borderColor1){e(au[0]).css({borderStyle:"solid",borderColor:P})}if(P=ag.borderColor2){e(au[1]).css({borderStyle:"dashed",borderColor:P})}C.append(G.add(au).add(an)).append(aC);if(ak){if(P=(x.css("filter")||"").match(/opacity=(\d+)/)){x.css("opacity",P[1]/100)}if(P=(au.css("filter")||"").match(/opacity=(\d+)/)){au.css("opacity",P[1]/100)}}if(h.hide){aj(C.add(x))}else{if(h.show&&v){al=true;C.add(x).fadeIn(ag.fadeSpeed||0);z()}}aI=(T=(ag.aspectRatio||"").split(/:/))[0]/T[1];O.add(x).unbind("mousedown",aH);if(ag.disable||ag.enable===false){C.off({"mousemove touchmove":J,"mousedown touchstart":aB});e(window).off("resize",am)}else{if(ag.enable||ag.disable===false){if(ag.resizable||ag.movable){C.on({"mousemove touchmove":J,"mousedown touchstart":aB})}e(window).resize(am)}if(!ag.persistent){O.add(x).on("mousedown touchstart",aH)}}ag.enable=ag.disable=undefined}this.remove=function(){ai({disable:true});C.add(x).remove()};this.getOptions=function(){return ag};this.setOptions=ai;this.getSelection=ax;this.setSelection=av;this.cancelSelection=Z;this.update=z;var ak=(/msie ([\w.]+)/i.exec(W)||[])[1],aw=/opera/i.test(W),D=/webkit/i.test(W)&&!/chrome/i.test(W);ac=O;while(ac.length){g=a(g,!isNaN(ac.css("z-index"))?ac.css("z-index"):g);if(ac.css("position")=="fixed"){ao="fixed"}ac=ac.parent(":not(body)")}g=ag.zIndex||g;if(ak){O.attr("unselectable","on")}e.imgAreaSelect.keyPress=ak||D?"keydown":"keypress";if(aw){an=f().css({width:"100%",height:"100%",position:"absolute",zIndex:g+2||2})}C.add(x).css({visibility:"hidden",position:ao,overflow:"hidden",zIndex:g||"0"});C.css({zIndex:g+2||2});G.add(au).css({position:"absolute",fontSize:0});S.complete||S.readyState=="complete"||!O.is("img")?t():O.one("load",t);if(!v&&ak&&ak>=7){S.src=S.src}};e.fn.imgAreaSelect=function(g){g=g||{};this.each(function(){if(e(this).data("imgAreaSelect")){if(g.remove){e(this).data("imgAreaSelect").remove();e(this).removeData("imgAreaSelect")}else{e(this).data("imgAreaSelect").setOptions(g)}}else{if(!g.remove){if(g.enable===undefined&&g.disable===undefined){g.enable=true}e(this).data("imgAreaSelect",new e.imgAreaSelect(this,g))}}});if(g.instance){return e(this).data("imgAreaSelect")}return this}})(jQuery);
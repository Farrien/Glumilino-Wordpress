(function(c,a,d){var b=d.View.extend({initialize:function(e){this.index=0;this.settings={};this.data=e.metadata||c.parseJSON(this.$("script.wp-playlist-script").html());this.playerNode=this.$(this.data.type);this.tracks=new d.Collection(this.data.tracks);this.current=this.tracks.first();if("audio"===this.data.type){this.currentTemplate=wp.template("wp-playlist-current-item");this.currentNode=this.$(".wp-playlist-current-item")}this.renderCurrent();if(this.data.tracklist){this.itemTemplate=wp.template("wp-playlist-item");this.playingClass="wp-playlist-playing";this.renderTracks()}this.playerNode.attr("src",this.current.get("src"));a.bindAll(this,"bindPlayer","bindResetPlayer","setPlayer","ended","clickTrack");if(!a.isUndefined(window._wpmejsSettings)){this.settings=a.clone(_wpmejsSettings)}this.settings.success=this.bindPlayer;this.setPlayer()},bindPlayer:function(e){this.mejs=e;this.mejs.addEventListener("ended",this.ended)},bindResetPlayer:function(e){this.bindPlayer(e);this.playCurrentSrc()},setPlayer:function(e){if(this.player){this.player.pause();this.player.remove();this.playerNode=this.$(this.data.type)}if(e){this.playerNode.attr("src",this.current.get("src"));this.settings.success=this.bindResetPlayer}this.player=new MediaElementPlayer(this.playerNode.get(0),this.settings)},playCurrentSrc:function(){this.renderCurrent();this.mejs.setSrc(this.playerNode.attr("src"));this.mejs.load();this.mejs.play()},renderCurrent:function(){var f,e="wp-includes/images/media/video.png";if("video"===this.data.type){if(this.data.images&&this.current.get("image")&&-1===this.current.get("image").src.indexOf(e)){this.playerNode.attr("poster",this.current.get("image").src)}f=this.current.get("dimensions").resized;this.playerNode.attr(f)}else{if(!this.data.images){this.current.set("image",false)}this.currentNode.html(this.currentTemplate(this.current.toJSON()))}},renderTracks:function(){var f=this,g=1,e=c('<div class="wp-playlist-tracks"></div>');this.tracks.each(function(h){if(!f.data.images){h.set("image",false)}h.set("artists",f.data.artists);h.set("index",f.data.tracknumbers?g:false);e.append(f.itemTemplate(h.toJSON()));g+=1});this.$el.append(e);this.$(".wp-playlist-item").eq(0).addClass(this.playingClass)},events:{"click .wp-playlist-item":"clickTrack","click .wp-playlist-next":"next","click .wp-playlist-prev":"prev"},clickTrack:function(f){f.preventDefault();this.index=this.$(".wp-playlist-item").index(f.currentTarget);this.setCurrent()},ended:function(){if(this.index+1<this.tracks.length){this.next()}else{this.index=0;this.setCurrent()}},next:function(){this.index=this.index+1>=this.tracks.length?0:this.index+1;this.setCurrent()},prev:function(){this.index=this.index-1<0?this.tracks.length-1:this.index-1;this.setCurrent()},loadCurrent:function(){var e=this.playerNode.attr("src")&&this.playerNode.attr("src").split(".").pop(),f=this.current.get("src").split(".").pop();this.mejs&&this.mejs.pause();if(e!==f){this.setPlayer(true)}else{this.playerNode.attr("src",this.current.get("src"));this.playCurrentSrc()}},setCurrent:function(){this.current=this.tracks.at(this.index);if(this.data.tracklist){this.$(".wp-playlist-item").removeClass(this.playingClass).eq(this.index).addClass(this.playingClass)}this.loadCurrent()}});c(document).ready(function(){c(".wp-playlist").each(function(){return new b({el:this})})});window.WPPlaylistView=b}(jQuery,_,Backbone));
(function(h,f,g){var e=g.View.extend({initialize:function(a){this.index=0;this.settings={};this.data=a.metadata||h.parseJSON(this.$("script.wp-playlist-script").html());this.playerNode=this.$(this.data.type);this.tracks=new g.Collection(this.data.tracks);this.current=this.tracks.first();if("audio"===this.data.type){this.currentTemplate=wp.template("wp-playlist-current-item");this.currentNode=this.$(".wp-playlist-current-item")}this.renderCurrent();if(this.data.tracklist){this.itemTemplate=wp.template("wp-playlist-item");this.playingClass="wp-playlist-playing";this.renderTracks()}this.playerNode.attr("src",this.current.get("src"));f.bindAll(this,"bindPlayer","bindResetPlayer","setPlayer","ended","clickTrack");if(!f.isUndefined(window._wpmejsSettings)){this.settings=f.clone(_wpmejsSettings)}this.settings.success=this.bindPlayer;this.setPlayer()},bindPlayer:function(a){this.mejs=a;this.mejs.addEventListener("ended",this.ended)},bindResetPlayer:function(a){this.bindPlayer(a);this.playCurrentSrc()},setPlayer:function(a){if(this.player){this.player.pause();this.player.remove();this.playerNode=this.$(this.data.type)}if(a){this.playerNode.attr("src",this.current.get("src"));this.settings.success=this.bindResetPlayer}this.player=new MediaElementPlayer(this.playerNode.get(0),this.settings)},playCurrentSrc:function(){this.renderCurrent();this.mejs.setSrc(this.playerNode.attr("src"));this.mejs.load();this.mejs.play()},renderCurrent:function(){var a,b="wp-includes/images/media/video.png";if("video"===this.data.type){if(this.data.images&&this.current.get("image")&&-1===this.current.get("image").src.indexOf(b)){this.playerNode.attr("poster",this.current.get("image").src)}a=this.current.get("dimensions").resized;this.playerNode.attr(a)}else{if(!this.data.images){this.current.set("image",false)}this.currentNode.html(this.currentTemplate(this.current.toJSON()))}},renderTracks:function(){var b=this,a=1,c=h('<div class="wp-playlist-tracks"></div>');this.tracks.each(function(d){if(!b.data.images){d.set("image",false)}d.set("artists",b.data.artists);d.set("index",b.data.tracknumbers?a:false);c.append(b.itemTemplate(d.toJSON()));a+=1});this.$el.append(c);this.$(".wp-playlist-item").eq(0).addClass(this.playingClass)},events:{"click .wp-playlist-item":"clickTrack","click .wp-playlist-next":"next","click .wp-playlist-prev":"prev"},clickTrack:function(a){a.preventDefault();this.index=this.$(".wp-playlist-item").index(a.currentTarget);this.setCurrent()},ended:function(){if(this.index+1<this.tracks.length){this.next()}else{this.index=0;this.setCurrent()}},next:function(){this.index=this.index+1>=this.tracks.length?0:this.index+1;this.setCurrent()},prev:function(){this.index=this.index-1<0?this.tracks.length-1:this.index-1;this.setCurrent()},loadCurrent:function(){var b=this.playerNode.attr("src")&&this.playerNode.attr("src").split(".").pop(),a=this.current.get("src").split(".").pop();this.mejs&&this.mejs.pause();if(b!==a){this.setPlayer(true)}else{this.playerNode.attr("src",this.current.get("src"));this.playCurrentSrc()}},setCurrent:function(){this.current=this.tracks.at(this.index);if(this.data.tracklist){this.$(".wp-playlist-item").removeClass(this.playingClass).eq(this.index).addClass(this.playingClass)}this.loadCurrent()}});h(document).ready(function(){h(".wp-playlist").each(function(){return new e({el:this})})});window.WPPlaylistView=e}(jQuery,_,Backbone));
window.wp=window.wp||{};(function(b){wp.Backbone={};wp.Backbone.Subviews=function(d,a){this.view=d;this._views=_.isArray(a)?{"":a}:a||{}};wp.Backbone.Subviews.extend=Backbone.Model.extend;_.extend(wp.Backbone.Subviews.prototype,{all:function(){return _.flatten(_.values(this._views))},get:function(a){a=a||"";return this._views[a]},first:function(a){var d=this.get(a);return d&&d.length?d[0]:null},set:function(a,j,i){var g,h;if(!_.isString(a)){i=j;j=a;a=""}i=i||{};j=_.isArray(j)?j:[j];g=this.get(a);h=j;if(g){if(i.add){if(_.isUndefined(i.at)){h=g.concat(j)}else{h=g;h.splice.apply(h,[i.at,0].concat(j))}}else{_.each(h,function(c){c.__detach=true});_.each(g,function(c){if(c.__detach){c.$el.detach()}else{c.remove()}});_.each(h,function(c){delete c.__detach})}}this._views[a]=h;_.each(j,function(c){var e=c.Views||wp.Backbone.Subviews,d=c.views=c.views||new e(c);d.parent=this.view;d.selector=a},this);if(!i.silent){this._attach(a,j,_.extend({ready:this._isReady()},i))}return this},add:function(a,f,e){if(!_.isString(a)){e=f;f=a;a=""}return this.set(a,f,_.extend({add:true},e))},unset:function(a,h,g){var f;if(!_.isString(a)){g=h;h=a;a=""}h=h||[];if(f=this.get(a)){h=_.isArray(h)?h:[h];this._views[a]=h.length?_.difference(f,h):[]}if(!g||!g.silent){_.invoke(h,"remove")}return this},detach:function(){b(_.pluck(this.all(),"el")).detach();return this},render:function(){var a={ready:this._isReady()};_.each(this._views,function(e,f){this._attach(f,e,a)},this);this.rendered=true;return this},remove:function(a){if(!a||!a.silent){if(this.parent&&this.parent.views){this.parent.views.unset(this.selector,this.view,{silent:true})}delete this.parent;delete this.selector}_.invoke(this.all(),"remove");this._views=[];return this},replace:function(a,d){a.html(d);return this},insert:function(j,g,h){var a=h&&h.at,i;if(_.isNumber(a)&&(i=j.children()).length>a){i.eq(a).before(g)}else{j.append(g)}return this},ready:function(){this.view.trigger("ready");_.chain(this.all()).map(function(a){return a.views}).flatten().where({attached:true}).invoke("ready")},_attach:function(a,j,i){var g=a?this.view.$(a):this.view.$el,h;if(!g.length){return this}h=_.chain(j).pluck("views").flatten().value();_.each(h,function(c){if(c.rendered){return}c.view.render();c.rendered=true},this);this[i.add?"insert":"replace"](g,_.pluck(j,"el"),i);_.each(h,function(c){c.attached=true;if(i.ready){c.ready()}},this);return this},_isReady:function(){var a=this.view.el;while(a){if(a===document.body){return true}a=a.parentNode}return false}});wp.Backbone.View=Backbone.View.extend({Subviews:wp.Backbone.Subviews,constructor:function(a){this.views=new this.Subviews(this,this.views);this.on("ready",this.ready,this);this.options=a||{};Backbone.View.apply(this,arguments)},remove:function(){var a=Backbone.View.prototype.remove.apply(this,arguments);if(this.views){this.views.remove()}return a},render:function(){var a;if(this.prepare){a=this.prepare()}this.views.detach();if(this.template){a=a||{};this.trigger("prepare",a);this.$el.html(this.template(a))}this.views.render();return this},prepare:function(){return this.options},ready:function(){}})}(jQuery));
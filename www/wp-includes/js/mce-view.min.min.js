(function(k,g,l,j){var h={},i={};g.mce=g.mce||{};g.mce.views={register:function(b,a){h[b]=g.mce.View.extend(_.extend(a,{type:b}))},unregister:function(a){delete h[a]},get:function(a){return h[a]},unbind:function(){_.each(i,function(a){a.unbind()})},setMarkers:function(b){var c=[{content:b}],d=this,e,a;_.each(h,function(n,f){a=c.slice();c=[];_.each(a,function(r){var s=r.content,t,m;if(r.processed){c.push(r);return}while(s&&(t=n.prototype.match(s))){if(t.index){c.push({content:s.substring(0,t.index)})}e=d.createInstance(f,t.content,t.options);m=e.loader?".":e.text;c.push({content:e.ignore?m:'<p data-wpview-marker="'+e.encodedText+'">'+m+"</p>",processed:true});s=s.slice(t.index+t.content.length)}if(s){c.push({content:s})}})});b=_.pluck(c,"content").join("");return b.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(d,a,f,c){var b=this.get(d),e,n;a=tinymce.DOM.decode(a);if(a.indexOf("[")!==-1&&a.indexOf("]")!==-1){a=a.replace(/\[[^\]]+\]/g,function(m){return m.replace(/[\r\n]/g,"")})}if(!c){n=this.getInstance(a);if(n){return n}}e=encodeURIComponent(a);f=_.extend(f||{},{text:a,encodedText:e});return i[e]=new b(f)},getInstance:function(a){if(typeof a==="string"){return i[encodeURIComponent(a)]}return i[j(a).attr("data-wpview-text")]},getText:function(a){return decodeURIComponent(j(a).attr("data-wpview-text")||"")},render:function(a){_.each(i,function(b){b.render(null,a)})},update:function(a,d,c,b){var e=this.getInstance(c);if(e){e.update(a,d,c,b)}},edit:function(b,a){var c=this.getInstance(a);if(c&&c.edit){c.edit(c.text,function(d,e){c.update(d,b,a,e)})}},remove:function(b,a){var c=this.getInstance(a);if(c){c.remove(b,a)}}};g.mce.View=function(a){_.extend(this,a);this.initialize()};g.mce.View.extend=Backbone.View.extend;_.extend(g.mce.View.prototype,{content:null,loader:true,initialize:function(){},getContent:function(){return this.content},render:function(b,a){if(b!=null){this.content=b}b=this.getContent();if(!this.loader&&!b){return}a&&this.unbind();this.replaceMarkers();if(b){this.setContent(b,function(d,c){j(c).data("rendered",true);this.bindNode.call(this,d,c)},a?null:false)}else{this.setLoader()}},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(b,a){this.unbindNode.call(this,b,a)},true)},getEditors:function(a){_.each(tinymce.editors,function(b){if(b.plugins.wpview){a.call(this,b)}},this)},getNodes:function(a,b){this.getEditors(function(c){var d=this;j(c.getBody()).find('[data-wpview-text="'+d.encodedText+'"]').filter(function(){var e;if(b==null){return true}e=j(this).data("rendered")===true;return b?e:!e}).each(function(){a.call(d,c,this,this)})})},getMarkers:function(a){this.getEditors(function(b){var c=this;j(b.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){a.call(c,b,this)})})},replaceMarkers:function(){this.getMarkers(function(c,b){var a;if(!this.loader&&j(b).text()!==this.text){c.dom.setAttrib(b,"data-wpview-marker",null);return}a=c.$('<div class="wpview wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'" contenteditable="false"></div>');c.$(b).replaceWith(a)})},removeMarkers:function(){this.getMarkers(function(b,a){b.dom.setAttrib(a,"data-wpview-marker",null)})},setContent:function(c,a,b){if(_.isObject(c)&&c.body.indexOf("<script")!==-1){this.setIframes(c.head||"",c.body,a,b)}else{if(_.isString(c)&&c.indexOf("<script")!==-1){this.setIframes("",c,a,b)}else{this.getNodes(function(e,d){c=c.body||c;if(c.indexOf("<iframe")!==-1){c+='<span class="mce-shim"></span>'}e.undoManager.transact(function(){d.innerHTML="";d.appendChild(_.isString(c)?e.dom.createFragment(c):c);e.dom.add(d,"span",{"class":"wpview-end"})});a&&a.call(this,e,d)},b)}}},setIframes:function(c,e,a,b){var d=this;this.getNodes(function(J,B){var f=J.dom,G="",K=J.getBody().className||"",E=J.getDoc().getElementsByTagName("head")[0],M,N,H,C,I,L,A;tinymce.each(f.$('link[rel="stylesheet"]',E),function(m){if(m.href&&m.href.indexOf("skins/lightgray/content.min.css")===-1&&m.href.indexOf("skins/wordpress/wp-content.css")===-1){G+=f.getOuterHTML(m)}});if(d.iframeHeight){f.add(B,"span",{"data-mce-bogus":1,style:{display:"block",width:"100%",height:d.iframeHeight}},"\u200B")}J.undoManager.transact(function(){B.innerHTML="";M=f.add(B,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"},height:d.iframeHeight});f.add(B,"span",{"class":"mce-shim"});f.add(B,"span",{"class":"wpview-end"})});if(!M.contentWindow){return}N=M.contentWindow;H=N.document;H.open();H.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+c+G+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+K+'">'+e+"</body></html>");H.close();function D(){var m;if(A){return}if(M.contentWindow){m=j(M);d.iframeHeight=j(H.body).height();if(m.height()!==d.iframeHeight){m.height(d.iframeHeight);J.nodeChanged()}}}if(d.iframeHeight){A=true;setTimeout(function(){A=false;D()},3000)}function F(){j(B).data("rendered",null);setTimeout(function(){g.mce.views.render()})}j(N).on("load",D).on("unload",F);C=N.MutationObserver||N.WebKitMutationObserver||N.MozMutationObserver;if(C){I=new C(_.debounce(D,100));I.observe(H.body,{attributes:true,childList:true,subtree:true})}else{for(L=1;L<6;L++){setTimeout(D,L*700)}}a&&a.call(d,J,B)},b)},setLoader:function(a){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-'+(a||"admin-media")+'"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(a,b){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(b||"no")+'"></div><p>'+a+"</p></div>")},match:function(a){var b=l.next(this.type,a);if(b){return{index:b.index,content:b.content,options:{shortcode:b.shortcode}}}},update:function(a,d,c,b){_.find(h,function(n,e){var f=n.prototype.match(a);if(f){j(c).data("rendered",false);d.dom.setAttrib(c,"data-wpview-text",encodeURIComponent(a));g.mce.views.createInstance(e,a,f.options,b).render();d.selection.select(c);d.nodeChanged();d.focus();return true}})},remove:function(b,a){this.unbindNode.call(this,b,a);b.dom.remove(a);b.focus()}})})(window,window.wp,window.wp.shortcode,window.jQuery);(function(q,n,u,s){var v,m,w,r,t,x,p;function o(a){var b={};if(!q.tinymce){return a.replace(/<[^>]+>/g,"")}if(!a||(a.indexOf("<")===-1&&a.indexOf(">")===-1)){return a}t=t||new q.tinymce.html.Schema(b);x=x||new q.tinymce.html.DomParser(b,t);p=p||new q.tinymce.html.Serializer(b,t);return p.serialize(x.parse(a,{forced_root_block:false}))}v={state:[],edit:function(c,b){var a=this.type,d=u[a].edit(c);this.pausePlayers&&this.pausePlayers();_.each(this.state,function(e){d.state(e).on("update",function(f){b(u[a].shortcode(f).string(),a==="gallery")})});d.on("close",function(){d.detach()});d.open()}};m=_.extend({},v,{state:["gallery-edit"],template:u.template("editor-gallery"),initialize:function(){var a=u.gallery.attachments(this.shortcode,u.view.settings.post.id),b=this.shortcode.attrs.named,c=this;a.more().done(function(){a=a.toJSON();_.each(a,function(d){if(d.sizes){if(b.size&&d.sizes[b.size]){d.thumbnail=d.sizes[b.size]}else{if(d.sizes.thumbnail){d.thumbnail=d.sizes.thumbnail}else{if(d.sizes.full){d.thumbnail=d.sizes.full}}}}});c.render(c.template({verifyHTML:o,attachments:a,columns:b.columns?parseInt(b.columns,10):u.galleryDefaults.columns}))}).fail(function(e,d){c.setError(d)})}});w=_.extend({},v,{action:"parse-media-shortcode",initialize:function(){var a=this;if(this.url){this.loader=false;this.shortcode=u.embed.shortcode({url:this.text})}wp.ajax.post(this.action,{post_ID:u.view.settings.post.id,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(b){a.render(b)}).fail(function(b){if(a.url){a.ignore=true;a.removeMarkers()}else{a.setError(b.message||b.statusText,"admin-media")}});this.getEditors(function(b){b.on("wpview-selected",function(){a.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(a,c,d){var b=s("iframe.wpview-sandbox",d).get(0);if(b&&(b=b.contentWindow)&&b.mejs){_.each(b.mejs.players,function(f){try{f.pause()}catch(e){}})}})}});r=_.extend({},w,{action:"parse-embed",edit:function(c,b){var d=u.embed.edit(c,this.url),a=this;this.pausePlayers();d.state("embed").props.on("change:url",function(e,f){if(f&&e.get("url")){d.state("embed").metadata=e.toJSON()}});d.state("embed").on("select",function(){var e=d.state("embed").metadata;if(a.url){b(e.url)}else{b(u.embed.shortcode(e).string())}});d.on("close",function(){d.detach()});d.open()}});n.register("gallery",_.extend({},m));n.register("audio",_.extend({},w,{state:["audio-details"]}));n.register("video",_.extend({},w,{state:["video-details"]}));n.register("playlist",_.extend({},w,{state:["playlist-edit","video-playlist-edit"]}));n.register("embed",_.extend({},r));n.register("embedURL",_.extend({},r,{match:function(b){var c=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi,a=c.exec(b);if(a){return{index:a.index+a[1].length,content:a[2],options:{url:true}}}}}))})(window,window.wp.mce.views,window.wp.media,window.jQuery);
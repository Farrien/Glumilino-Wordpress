wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=(function(h,f,j,i){var g;g={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}};g.init=function(){var a=this;a.preview=i.preview;if(!f.isEmpty(a.selectiveRefreshableWidgets)){a.addPartials()}a.buildWidgetSelectors();a.highlightControls();a.preview.bind("highlight-widget",a.highlightWidget);i.preview.bind("active",function(){a.highlightControls()})};g.WidgetPartial=i.selectiveRefresh.Partial.extend({initialize:function(a,c){var d=this,b;b=a.match(/^widget\[(.+)]$/);if(!b){throw new Error("Illegal id for widget partial.")}d.widgetId=b[1];d.widgetIdParts=g.parseWidgetId(d.widgetId);c=c||{};c.params=f.extend({settings:[g.getWidgetSettingId(d.widgetId)],containerInclusive:true},c.params||{});i.selectiveRefresh.Partial.prototype.initialize.call(d,a,c)},refresh:function(){var b=this,a;if(!g.selectiveRefreshableWidgets[b.widgetIdParts.idBase]){a=h.Deferred();a.reject();b.fallback();return a.promise()}else{return i.selectiveRefresh.Partial.prototype.refresh.call(b)}},renderContent:function(a){var b=this;if(i.selectiveRefresh.Partial.prototype.renderContent.call(b,a)){i.preview.send("widget-updated",b.widgetId);i.selectiveRefresh.trigger("widget-updated",b)}}});g.SidebarPartial=i.selectiveRefresh.Partial.extend({initialize:function(a,c){var d=this,b;b=a.match(/^sidebar\[(.+)]$/);if(!b){throw new Error("Illegal id for sidebar partial.")}d.sidebarId=b[1];c=c||{};c.params=f.extend({settings:["sidebars_widgets["+d.sidebarId+"]"]},c.params||{});i.selectiveRefresh.Partial.prototype.initialize.call(d,a,c);if(!d.params.sidebarArgs){throw new Error("The sidebarArgs param was not provided.")}if(d.params.settings.length>1){throw new Error("Expected SidebarPartial to only have one associated setting")}},ready:function(){var a=this;f.each(a.settings(),function(b){i(b).bind(f.bind(a.handleSettingChange,a))});i.selectiveRefresh.bind("partial-content-rendered",function(b){var c=(b.partial.extended(g.WidgetPartial)&&(-1!==f.indexOf(a.getWidgetIds(),b.partial.widgetId)));if(c){i.selectiveRefresh.trigger("sidebar-updated",a)}});i.bind("change",function(d){var c,b;b=g.parseWidgetSettingId(d.id);if(!b){return}c=b.idBase;if(b.number){c+="-"+String(b.number)}if(-1!==f.indexOf(a.getWidgetIds(),c)){a.ensureWidgetPlacementContainers(c)}})},findDynamicSidebarBoundaryNodes:function(){var d=this,c,b={},a;c=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/;a=function(e){f.each(e,function(n){var m;if(8===n.nodeType){m=n.nodeValue.match(c);if(!m||m[2]!==d.sidebarId){return}if(f.isUndefined(b[m[3]])){b[m[3]]={before:null,after:null,instanceNumber:parseInt(m[3],10)}}if("dynamic_sidebar_before"===m[1]){b[m[3]].before=n}else{b[m[3]].after=n}}else{if(1===n.nodeType){a(n.childNodes)}}})};a(document.body.childNodes);return f.values(b)},placements:function(){var a=this;return f.map(a.findDynamicSidebarBoundaryNodes(),function(b){return new i.selectiveRefresh.Placement({partial:a,container:null,startNode:b.before,endNode:b.after,context:{instanceNumber:b.instanceNumber}})})},getWidgetIds:function(){var b=this,a,c;a=b.settings()[0];if(!a){throw new Error("Missing associated setting.")}if(!i.has(a)){throw new Error("Setting does not exist.")}c=i(a).get();if(!f.isArray(c)){throw new Error("Expected setting to be array of widget IDs")}return c.slice(0)},reflowWidgets:function(){var a=this,d,e,b,c=[];e=a.getWidgetIds();d=a.placements();b={};f.each(e,function(n){var m=i.selectiveRefresh.partial("widget["+n+"]");if(m){b[n]=m}});f.each(d,function(t){var s=[],p=false,q,r=-1;f.each(b,function(k){f.each(k.placements(),function(l){if(t.context.instanceNumber===l.context.sidebar_instance_number){q=l.container.index();s.push({partial:k,placement:l,position:q});if(q<r){p=true}r=q}})});if(p){f.each(s,function(k){t.endNode.parentNode.insertBefore(k.placement.container[0],t.endNode);i.selectiveRefresh.trigger("partial-content-moved",k.placement)});c.push(t)}});if(c.length>0){i.selectiveRefresh.trigger("sidebar-updated",a)}return c},ensureWidgetPlacementContainers:function(d){var b=this,a,c=false,e="widget["+d+"]";a=i.selectiveRefresh.partial(e);if(!a){a=new g.WidgetPartial(e,{params:{}})}f.each(b.placements(),function(n){var o,p;o=f.find(a.placements(),function(k){return(k.context.sidebar_instance_number===n.context.instanceNumber)});if(o){return}p=h(b.params.sidebarArgs.before_widget.replace(/%1\$s/g,d).replace(/%2\$s/g,"widget")+b.params.sidebarArgs.after_widget);if(!p[0]){return}p.attr("data-customize-partial-id",a.id);p.attr("data-customize-partial-type","widget");p.attr("data-customize-widget-id",d);p.data("customize-partial-placement-context",{sidebar_id:b.sidebarId,sidebar_instance_number:n.context.instanceNumber});n.endNode.parentNode.insertBefore(p[0],n.endNode);c=true});i.selectiveRefresh.partial.add(a.id,a);if(c){b.reflowWidgets()}return a},handleSettingChange:function(d,a){var b=this,m,c,n,e=[];m=((a.length>0&&0===d.length)||(d.length>0&&0===a.length));if(m){b.fallback();return}c=f.difference(a,d);f.each(c,function(k){var l=i.selectiveRefresh.partial("widget["+k+"]");if(l){f.each(l.placements(),function(q){var r=(q.context.sidebar_id===b.sidebarId||(q.context.sidebar_args&&q.context.sidebar_args.id===b.sidebarId));if(r){q.container.remove()}})}});n=f.difference(d,a);f.each(n,function(k){var l=b.ensureWidgetPlacementContainers(k);e.push(l)});f.each(e,function(k){k.refresh()});i.selectiveRefresh.trigger("sidebar-updated",b)},refresh:function(){var a=this,b=h.Deferred();b.fail(function(){a.fallback()});if(0===a.placements().length){b.reject()}else{f.each(a.reflowWidgets(),function(c){i.selectiveRefresh.trigger("partial-content-rendered",c)});b.resolve()}return b.promise()}});i.selectiveRefresh.partialConstructor.sidebar=g.SidebarPartial;i.selectiveRefresh.partialConstructor.widget=g.WidgetPartial;g.addPartials=function(){f.each(g.registeredSidebars,function(a){var c,b="sidebar["+a.id+"]";c=i.selectiveRefresh.partial(b);if(!c){c=new g.SidebarPartial(b,{params:{sidebarArgs:a}});i.selectiveRefresh.partial.add(c.id,c)}})};g.buildWidgetSelectors=function(){var a=this;h.each(a.registeredSidebars,function(e,d){var c=[d.before_widget,d.before_title,d.after_title,d.after_widget].join(""),n,o,b;n=h(c);o=n.prop("tagName")||"";b=n.prop("className")||"";if(!b){return}b=b.replace(/\S*%[12]\$s\S*/g,"");b=b.replace(/^\s+|\s+$/g,"");if(b){o+="."+b.split(/\s+/).join(".")}a.widgetSelectors.push(o)})};g.highlightWidget=function(c){var b=h(document.body),a=h("#"+c);b.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget");a.addClass("widget-customizer-highlighted-widget");setTimeout(function(){a.removeClass("widget-customizer-highlighted-widget")},500)};g.highlightControls=function(){var a=this,b=this.widgetSelectors.join(",");if(!i.settings.channel){return}h(b).attr("title",this.l10n.widgetTooltip);h(document).on("mouseenter",b,function(){a.preview.send("highlight-widget-control",h(this).prop("id"))});h(document).on("click",b,function(c){if(!c.shiftKey){return}c.preventDefault();a.preview.send("focus-widget-control",h(this).prop("id"))})};g.parseWidgetId=function(b){var a,c={idBase:"",number:null};a=b.match(/^(.+)-(\d+)$/);if(a){c.idBase=a[1];c.number=parseInt(a[2],10)}else{c.idBase=b}return c};g.parseWidgetSettingId=function(a){var b,c={idBase:"",number:null};b=a.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/);if(!b){return null}c.idBase=b[1];if(b[2]){c.number=parseInt(b[2],10)}return c};g.getWidgetSettingId=function(b){var c=this.parseWidgetId(b),a;a="widget_"+c.idBase;if(c.number){a+="["+String(c.number)+"]"}return a};i.bind("preview-ready",function(){h.extend(g,_wpWidgetCustomizerPreviewSettings);g.init()});return g})(jQuery,_,wp,wp.customize);
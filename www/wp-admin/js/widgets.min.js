var wpWidgets;(function(a){var b=a(document);wpWidgets={hoveredSidebar:null,init:function(){var i,d,c=this,g=a(".widgets-chooser"),h=g.find(".widgets-chooser-sidebars"),f=a("div.widgets-sortables"),e=!!("undefined"!==typeof isRtl&&isRtl);a("#widgets-right .sidebar-name").click(function(){var k=a(this),j=k.closest(".widgets-holder-wrap");if(j.hasClass("closed")){j.removeClass("closed");k.parent().sortable("refresh")}else{j.addClass("closed")}b.triggerHandler("wp-pin-menu")});a("#widgets-left .sidebar-name").click(function(){a(this).closest(".widgets-holder-wrap").toggleClass("closed");b.triggerHandler("wp-pin-menu")});a(document.body).bind("click.widgets-toggle",function(q){var p=a(q.target),l={"z-index":100},o,j,k,n,m;if(p.parents(".widget-top").length&&!p.parents("#available-widgets").length){o=p.closest("div.widget");j=o.children(".widget-inside");k=parseInt(o.find("input.widget-width").val(),10),n=o.parent().width();if(j.is(":hidden")){if(k>250&&(k+30>n)&&o.closest("div.widgets-sortables").length){if(o.closest("div.widget-liquid-right").length){m=e?"margin-right":"margin-left"}else{m=e?"margin-left":"margin-right"}l[m]=n-(k+30)+"px";o.css(l)}o.addClass("open");j.slideDown("fast")}else{j.slideUp("fast",function(){o.attr("style","");o.removeClass("open")})}q.preventDefault()}else{if(p.hasClass("widget-control-save")){wpWidgets.save(p.closest("div.widget"),0,1,0);q.preventDefault()}else{if(p.hasClass("widget-control-remove")){wpWidgets.save(p.closest("div.widget"),1,1,0);q.preventDefault()}else{if(p.hasClass("widget-control-close")){o=p.closest("div.widget");o.removeClass("open");wpWidgets.close(o);q.preventDefault()}else{if(p.attr("id")==="inactive-widgets-control-remove"){wpWidgets.removeInactiveWidgets();q.preventDefault()}}}}}});f.children(".widget").each(function(){var j=a(this);wpWidgets.appendTitle(this);if(j.find("p.widget-error").length){j.find("a.widget-action").trigger("click")}});a("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:true,start:function(k,l){var j=a(this).find(".widgets-chooser");l.helper.find("div.widget-description").hide();d=this.id;if(j.length){a("#wpbody-content").append(j.hide());l.helper.find(".widgets-chooser").remove();c.clearWidgetSelection()}},stop:function(){if(i){a(i).hide()}i=""}});f.droppable({tolerance:"intersect",over:function(k){var j=a(k.target).parent();if(wpWidgets.hoveredSidebar&&!j.is(wpWidgets.hoveredSidebar)){wpWidgets.closeSidebar(k)}if(j.hasClass("closed")){wpWidgets.hoveredSidebar=j;j.removeClass("closed")}a(this).sortable("refresh")},out:function(j){if(wpWidgets.hoveredSidebar){wpWidgets.closeSidebar(j)}}});f.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:true,start:function(m,n){var k,o=a(this),l=o.parent(),j=n.item.children(".widget-inside");if(j.css("display")==="block"){n.item.removeClass("open");j.hide();a(this).sortable("refreshPositions")}if(!l.hasClass("closed")){k=n.item.hasClass("ui-draggable")?o.height():1+o.height();o.css("min-height",k+"px")}},stop:function(k,o){var n,r,p,q,m,s,j=o.item,l=d;wpWidgets.hoveredSidebar=null;if(j.hasClass("deleting")){wpWidgets.save(j,1,0,1);j.remove();return}n=j.find("input.add_new").val();r=j.find("input.multi_number").val();j.attr("style","").removeClass("ui-draggable");d="";if(n){if("multi"===n){j.html(j.html().replace(/<[^<>]+>/g,function(t){return t.replace(/__i__|%i%/g,r)}));j.attr("id",l.replace("__i__",r));r++;a("div#"+l).find("input.multi_number").val(r)}else{if("single"===n){j.attr("id","new-"+l);i="div#"+l}}wpWidgets.save(j,0,0,1);j.find("input.add_new").val("");b.trigger("widget-added",[j])}p=j.parent();if(p.parent().hasClass("closed")){p.parent().removeClass("closed");q=p.children(".widget");if(q.length>1){m=q.get(0);s=j.get(0);if(m.id&&s.id&&m.id!==s.id){a(m).before(j)}}}if(n){j.find("a.widget-action").trigger("click")}else{wpWidgets.saveOrder(p.attr("id"))}},activate:function(){a(this).parent().addClass("widget-hover")},deactivate:function(){a(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(j,l){var k=a(l.sender);if(this.id.indexOf("orphaned_widgets")>-1){k.sortable("cancel");return}if(k.attr("id").indexOf("orphaned_widgets")>-1&&!k.children(".widget").length){k.parents(".orphan-sidebar").slideUp(400,function(){a(this).remove()})}}}).sortable("option","connectWith","div.widgets-sortables");a("#available-widgets").droppable({tolerance:"pointer",accept:function(j){return a(j).parent().attr("id")!=="widget-list"},drop:function(k,j){j.draggable.addClass("deleting");a("#removing-widget").hide().children("span").empty()},over:function(k,j){j.draggable.addClass("deleting");a("div.widget-placeholder").hide();if(j.draggable.hasClass("ui-sortable-helper")){a("#removing-widget").show().children("span").html(j.draggable.find("div.widget-title").children("h3").html())}},out:function(k,j){j.draggable.removeClass("deleting");a("div.widget-placeholder").show();a("#removing-widget").hide().children("span").empty()}});a("#widgets-right .widgets-holder-wrap").each(function(m,n){var k=a(n),l=k.find(".sidebar-name h2").text(),o=k.find(".widgets-sortables").attr("id"),j=a('<li tabindex="0">').text(a.trim(l));if(m===0){j.addClass("widgets-chooser-selected")}h.append(j);j.data("sidebarId",o)});a("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var j=a(this).closest(".widget");if(j.hasClass("widget-in-question")||a("#widgets-left").hasClass("chooser")){c.closeChooser()}else{c.clearWidgetSelection();a("#widgets-left").addClass("chooser");j.addClass("widget-in-question").children(".widget-description").after(g);g.slideDown(300,function(){h.find(".widgets-chooser-selected").focus()});h.find("li").on("focusin.widgets-chooser",function(){h.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected");a(this).addClass("widgets-chooser-selected")})}});g.on("click.widgets-chooser",function(k){var j=a(k.target);if(j.hasClass("button-primary")){c.addWidget(g);c.closeChooser()}else{if(j.hasClass("widgets-chooser-cancel")){c.closeChooser()}}}).on("keyup.widgets-chooser",function(j){if(j.which===a.ui.keyCode.ENTER){if(a(j.target).hasClass("widgets-chooser-cancel")){c.closeChooser()}else{c.addWidget(g);c.closeChooser()}}else{if(j.which===a.ui.keyCode.ESCAPE){c.closeChooser()}}})},saveOrder:function(d){var c={action:"widgets-order",savewidgets:a("#_wpnonce_widgets").val(),sidebars:[]};if(d){a("#"+d).find(".spinner:first").addClass("is-active")}a("div.widgets-sortables").each(function(){if(a(this).sortable){c["sidebars["+a(this).attr("id")+"]"]=a(this).sortable("toArray").join(",")}});a.post(ajaxurl,c,function(){a("#inactive-widgets-control-remove").prop("disabled",!a("#wp_inactive_widgets .widget").length);a(".spinner").removeClass("is-active")})},save:function(i,e,f,c){var h=i.closest("div.widgets-sortables").attr("id"),g=i.find("form").serialize(),d;i=a(i);a(".spinner",i).addClass("is-active");d={action:"save-widget",savewidgets:a("#_wpnonce_widgets").val(),sidebar:h};if(e){d.delete_widget=1}g+="&"+a.param(d);a.post(ajaxurl,g,function(j){var k;if(e){if(!a("input.widget_number",i).val()){k=a("input.widget-id",i).val();a("#available-widgets").find("input.widget-id").each(function(){if(a(this).val()===k){a(this).closest("div.widget").show()}})}if(f){c=0;i.slideUp("fast",function(){a(this).remove();wpWidgets.saveOrder()})}else{i.remove();if(h==="wp_inactive_widgets"){a("#inactive-widgets-control-remove").prop("disabled",!a("#wp_inactive_widgets .widget").length)}}}else{a(".spinner").removeClass("is-active");if(j&&j.length>2){a("div.widget-content",i).html(j);wpWidgets.appendTitle(i);b.trigger("widget-updated",[i]);if(h==="wp_inactive_widgets"){a("#inactive-widgets-control-remove").prop("disabled",!a("#wp_inactive_widgets .widget").length)}}}if(c){wpWidgets.saveOrder()}})},removeInactiveWidgets:function(){var d=a(".remove-inactive-widgets"),c,e;a(".spinner",d).addClass("is-active");c={action:"delete-inactive-widgets",removeinactivewidgets:a("#_wpnonce_remove_inactive_widgets").val()};e=a.param(c);a.post(ajaxurl,e,function(){a("#wp_inactive_widgets .widget").remove();a("#inactive-widgets-control-remove").prop("disabled",true);a(".spinner",d).removeClass("is-active")})},appendTitle:function(c){var d=a('input[id*="-title"]',c).val()||"";if(d){d=": "+d.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}a(c).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(d)},close:function(c){c.children(".widget-inside").slideUp("fast",function(){c.attr("style","")})},addWidget:function(l){var h,i,k,f,e,j,d,g=l.find(".widgets-chooser-selected").data("sidebarId"),c=a("#"+g);h=a("#available-widgets").find(".widget-in-question").clone();i=h.attr("id");k=h.find("input.add_new").val();f=h.find("input.multi_number").val();h.find(".widgets-chooser").remove();if("multi"===k){h.html(h.html().replace(/<[^<>]+>/g,function(n){return n.replace(/__i__|%i%/g,f)}));h.attr("id",i.replace("__i__",f));f++;a("#"+i).find("input.multi_number").val(f)}else{if("single"===k){h.attr("id","new-"+i);a("#"+i).hide()}}c.closest(".widgets-holder-wrap").removeClass("closed");c.append(h);c.sortable("refresh");wpWidgets.save(h,0,0,1);h.find("input.add_new").val("");b.trigger("widget-added",[h]);e=a(window).scrollTop();j=e+a(window).height();d=c.offset();d.bottom=d.top+c.outerHeight();if(e>d.bottom||j<d.top){a("html, body").animate({scrollTop:d.top-130},200)}window.setTimeout(function(){h.find(".widget-title").trigger("click")},250)},closeChooser:function(){var c=this;a(".widgets-chooser").slideUp(200,function(){a("#wpbody-content").append(this);c.clearWidgetSelection()})},clearWidgetSelection:function(){a("#widgets-left").removeClass("chooser");a(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(c){this.hoveredSidebar.addClass("closed");a(c.target).css("min-height","");this.hoveredSidebar=null}};b.ready(function(){wpWidgets.init()})})(jQuery);
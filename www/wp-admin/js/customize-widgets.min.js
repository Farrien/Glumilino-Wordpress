(function(d,f){if(!d||!d.customize){return}var e=d.customize,c;e.Widgets=e.Widgets||{};e.Widgets.savedWidgetIds={};e.Widgets.data=_wpCustomizeWidgetsSettings||{};c=e.Widgets.data.l10n;delete e.Widgets.data.l10n;e.Widgets.WidgetModel=Backbone.Model.extend({id:null,temp_id:null,classname:null,control_tpl:null,description:null,is_disabled:null,is_multi:null,multi_number:null,name:null,id_base:null,transport:null,params:[],width:null,height:null,search_matched:true});e.Widgets.WidgetCollection=Backbone.Collection.extend({model:e.Widgets.WidgetModel,doSearch:function(h){if(this.terms===h){return}this.terms=h;if(this.terms.length>0){this.search(this.terms)}if(this.terms===""){this.each(function(i){i.set("search_matched",true)})}},search:function(i){var h,j;i=i.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");i=i.replace(/ /g,")(?=.*");h=new RegExp("^(?=.*"+i+").+","i");this.each(function(k){j=[k.get("name"),k.get("id"),k.get("description")].join(" ");k.set("search_matched",h.test(j))})}});e.Widgets.availableWidgets=new e.Widgets.WidgetCollection(e.Widgets.data.availableWidgets);e.Widgets.SidebarModel=Backbone.Model.extend({after_title:null,after_widget:null,before_title:null,before_widget:null,"class":null,description:null,id:null,name:null,is_rendered:false});e.Widgets.SidebarCollection=Backbone.Collection.extend({model:e.Widgets.SidebarModel});e.Widgets.registeredSidebars=new e.Widgets.SidebarCollection(e.Widgets.data.registeredSidebars);e.Widgets.AvailableWidgetsPanelView=d.Backbone.View.extend({el:"#available-widgets",events:{"input #widgets-search":"search","keyup #widgets-search":"search","focus .widget-tpl":"focus","click .widget-tpl":"_submit","keypress .widget-tpl":"_submit",keydown:"keyboardAccessible"},selected:null,currentSidebarControl:null,$search:null,$clearResults:null,searchMatchesCount:null,initialize:function(){var h=this;this.$search=f("#widgets-search");this.$clearResults=this.$el.find(".clear-results");_.bindAll(this,"close");this.listenTo(this.collection,"change",this.updateList);this.updateList();this.searchMatchesCount=this.collection.length;f("#customize-controls, #available-widgets .customize-section-title").on("click keydown",function(j){var i=f(j.target).is(".add-new-widget, .add-new-widget *");if(f("body").hasClass("adding-widget")&&!i){h.close()}});this.$clearResults.on("click",function(){h.$search.val("").focus().trigger("keyup")});e.previewer.bind("url",this.close)},search:function(h){var i;this.collection.doSearch(h.target.value);this.updateSearchMatchesCount();this.announceSearchMatches();if(this.selected&&!this.selected.is(":visible")){this.selected.removeClass("selected");this.selected=null}if(this.selected&&!h.target.value){this.selected.removeClass("selected");this.selected=null}if(!this.selected&&h.target.value){i=this.$el.find("> .widget-tpl:visible:first");if(i.length){this.select(i)}}if(""!==h.target.value){this.$clearResults.addClass("is-visible")}else{if(""===h.target.value){this.$clearResults.removeClass("is-visible")}}if(!this.searchMatchesCount){this.$el.addClass("no-widgets-found")}else{this.$el.removeClass("no-widgets-found")}},updateSearchMatchesCount:function(){this.searchMatchesCount=this.collection.where({search_matched:true}).length},announceSearchMatches:_.debounce(function(){var h=c.widgetsFound.replace("%d",this.searchMatchesCount);if(!this.searchMatchesCount){h=c.noWidgetsFound}d.a11y.speak(h)},500),updateList:function(){this.collection.each(function(h){var i=f("#widget-tpl-"+h.id);i.toggle(h.get("search_matched")&&!h.get("is_disabled"));if(h.get("is_disabled")&&i.is(this.selected)){this.selected=null}})},select:function(h){this.selected=f(h);this.selected.siblings(".widget-tpl").removeClass("selected");this.selected.addClass("selected")},focus:function(h){this.select(f(h.currentTarget))},_submit:function(h){if(h.type==="keypress"&&(h.which!==13&&h.which!==32)){return}this.submit(f(h.currentTarget))},submit:function(k){var i,j,h;if(!k){k=this.selected}if(!k||!this.currentSidebarControl){return}this.select(k);i=f(this.selected).data("widget-id");j=this.collection.findWhere({id:i});if(!j){return}h=this.currentSidebarControl.addWidget(j.get("id_base"));if(h){h.focus()}this.close()},open:function(h){this.currentSidebarControl=h;_(this.currentSidebarControl.getWidgetFormControls()).each(function(i){if(i.params.is_wide){i.collapseForm()}});f("body").addClass("adding-widget");this.$el.find(".selected").removeClass("selected");this.collection.doSearch("");if(!e.settings.browser.mobile){this.$search.focus()}},close:function(h){h=h||{};if(h.returnFocus&&this.currentSidebarControl){this.currentSidebarControl.container.find(".add-new-widget").focus()}this.currentSidebarControl=null;this.selected=null;f("body").removeClass("adding-widget");this.$search.val("")},keyboardAccessible:function(h){var q=(h.which===13),p=(h.which===27),n=(h.which===40),k=(h.which===38),j=(h.which===9),i=(h.shiftKey),l=null,o=this.$el.find("> .widget-tpl:visible:first"),m=this.$el.find("> .widget-tpl:visible:last"),r=f(h.target).is(this.$search),s=f(h.target).is(".widget-tpl:visible:last");if(n||k){if(n){if(r){l=o}else{if(this.selected&&this.selected.nextAll(".widget-tpl:visible").length!==0){l=this.selected.nextAll(".widget-tpl:visible:first")}}}else{if(k){if(r){l=m}else{if(this.selected&&this.selected.prevAll(".widget-tpl:visible").length!==0){l=this.selected.prevAll(".widget-tpl:visible:first")}}}}this.select(l);if(l){l.focus()}else{this.$search.focus()}return}if(q&&!this.$search.val()){return}if(q){this.submit()}else{if(p){this.close({returnFocus:true})}}if(this.currentSidebarControl&&j&&(i&&r||!i&&s)){this.currentSidebarControl.container.find(".add-new-widget").focus();h.preventDefault()}}});e.Widgets.formSyncHandlers={rss:function(l,k,i){var j=k.find(".widget-error:first"),h=f("<div>"+i+"</div>").find(".widget-error:first");if(j.length&&h.length){j.replaceWith(h)}else{if(j.length){j.remove()}else{if(h.length){k.find(".widget-content:first").prepend(h)}}}}};e.Widgets.WidgetControl=e.Control.extend({defaultExpandedArguments:{duration:"fast",completeCallback:f.noop},initialize:function(j,h){var i=this;i.widgetControlEmbedded=false;i.widgetContentEmbedded=false;i.expanded=new e.Value(false);i.expandedArgumentsQueue=[];i.expanded.bind(function(k){var l=i.expandedArgumentsQueue.shift();l=f.extend({},i.defaultExpandedArguments,l);i.onChangeExpanded(k,l)});i.altNotice=true;e.Control.prototype.initialize.call(i,j,h)},ready:function(){var h=this;if(!h.section()){h.embedWidgetControl()}else{e.section(h.section(),function(j){var i=function(k){if(k){h.embedWidgetControl();j.expanded.unbind(i)}};if(j.expanded()){i(true)}else{j.expanded.bind(i)}})}},embedWidgetControl:function(){var i=this,h;if(i.widgetControlEmbedded){return}i.widgetControlEmbedded=true;h=f(i.params.widget_control);i.container.append(h);i._setupModel();i._setupWideWidget();i._setupControlToggle();i._setupWidgetTitle();i._setupReorderUI();i._setupHighlightEffects();i._setupUpdateUI();i._setupRemoveUI()},embedWidgetContent:function(){var i=this,h;i.embedWidgetControl();if(i.widgetContentEmbedded){return}i.widgetContentEmbedded=true;h=f(i.params.widget_content);i.container.find(".widget-content:first").append(h);f(document).trigger("widget-added",[i.container.find(".widget:first")])},_setupModel:function(){var h=this,i;i=function(){e.Widgets.savedWidgetIds[h.params.widget_id]=true};e.bind("ready",i);e.bind("saved",i);this._updateCount=0;this.isWidgetUpdating=false;this.liveUpdateMode=true;this.setting.bind(function(k,j){if(!_(j).isEqual(k)&&!h.isWidgetUpdating){h.updateWidget({instance:k})}})},_setupWideWidget:function(){var i=this,k,m,l,j,h;if(!this.params.is_wide){return}k=this.container.find(".widget-inside");m=k.find("> .form");l=f(".wp-full-overlay-sidebar-content:first");this.container.addClass("wide-widget-control");this.container.find(".widget-content:first").css({"max-width":this.params.width,"min-height":this.params.height});h=function(){var n=i.container.offset().top,q=f(window).height(),o=m.outerHeight(),p;k.css("max-height",q);p=Math.max(0,Math.min(Math.max(n,0),q-o));k.css("top",p)};j=f("#customize-theme-controls");this.container.on("expand",function(){h();l.on("scroll",h);f(window).on("resize",h);j.on("expanded collapsed",h)});this.container.on("collapsed",function(){l.off("scroll",h);f(window).off("resize",h);j.off("expanded collapsed",h)});e.each(function(n){if(0===n.id.indexOf("sidebars_widgets[")){n.bind(function(){if(i.container.hasClass("expanded")){h()}})}})},_setupControlToggle:function(){var h=this,i;this.container.find(".widget-top").on("click",function(k){k.preventDefault();var j=h.getSidebarWidgetsControl();if(j.isReordering){return}h.expanded(!h.expanded())});i=this.container.find(".widget-control-close");i.on("click",function(j){j.preventDefault();h.collapse();h.container.find(".widget-top .widget-action:first").focus()})},_setupWidgetTitle:function(){var h=this,i;i=function(){var k=h.setting().title,j=h.container.find(".in-widget-title");if(k){j.text(": "+k)}else{j.text("")}};this.setting.bind(i);i()},_setupReorderUI:function(){var j=this,m,l,i,h,k;m=function(n){n.siblings(".selected").removeClass("selected");n.addClass("selected");var o=(n.data("id")===j.params.sidebar_id);j.container.find(".move-widget-btn").prop("disabled",o)};this.container.find(".widget-title-action").after(f(e.Widgets.data.tpl.widgetReorderNav));k=_.template(e.Widgets.data.tpl.moveWidgetArea);l=f(k({sidebars:_(e.Widgets.registeredSidebars.toArray()).pluck("attributes")}));this.container.find(".widget-top").after(l);h=function(){var o=l.find("li"),p,n=0;p=o.filter(function(){return f(this).data("id")===j.params.sidebar_id});o.each(function(){var q=f(this),s,r,t;s=q.data("id");r=e.Widgets.registeredSidebars.get(s);t=r.get("is_rendered");q.toggle(t);if(t){n+=1}if(q.hasClass("selected")&&!t){m(p)}});if(n>1){j.container.find(".move-widget").show()}else{j.container.find(".move-widget").hide()}};h();e.Widgets.registeredSidebars.on("change:is_rendered",h);i=this.container.find(".widget-reorder-nav");i.find(".move-widget, .move-widget-down, .move-widget-up").each(function(){f(this).prepend(j.container.find(".widget-title").text()+": ")}).on("click keypress",function(o){if(o.type==="keypress"&&(o.which!==13&&o.which!==32)){return}f(this).focus();if(f(this).is(".move-widget")){j.toggleWidgetMoveArea()}else{var p=f(this).is(".move-widget-down"),q=f(this).is(".move-widget-up"),n=j.getWidgetSidebarPosition();if((q&&n===0)||(p&&n===j.getSidebarWidgetsControl().setting().length-1)){return}if(q){j.moveUp();d.a11y.speak(c.widgetMovedUp)}else{j.moveDown();d.a11y.speak(c.widgetMovedDown)}f(this).focus()}});this.container.find(".widget-area-select").on("click keypress","li",function(n){if(n.type==="keypress"&&(n.which!==13&&n.which!==32)){return}n.preventDefault();m(f(this))});this.container.find(".move-widget-btn").click(function(){j.getSidebarWidgetsControl().toggleReordering(false);var q=j.params.sidebar_id,p=j.container.find(".widget-area-select li.selected").data("id"),n,o,s,t,r;n=e("sidebars_widgets["+q+"]");o=e("sidebars_widgets["+p+"]");s=Array.prototype.slice.call(n());t=Array.prototype.slice.call(o());r=j.getWidgetSidebarPosition();s.splice(r,1);t.push(j.params.widget_id);n(s);o(t);j.focus()})},_setupHighlightEffects:function(){var h=this;this.container.on("mouseenter click",function(){h.setting.previewer.send("highlight-widget",h.params.widget_id)});this.setting.bind(function(){h.setting.previewer.send("highlight-widget",h.params.widget_id)})},_setupUpdateUI:function(){var i=this,j,l,m,h,k;j=this.container.find(".widget:first");l=j.find(".widget-content:first");m=this.container.find(".widget-control-save");m.val(c.saveBtnLabel);m.attr("title",c.saveBtnTooltip);m.removeClass("button-primary");m.on("click",function(n){n.preventDefault();i.updateWidget({disable_form:true})});h=_.debounce(function(){i.updateWidget()},250);l.on("keydown","input",function(n){if(13===n.which){n.preventDefault();i.updateWidget({ignoreActiveElement:true})}});l.on("change input propertychange",":input",function(n){if(!i.liveUpdateMode){return}if(n.type==="change"||(this.checkValidity&&this.checkValidity())){h()}});this.setting.previewer.channel.bind("synced",function(){i.container.removeClass("previewer-loading")});e.previewer.bind("widget-updated",function(n){if(n===i.params.widget_id){i.container.removeClass("previewer-loading")}});k=e.Widgets.formSyncHandlers[this.params.widget_id_base];if(k){f(document).on("widget-synced",function(o,n){if(j.is(n)){k.apply(document,arguments)}})}},onChangeActive:function(i,h){this.container.toggleClass("widget-rendered",i);if(h.completeCallback){h.completeCallback()}},_setupRemoveUI:function(){var i=this,h,j;h=this.container.find("a.widget-control-remove");h.on("click",function(k){k.preventDefault();var l;if(i.container.next().is(".customize-control-widget_form")){l=i.container.next().find(".widget-action:first")}else{if(i.container.prev().is(".customize-control-widget_form")){l=i.container.prev().find(".widget-action:first")}else{l=i.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first")}}i.container.slideUp(function(){var o=e.Widgets.getSidebarWidgetControlContainingWidget(i.params.widget_id),n,m;if(!o){return}n=o.setting().slice();m=_.indexOf(n,i.params.widget_id);if(-1===m){return}n.splice(m,1);o.setting(n);l.focus()})});j=function(){h.text(c.removeBtnLabel);h.attr("title",c.removeBtnTooltip)};if(this.params.is_new){e.bind("saved",j)}else{j()}},_getInputs:function(h){return f(h).find(":input[name]")},_getInputsSignature:function(h){var i=_(h).map(function(j){var l=f(j),k;if(l.is(":checkbox, :radio")){k=[l.attr("id"),l.attr("name"),l.prop("value")]}else{k=[l.attr("id"),l.attr("name")]}return k.join(",")});return i.join(";")},_getInputState:function(h){h=f(h);if(h.is(":radio, :checkbox")){return h.prop("checked")}else{if(h.is("select[multiple]")){return h.find("option:selected").map(function(){return f(this).val()}).get()}else{return h.val()}}},_setInputState:function(h,i){h=f(h);if(h.is(":radio, :checkbox")){h.prop("checked",i)}else{if(h.is("select[multiple]")){if(!f.isArray(i)){i=[]}else{i=_.map(i,function(j){return String(j)})}h.find("option").each(function(){f(this).prop("selected",-1!==_.indexOf(i,String(this.value)))})}else{h.val(i)}}},getSidebarWidgetsControl:function(){var i,h;i="sidebars_widgets["+this.params.sidebar_id+"]";h=e.control(i);if(!h){return}return h},updateWidget:function(n){var t=this,h,r,p,o,q,l,m,i,k,j,s;t.embedWidgetContent();n=f.extend({instance:null,complete:null,ignoreActiveElement:false},n);h=n.instance;r=n.complete;this._updateCount+=1;q=this._updateCount;p=this.container.find(".widget:first");o=p.find(".widget-content:first");o.find(".widget-error").remove();this.container.addClass("widget-form-loading");this.container.addClass("previewer-loading");k=e.state("processing");k(k()+1);if(!this.liveUpdateMode){this.container.addClass("widget-form-disabled")}l={};l.action="update-widget";l.wp_customize="on";l.nonce=e.settings.nonce["update-widget"];l.customize_theme=e.settings.theme.stylesheet;l.customized=d.customize.previewer.query().customized;m=f.param(l);i=this._getInputs(o);i.each(function(){f(this).data("state"+q,t._getInputState(this))});if(h){m+="&"+f.param({sanitized_widget_setting:JSON.stringify(h)})}else{m+="&"+i.serialize()}m+="&"+o.find("~ :input").serialize();if(this._previousUpdateRequest){this._previousUpdateRequest.abort()}j=f.post(d.ajax.settings.url,m);this._previousUpdateRequest=j;j.done(function(z){var y,u,x,w,v=false;if("0"===z){e.previewer.preview.iframe.hide();e.previewer.login().done(function(){t.updateWidget(n);e.previewer.preview.iframe.show()});return}if("-1"===z){e.previewer.cheatin();return}if(z.success){u=f("<div>"+z.data.form+"</div>");x=t._getInputs(u);w=t._getInputsSignature(i)===t._getInputsSignature(x);if(w&&!t.liveUpdateMode){t.liveUpdateMode=true;t.container.removeClass("widget-form-disabled");t.container.find('input[name="savewidget"]').hide()}if(w&&t.liveUpdateMode){i.each(function(C){var F=f(this),B=f(x[C]),A,D,E;A=F.data("state"+q);D=t._getInputState(B);F.data("sanitized",D);E=(!_.isEqual(A,D)&&(n.ignoreActiveElement||!F.is(document.activeElement)));if(E){t._setInputState(F,D)}});f(document).trigger("widget-synced",[p,z.data.form])}else{if(t.liveUpdateMode){t.liveUpdateMode=false;t.container.find('input[name="savewidget"]').show();v=true}else{o.html(z.data.form);t.container.removeClass("widget-form-disabled");f(document).trigger("widget-updated",[p])}}s=!v&&!_(t.setting()).isEqual(z.data.instance);if(s){t.isWidgetUpdating=true;t.setting(z.data.instance);t.isWidgetUpdating=false}else{t.container.removeClass("previewer-loading")}if(r){r.call(t,null,{noChange:!s,ajaxFinished:true})}}else{y=c.error;if(z.data&&z.data.message){y=z.data.message}if(r){r.call(t,y)}else{o.prepend('<p class="widget-error"><strong>'+y+"</strong></p>")}}});j.fail(function(u,v){if(r){r.call(t,v)}});j.always(function(){t.container.removeClass("widget-form-loading");i.each(function(){f(this).removeData("state"+q)});k(k()-1)})},expandControlSection:function(){e.Control.prototype.expand.call(this)},_toggleExpanded:e.Section.prototype._toggleExpanded,expand:e.Section.prototype.expand,expandForm:function(){this.expand()},collapse:e.Section.prototype.collapse,collapseForm:function(){this.collapse()},toggleForm:function(h){if(typeof h==="undefined"){h=!this.expanded()}this.expanded(h)},onChangeExpanded:function(k,m){var j=this,o,l,i,n,h;j.embedWidgetControl();if(k){j.embedWidgetContent()}if(m.unchanged){if(k){e.Control.prototype.expand.call(j,{completeCallback:m.completeCallback})}return}o=this.container.find("div.widget:first");l=o.find(".widget-inside:first");h=function(){e.control.each(function(p){if(j.params.type===p.params.type&&j!==p){p.collapse()}});i=function(){j.container.removeClass("expanding");j.container.addClass("expanded");j.container.trigger("expanded")};if(m.completeCallback){n=i;i=function(){n();m.completeCallback()}}if(j.params.is_wide){l.fadeIn(m.duration,i)}else{l.slideDown(m.duration,i)}j.container.trigger("expand");j.container.addClass("expanding")};if(k){if(e.section.has(j.section())){e.section(j.section()).expand({completeCallback:h})}else{h()}}else{i=function(){j.container.removeClass("collapsing");j.container.removeClass("expanded");j.container.trigger("collapsed")};if(m.completeCallback){n=i;i=function(){n();m.completeCallback()}}j.container.trigger("collapse");j.container.addClass("collapsing");if(j.params.is_wide){l.fadeOut(m.duration,i)}else{l.slideUp(m.duration,function(){o.css({width:"",margin:""});i()})}}},getWidgetSidebarPosition:function(){var i,h;i=this.getSidebarWidgetsControl().setting();h=_.indexOf(i,this.params.widget_id);if(h===-1){return}return h},moveUp:function(){this._moveWidgetByOne(-1)},moveDown:function(){this._moveWidgetByOne(1)},_moveWidgetByOne:function(m){var l,h,k,j;l=this.getWidgetSidebarPosition();h=this.getSidebarWidgetsControl().setting;k=Array.prototype.slice.call(h());j=k[l+m];k[l+m]=this.params.widget_id;k[l]=j;h(k)},toggleWidgetMoveArea:function(h){var i=this,j;j=this.container.find(".move-widget-area");if(typeof h==="undefined"){h=!j.hasClass("active")}if(h){j.find(".selected").removeClass("selected");j.find("li").filter(function(){return f(this).data("id")===i.params.sidebar_id}).addClass("selected");this.container.find(".move-widget-btn").prop("disabled",true)}j.toggleClass("active",h)},highlightSectionAndControl:function(){var h;if(this.container.is(":hidden")){h=this.container.closest(".control-section")}else{h=this.container}f(".highlighted").removeClass("highlighted");h.addClass("highlighted");setTimeout(function(){h.removeClass("highlighted")},500)}});e.Widgets.WidgetsPanel=e.Panel.extend({ready:function(){var h=this;e.Panel.prototype.ready.call(h);h.deferred.embedded.done(function(){var k,j,i;k=h.container.find(".panel-meta");j=f("<div></div>",{"class":"no-widget-areas-rendered-notice"});j.append(f("<em></em>",{text:c.noAreasRendered}));k.append(j);i=function(){return(0===_.filter(h.sections(),function(l){return l.active()}).length)};j.toggle(i());e.previewer.deferred.active.done(function(){j.toggle(i())});e.bind("pane-contents-reflowed",function(){var l=("resolved"===e.previewer.deferred.active.state())?"fast":0;if(i()){j.slideDown(l)}else{j.slideUp(l)}})})},isContextuallyActive:function(){var h=this;return h.active()}});e.Widgets.SidebarSection=e.Section.extend({ready:function(){var h=this,i;e.Section.prototype.ready.call(this);i=e.Widgets.registeredSidebars.get(h.params.sidebarId);h.active.bind(function(j){i.set("is_rendered",j)});i.set("is_rendered",h.active())}});e.Widgets.SidebarControl=e.Control.extend({ready:function(){this.$controlSection=this.container.closest(".control-section");this.$sectionContent=this.container.closest(".accordion-section-content");this._setupModel();this._setupSortable();this._setupAddition();this._applyCardinalOrderClassNames()},_setupModel:function(){var h=this;this.setting.bind(function(l,m){var j,i,k;i=_(m).difference(l);l=_(l).filter(function(o){var n=a(o);return !!e.Widgets.availableWidgets.findWhere({id_base:n.id_base})});j=_(l).map(function(o){var n=e.Widgets.getWidgetFormControlForWidget(o);if(!n){n=h.addWidget(o)}return n});j.sort(function(p,n){var q=_.indexOf(l,p.params.widget_id),o=_.indexOf(l,n.params.widget_id);return q-o});k=0;_(j).each(function(n){n.priority(k);n.section(h.section());k+=1});h.priority(k);h._applyCardinalOrderClassNames();_(j).each(function(n){n.params.sidebar_id=h.params.sidebar_id});_(i).each(function(n){setTimeout(function(){var t,p,s,o,r,q=false;e.each(function(w){if(w.id===h.setting.id||0!==w.id.indexOf("sidebars_widgets[")||w.id==="sidebars_widgets[wp_inactive_widgets]"){return}var v=w(),u;u=_.indexOf(v,n);if(-1!==u){q=true}});if(q){return}t=e.Widgets.getWidgetFormControlForWidget(n);p=t&&f.contains(document,t.container[0])&&!f.contains(h.$sectionContent[0],t.container[0]);if(t&&!p){e.control.remove(t.id);t.container.remove()}if(e.Widgets.savedWidgetIds[n]){s=e.value("sidebars_widgets[wp_inactive_widgets]")().slice();s.push(n);e.value("sidebars_widgets[wp_inactive_widgets]")(_(s).unique())}o=a(n).id_base;r=e.Widgets.availableWidgets.findWhere({id_base:o});if(r&&!r.get("is_multi")){r.set("is_disabled",false)}})})})},_setupSortable:function(){var h=this;this.isReordering=false;this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",connectWith:".accordion-section-content:has(.customize-control-sidebar_widgets)",update:function(){var j=h.$sectionContent.sortable("toArray"),i;i=f.map(j,function(k){return f("#"+k).find(":input[name=widget-id]").val()});h.setting(i)}});this.$controlSection.find(".accordion-section-title").droppable({accept:".customize-control-widget_form",over:function(){var i=e.section(h.section.get());i.expand({allowMultiple:true,completeCallback:function(){e.section.each(function(j){if(j.container.find(".customize-control-sidebar_widgets").length){j.container.find(".accordion-section-content:first").sortable("refreshPositions")}})}})}});this.container.find(".reorder-toggle").on("click",function(){h.toggleReordering(!h.isReordering)})},_setupAddition:function(){var h=this;this.container.find(".add-new-widget").on("click",function(){var i=f(this);if(h.$sectionContent.hasClass("reordering")){return}if(!f("body").hasClass("adding-widget")){i.attr("aria-expanded","true");e.Widgets.availableWidgetsPanel.open(h)}else{i.attr("aria-expanded","false");e.Widgets.availableWidgetsPanel.close()}})},_applyCardinalOrderClassNames:function(){var h=[];_.each(this.setting(),function(j){var i=e.Widgets.getWidgetFormControlForWidget(j);if(i){h.push(i)}});if(0===h.length||(1===e.Widgets.registeredSidebars.length&&h.length<=1)){this.container.find(".reorder-toggle").hide();return}else{this.container.find(".reorder-toggle").show()}f(h).each(function(){f(this.container).removeClass("first-widget").removeClass("last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)});_.first(h).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1);_.last(h).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1)},toggleReordering:function(h){var i=this.$sectionContent.find(".add-new-widget"),k=this.container.find(".reorder-toggle"),j=this.$sectionContent.find(".widget-title");h=Boolean(h);if(h===this.$sectionContent.hasClass("reordering")){return}this.isReordering=h;this.$sectionContent.toggleClass("reordering",h);if(h){_(this.getWidgetFormControls()).each(function(l){l.collapse()});i.attr({tabindex:"-1","aria-hidden":"true"});k.attr("aria-label",c.reorderLabelOff);d.a11y.speak(c.reorderModeOn);j.attr("aria-hidden","true")}else{i.removeAttr("tabindex aria-hidden");k.attr("aria-label",c.reorderLabelOn);d.a11y.speak(c.reorderModeOff);j.attr("aria-hidden","false")}},getWidgetFormControls:function(){var h=[];_(this.setting()).each(function(i){var j=b(i),k=e.control(j);if(k){h.push(k)}});return h},addWidget:function(o){var w=this,s,h,i="widget_form",p,v,k=a(o),r=k.number,n=k.id_base,m=e.Widgets.availableWidgets.findWhere({id_base:n}),u,t,j,q,l,x;if(!m){return false}if(r&&!m.get("is_multi")){return false}if(m.get("is_multi")&&!r){m.set("multi_number",m.get("multi_number")+1);r=m.get("multi_number")}s=f.trim(f("#widget-tpl-"+m.get("id")).html());if(m.get("is_multi")){s=s.replace(/<[^<>]+>/g,function(y){return y.replace(/__i__|%i%/g,r)})}else{m.set("is_disabled",true)}h=f(s);p=f("<li/>").addClass("customize-control").addClass("customize-control-"+i).append(h);p.find("> .widget-icon").remove();if(m.get("is_multi")){p.find('input[name="widget_number"]').val(r);p.find('input[name="multi_number"]').val(r)}o=p.find('[name="widget-id"]').val();p.hide();u="widget_"+m.get("id_base");if(m.get("is_multi")){u+="["+r+"]"}p.attr("id","customize-control-"+u.replace(/\]/g,"").replace(/\[/g,"-"));t=e.has(u);if(!t){l={transport:e.Widgets.data.selectiveRefreshableWidgets[m.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer};x=e.create(u,u,"",l);x.set({})}v=e.controlConstructor[i];j=new v(u,{params:{settings:{"default":u},content:p,sidebar_id:w.params.sidebar_id,widget_id:o,widget_id_base:m.get("id_base"),type:i,is_new:!t,width:m.get("width"),height:m.get("height"),is_wide:m.get("is_wide"),active:true},previewer:w.setting.previewer});e.control.add(u,j);e.each(function(A){if(A.id===w.setting.id){return}if(0!==A.id.indexOf("sidebars_widgets[")){return}var z=A().slice(),y=_.indexOf(z,o);if(-1!==y){z.splice(y);A(z)}});q=this.setting().slice();if(-1===_.indexOf(q,o)){q.push(o);this.setting(q)}p.slideDown(function(){if(t){j.updateWidget({instance:j.setting()})}});return j}});f.extend(e.panelConstructor,{widgets:e.Widgets.WidgetsPanel});f.extend(e.sectionConstructor,{sidebar:e.Widgets.SidebarSection});f.extend(e.controlConstructor,{widget_form:e.Widgets.WidgetControl,sidebar_widgets:e.Widgets.SidebarControl});e.bind("ready",function(){e.Widgets.availableWidgetsPanel=new e.Widgets.AvailableWidgetsPanelView({collection:e.Widgets.availableWidgets});e.previewer.bind("highlight-widget-control",e.Widgets.highlightWidgetFormControl);e.previewer.bind("focus-widget-control",e.Widgets.focusWidgetFormControl)});e.Widgets.highlightWidgetFormControl=function(h){var i=e.Widgets.getWidgetFormControlForWidget(h);if(i){i.highlightSectionAndControl()}},e.Widgets.focusWidgetFormControl=function(h){var i=e.Widgets.getWidgetFormControlForWidget(h);if(i){i.focus()}},e.Widgets.getSidebarWidgetControlContainingWidget=function(h){var i=null;e.control.each(function(j){if(j.params.type==="sidebar_widgets"&&-1!==_.indexOf(j.setting(),h)){i=j}});return i};e.Widgets.getWidgetFormControlForWidget=function(h){var i=null;e.control.each(function(j){if(j.params.type==="widget_form"&&j.params.widget_id===h){i=j}});return i};f(document).on("widget-added",function(k,j){var m,i,l,h;m=a(j.find("> .widget-inside > .form > .widget-id").val());if("nav_menu"!==m.id_base){return}i=e.control("widget_nav_menu["+String(m.number)+"]");if(!i){return}l=j.find('select[name*="nav_menu"]');h=j.find(".edit-selected-nav-menu > button");if(0===l.length||0===h.length){return}l.on("change",function(){if(e.section.has("nav_menu["+l.val()+"]")){h.parent().show()}else{h.parent().hide()}});h.on("click",function(){var n=e.section("nav_menu["+l.val()+"]");if(n){g(n,i)}})});function g(i,j){i.focus();function h(k){if(!k){i.expanded.unbind(h);j.focus()}}i.expanded.bind(h)}function a(i){var j,h={number:null,id_base:null};j=i.match(/^(.+)-(\d+)$/);if(j){h.id_base=j[1];h.number=parseInt(j[2],10)}else{h.id_base=i}return h}function b(i){var h=a(i),j;j="widget_"+h.id_base;if(h.number){j+="["+h.number+"]"}return j}})(window.wp,jQuery);
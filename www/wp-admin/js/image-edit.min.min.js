(function(d){var c=window.imageEdit={iasapi:{},hold:{},postid:"",_view:false,intval:function(a){return a|0},setDisabled:function(a,b){if(b){a.removeClass("disabled").prop("disabled",false)}else{a.addClass("disabled").prop("disabled",true)}},init:function(a){var h=this,i=d("#image-editor-"+h.postid),j=h.intval(d("#imgedit-x-"+a).val()),b=h.intval(d("#imgedit-y-"+a).val());if(h.postid!==a&&i.length){h.close(h.postid)}h.hold.w=h.hold.ow=j;h.hold.h=h.hold.oh=b;h.hold.xy_ratio=j/b;h.hold.sizer=parseFloat(d("#imgedit-sizer-"+a).val());h.postid=a;d("#imgedit-response-"+a).empty();d('input[type="text"]',"#imgedit-panel-"+a).keypress(function(e){var f=e.keyCode;if(36<f&&f<41){d(this).blur()}if(13===f){e.preventDefault();e.stopPropagation();return false}})},toggleEditor:function(a,f){var b=d("#imgedit-wait-"+a);if(f){b.fadeIn("fast")}else{b.fadeOut("fast")}},toggleHelp:function(a){var b=d(a);b.attr("aria-expanded","false"===b.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast");return false},getTarget:function(a){return d('input[name="imgedit-target-'+a+'"]:checked',"#imgedit-save-target-"+a).val()||"full"},scaleChanged:function(a,p,h){var n=d("#imgedit-scale-width-"+a),l=d("#imgedit-scale-height-"+a),b=d("#imgedit-scale-warn-"+a),o="",m="";if(false===this.validateNumeric(h)){return}if(p){m=(n.val()!=="")?Math.round(n.val()/this.hold.xy_ratio):"";l.val(m)}else{o=(l.val()!=="")?Math.round(l.val()*this.hold.xy_ratio):"";n.val(o)}if((m&&m>this.hold.oh)||(o&&o>this.hold.ow)){b.css("visibility","visible")}else{b.css("visibility","hidden")}},getSelRatio:function(a){var j=this.hold.w,b=this.hold.h,h=this.intval(d("#imgedit-crop-width-"+a).val()),i=this.intval(d("#imgedit-crop-height-"+a).val());if(h&&i){return h+":"+i}if(j&&b){return j+":"+b}return"1:1"},filterHistory:function(a,l){var n=d("#imgedit-history-"+a).val(),p,b,m,o,i=[];if(n!==""){n=JSON.parse(n);p=this.intval(d("#imgedit-undone-"+a).val());if(p>0){while(p>0){n.pop();p--}}if(l){if(!n.length){this.hold.w=this.hold.ow;this.hold.h=this.hold.oh;return""}m=n[n.length-1];m=m.c||m.r||m.f||false;if(m){this.hold.w=m.fw;this.hold.h=m.fh}}for(b in n){o=n[b];if(o.hasOwnProperty("c")){i[b]={c:{x:o.c.x,y:o.c.y,w:o.c.w,h:o.c.h}}}else{if(o.hasOwnProperty("r")){i[b]={r:o.r.r}}else{if(o.hasOwnProperty("f")){i[b]={f:o.f.f}}}}}return JSON.stringify(i)}return""},refreshEditor:function(a,j,b){var k=this,i,l;k.toggleEditor(a,1);i={action:"imgedit-preview",_ajax_nonce:j,postid:a,history:k.filterHistory(a,1),rand:k.intval(Math.random()*1000000)};l=d('<img id="image-preview-'+a+'" alt="" />').on("load",{history:i.history},function(e){var h,o,f=d("#imgedit-crop-"+a),g=c,p;if(""!==e.data.history){p=JSON.parse(e.data.history);if(p[p.length-1].hasOwnProperty("c")){g.setDisabled(d("#image-undo-"+a),true);d("#image-undo-"+a).focus()}}f.empty().append(l);h=Math.max(g.hold.w,g.hold.h);o=Math.max(d(l).width(),d(l).height());g.hold.sizer=h>o?o/h:1;g.initCrop(a,l,f);g.setCropSelection(a,0);if((typeof b!=="undefined")&&b!==null){b()}if(d("#imgedit-history-"+a).val()&&d("#imgedit-undone-"+a).val()==="0"){d("input.imgedit-submit-btn","#imgedit-panel-"+a).removeAttr("disabled")}else{d("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",true)}g.toggleEditor(a,0)}).on("error",function(){d("#imgedit-crop-"+a).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");k.toggleEditor(a,0)}).attr("src",ajaxurl+"?"+d.param(i))},action:function(r,m,q){var b=this,o,h,n,p,a;if(b.notsaved(r)){return false}o={action:"image-editor",_ajax_nonce:m,postid:r};if("scale"===q){h=d("#imgedit-scale-width-"+r),n=d("#imgedit-scale-height-"+r),p=b.intval(h.val()),a=b.intval(n.val());if(p<1){h.focus();return false}else{if(a<1){n.focus();return false}}if(p===b.hold.ow||a===b.hold.oh){return false}o["do"]="scale";o.fwidth=p;o.fheight=a}else{if("restore"===q){o["do"]="restore"}else{return false}}b.toggleEditor(r,1);d.post(ajaxurl,o,function(e){d("#image-editor-"+r).empty().append(e);b.toggleEditor(r,0);if(b._view){b._view.refresh()}})},save:function(a,k){var j,b=this.getTarget(a),i=this.filterHistory(a,0),l=this;if(""===i){return false}this.toggleEditor(a,1);j={action:"image-editor",_ajax_nonce:k,postid:a,history:i,target:b,context:d("#image-edit-context").length?d("#image-edit-context").val():null,"do":"save"};d.post(ajaxurl,j,function(e){var f=JSON.parse(e);if(f.error){d("#imgedit-response-"+a).html('<div class="error"><p>'+f.error+"</p></div>");c.close(a);return}if(f.fw&&f.fh){d("#media-dims-"+a).html(f.fw+" &times; "+f.fh)}if(f.thumbnail){d(".thumbnail","#thumbnail-head-"+a).attr("src",""+f.thumbnail)}if(f.msg){d("#imgedit-response-"+a).html('<div class="updated"><p>'+f.msg+"</p></div>")}if(l._view){l._view.save()}else{c.close(a)}})},open:function(q,m,b){this._view=b;var a,n,o=d("#image-editor-"+q),l=d("#media-head-"+q),p=d("#imgedit-open-btn-"+q),r=p.siblings(".spinner");if(p.hasClass("button-activated")){return}r.addClass("is-active");n={action:"image-editor",_ajax_nonce:m,postid:q,"do":"open"};a=d.ajax({url:ajaxurl,type:"post",data:n,beforeSend:function(){p.addClass("button-activated")}}).done(function(e){o.html(e);l.fadeOut("fast",function(){o.fadeIn("fast");p.removeClass("button-activated");r.removeClass("is-active")});c.init(q)});return a},imgLoaded:function(a){var f=d("#image-preview-"+a),b=d("#imgedit-crop-"+a);this.initCrop(a,f,b);this.setCropSelection(a,0);this.toggleEditor(a,0);d(".imgedit-wrap .imgedit-help-toggle").eq(0).focus()},initCrop:function(a,j,l){var m=this,k=d("#imgedit-sel-width-"+a),b=d("#imgedit-sel-height-"+a),n;m.iasapi=d(j).imgAreaSelect({parent:l,instance:true,handles:true,keys:true,minWidth:3,minHeight:3,onInit:function(e){n=d(e);n.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute");l.children().mousedown(function(i){var g=false,f,h;if(i.shiftKey){f=m.iasapi.getSelection();h=m.getSelRatio(a);g=(f&&f.width&&f.height)?f.width+":"+f.height:h}m.iasapi.setOptions({aspectRatio:g})})},onSelectStart:function(){c.setDisabled(d("#imgedit-crop-sel-"+a),1)},onSelectEnd:function(f,e){c.setCropSelection(a,e)},onSelectChange:function(g,e){var f=c.hold.sizer;k.val(c.round(e.width/f));b.val(c.round(e.height/f))}})},setCropSelection:function(a,b){var g;b=b||0;if(!b||(b.width<3&&b.height<3)){this.setDisabled(d(".imgedit-crop","#imgedit-panel-"+a),0);this.setDisabled(d("#imgedit-crop-sel-"+a),0);d("#imgedit-sel-width-"+a).val("");d("#imgedit-sel-height-"+a).val("");d("#imgedit-selection-"+a).val("");return false}g={x:b.x1,y:b.y1,w:b.width,h:b.height};this.setDisabled(d(".imgedit-crop","#imgedit-panel-"+a),1);d("#imgedit-selection-"+a).val(JSON.stringify(g))},close:function(a,b){b=b||false;if(b&&this.notsaved(a)){return false}this.iasapi={};this.hold={};if(this._view){this._view.back()}else{d("#image-editor-"+a).fadeOut("fast",function(){d("#media-head-"+a).fadeIn("fast",function(){d("#imgedit-open-btn-"+a).focus()});d(this).empty()})}},notsaved:function(a){var g=d("#imgedit-history-"+a).val(),b=(g!=="")?JSON.parse(g):[],h=this.intval(d("#imgedit-undone-"+a).val());if(h<b.length){if(confirm(d("#imgedit-leaving-"+a).html())){return false}return true}return false},addStep:function(a,b,n){var o=this,m=d("#imgedit-history-"+b),k=(m.val()!=="")?JSON.parse(m.val()):[],l=d("#imgedit-undone-"+b),p=o.intval(l.val());while(p>0){k.pop();p--}l.val(0);k.push(a);m.val(JSON.stringify(k));o.refreshEditor(b,n,function(){o.setDisabled(d("#image-undo-"+b),true);o.setDisabled(d("#image-redo-"+b),false)})},rotate:function(b,a,g,h){if(d(h).hasClass("disabled")){return false}this.addStep({r:{r:b,fw:this.hold.h,fh:this.hold.w}},a,g)},flip:function(b,a,g,h){if(d(h).hasClass("disabled")){return false}this.addStep({f:{f:b,fw:this.hold.w,fh:this.hold.h}},a,g)},crop:function(a,h,k){var b=d("#imgedit-selection-"+a).val(),l=this.intval(d("#imgedit-sel-width-"+a).val()),j=this.intval(d("#imgedit-sel-height-"+a).val());if(d(k).hasClass("disabled")||b===""){return false}b=JSON.parse(b);if(b.w>0&&b.h>0&&l>0&&j>0){b.fw=l;b.fh=j;this.addStep({c:b},a,h)}},undo:function(a,i){var j=this,k=d("#image-undo-"+a),b=d("#imgedit-undone-"+a),l=j.intval(b.val())+1;if(k.hasClass("disabled")){return}b.val(l);j.refreshEditor(a,i,function(){var f=d("#imgedit-history-"+a),e=(f.val()!=="")?JSON.parse(f.val()):[];j.setDisabled(d("#image-redo-"+a),true);j.setDisabled(k,l<e.length);if(e.length===l){d("#image-redo-"+a).focus()}})},redo:function(a,i){var j=this,k=d("#image-redo-"+a),b=d("#imgedit-undone-"+a),l=j.intval(b.val())-1;if(k.hasClass("disabled")){return}b.val(l);j.refreshEditor(a,i,function(){j.setDisabled(d("#image-undo-"+a),true);j.setDisabled(k,l>0);if(0===l){d("#image-undo-"+a).focus()}})},setNumSelection:function(E,z){var A,v=d("#imgedit-sel-width-"+E),w=d("#imgedit-sel-height-"+E),b=this.intval(v.val()),t=this.intval(w.val()),x=d("#image-preview-"+E),a=x.height(),y=x.width(),F=this.hold.sizer,B,s,C,u,D=this.iasapi;if(false===this.validateNumeric(z)){return}if(b<1){v.val("");return false}if(t<1){w.val("");return false}if(b&&t&&(A=D.getSelection())){C=A.x1+Math.round(b*F);u=A.y1+Math.round(t*F);B=A.x1;s=A.y1;if(C>y){B=0;C=y;v.val(Math.round(C/F))}if(u>a){s=0;u=a;w.val(Math.round(u/F))}D.setSelection(B,s,C,u);D.update();this.setCropSelection(E,D.getSelection())}},round:function(b){var a;b=Math.round(b);if(this.hold.sizer>0.6){return b}a=b.toString().slice(-1);if("1"===a){return b-1}else{if("9"===a){return b+1}}return b},setRatioSelection:function(a,b,n){var l,m,p=this.intval(d("#imgedit-crop-width-"+a).val()),h=this.intval(d("#imgedit-crop-height-"+a).val()),o=d("#image-preview-"+a).height();if(false===this.validateNumeric(n)){return}if(p&&h){this.iasapi.setOptions({aspectRatio:p+":"+h});if(l=this.iasapi.getSelection(true)){m=Math.ceil(l.y1+((l.x2-l.x1)/(p/h)));if(m>o){m=o;if(b){d("#imgedit-crop-height-"+a).val("")}else{d("#imgedit-crop-width-"+a).val("")}}this.iasapi.setSelection(l.x1,l.y1,l.x2,m);this.iasapi.update()}}},validateNumeric:function(a){if(!this.intval(d(a).val())){d(a).val("");return false}}}})(jQuery);
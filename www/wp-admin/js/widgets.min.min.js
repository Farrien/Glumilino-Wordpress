var wpWidgets;(function(d){var c=d(document);wpWidgets={hoveredSidebar:null,init:function(){var a,m,n=this,j=d(".widgets-chooser"),b=j.find(".widgets-chooser-sidebars"),k=d("div.widgets-sortables"),l=!!("undefined"!==typeof isRtl&&isRtl);d("#widgets-right .sidebar-name").click(function(){var e=d(this),f=e.closest(".widgets-holder-wrap");if(f.hasClass("closed")){f.removeClass("closed");e.parent().sortable("refresh")}else{f.addClass("closed")}c.triggerHandler("wp-pin-menu")});d("#widgets-left .sidebar-name").click(function(){d(this).closest(".widgets-holder-wrap").toggleClass("closed");c.triggerHandler("wp-pin-menu")});d(document.body).bind("click.widgets-toggle",function(i){var r=d(i.target),f={"z-index":100},s,h,g,t,e;if(r.parents(".widget-top").length&&!r.parents("#available-widgets").length){s=r.closest("div.widget");h=s.children(".widget-inside");g=parseInt(s.find("input.widget-width").val(),10),t=s.parent().width();if(h.is(":hidden")){if(g>250&&(g+30>t)&&s.closest("div.widgets-sortables").length){if(s.closest("div.widget-liquid-right").length){e=l?"margin-right":"margin-left"}else{e=l?"margin-left":"margin-right"}f[e]=t-(g+30)+"px";s.css(f)}s.addClass("open");h.slideDown("fast")}else{h.slideUp("fast",function(){s.attr("style","");s.removeClass("open")})}i.preventDefault()}else{if(r.hasClass("widget-control-save")){wpWidgets.save(r.closest("div.widget"),0,1,0);i.preventDefault()}else{if(r.hasClass("widget-control-remove")){wpWidgets.save(r.closest("div.widget"),1,1,0);i.preventDefault()}else{if(r.hasClass("widget-control-close")){s=r.closest("div.widget");s.removeClass("open");wpWidgets.close(s);i.preventDefault()}else{if(r.attr("id")==="inactive-widgets-control-remove"){wpWidgets.removeInactiveWidgets();i.preventDefault()}}}}}});k.children(".widget").each(function(){var e=d(this);wpWidgets.appendTitle(this);if(e.find("p.widget-error").length){e.find("a.widget-action").trigger("click")}});d("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:true,start:function(f,e){var g=d(this).find(".widgets-chooser");e.helper.find("div.widget-description").hide();m=this.id;if(g.length){d("#wpbody-content").append(g.hide());e.helper.find(".widgets-chooser").remove();n.clearWidgetSelection()}},stop:function(){if(a){d(a).hide()}a=""}});k.droppable({tolerance:"intersect",over:function(e){var f=d(e.target).parent();if(wpWidgets.hoveredSidebar&&!f.is(wpWidgets.hoveredSidebar)){wpWidgets.closeSidebar(e)}if(f.hasClass("closed")){wpWidgets.hoveredSidebar=f;f.removeClass("closed")}d(this).sortable("refresh")},out:function(e){if(wpWidgets.hoveredSidebar){wpWidgets.closeSidebar(e)}}});k.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:true,start:function(e,p){var g,i=d(this),f=i.parent(),h=p.item.children(".widget-inside");if(h.css("display")==="block"){p.item.removeClass("open");h.hide();d(this).sortable("refreshPositions")}if(!f.hasClass("closed")){g=p.item.hasClass("ui-draggable")?i.height():1+i.height();i.css("min-height",g+"px")}},stop:function(v,h){var i,e,g,f,t,x,w=h.item,u=m;wpWidgets.hoveredSidebar=null;if(w.hasClass("deleting")){wpWidgets.save(w,1,0,1);w.remove();return}i=w.find("input.add_new").val();e=w.find("input.multi_number").val();w.attr("style","").removeClass("ui-draggable");m="";if(i){if("multi"===i){w.html(w.html().replace(/<[^<>]+>/g,function(o){return o.replace(/__i__|%i%/g,e)}));w.attr("id",u.replace("__i__",e));e++;d("div#"+u).find("input.multi_number").val(e)}else{if("single"===i){w.attr("id","new-"+u);a="div#"+u}}wpWidgets.save(w,0,0,1);w.find("input.add_new").val("");c.trigger("widget-added",[w])}g=w.parent();if(g.parent().hasClass("closed")){g.parent().removeClass("closed");f=g.children(".widget");if(f.length>1){t=f.get(0);x=w.get(0);if(t.id&&x.id&&t.id!==x.id){d(t).before(w)}}}if(i){w.find("a.widget-action").trigger("click")}else{wpWidgets.saveOrder(g.attr("id"))}},activate:function(){d(this).parent().addClass("widget-hover")},deactivate:function(){d(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(g,e){var f=d(e.sender);if(this.id.indexOf("orphaned_widgets")>-1){f.sortable("cancel");return}if(f.attr("id").indexOf("orphaned_widgets")>-1&&!f.children(".widget").length){f.parents(".orphan-sidebar").slideUp(400,function(){d(this).remove()})}}}).sortable("option","connectWith","div.widgets-sortables");d("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return d(e).parent().attr("id")!=="widget-list"},drop:function(e,f){f.draggable.addClass("deleting");d("#removing-widget").hide().children("span").empty()},over:function(e,f){f.draggable.addClass("deleting");d("div.widget-placeholder").hide();if(f.draggable.hasClass("ui-sortable-helper")){d("#removing-widget").show().children("span").html(f.draggable.find("div.widget-title").children("h3").html())}},out:function(e,f){f.draggable.removeClass("deleting");d("div.widget-placeholder").show();d("#removing-widget").hide().children("span").empty()}});d("#widgets-right .widgets-holder-wrap").each(function(e,p){var g=d(p),f=g.find(".sidebar-name h2").text(),i=g.find(".widgets-sortables").attr("id"),h=d('<li tabindex="0">').text(d.trim(f));if(e===0){h.addClass("widgets-chooser-selected")}b.append(h);h.data("sidebarId",i)});d("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var e=d(this).closest(".widget");if(e.hasClass("widget-in-question")||d("#widgets-left").hasClass("chooser")){n.closeChooser()}else{n.clearWidgetSelection();d("#widgets-left").addClass("chooser");e.addClass("widget-in-question").children(".widget-description").after(j);j.slideDown(300,function(){b.find(".widgets-chooser-selected").focus()});b.find("li").on("focusin.widgets-chooser",function(){b.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected");d(this).addClass("widgets-chooser-selected")})}});j.on("click.widgets-chooser",function(e){var f=d(e.target);if(f.hasClass("button-primary")){n.addWidget(j);n.closeChooser()}else{if(f.hasClass("widgets-chooser-cancel")){n.closeChooser()}}}).on("keyup.widgets-chooser",function(e){if(e.which===d.ui.keyCode.ENTER){if(d(e.target).hasClass("widgets-chooser-cancel")){n.closeChooser()}else{n.addWidget(j);n.closeChooser()}}else{if(e.which===d.ui.keyCode.ESCAPE){n.closeChooser()}}})},saveOrder:function(a){var b={action:"widgets-order",savewidgets:d("#_wpnonce_widgets").val(),sidebars:[]};if(a){d("#"+a).find(".spinner:first").addClass("is-active")}d("div.widgets-sortables").each(function(){if(d(this).sortable){b["sidebars["+d(this).attr("id")+"]"]=d(this).sortable("toArray").join(",")}});d.post(ajaxurl,b,function(){d("#inactive-widgets-control-remove").prop("disabled",!d("#wp_inactive_widgets .widget").length);d(".spinner").removeClass("is-active")})},save:function(a,l,k,n){var b=a.closest("div.widgets-sortables").attr("id"),j=a.find("form").serialize(),m;a=d(a);d(".spinner",a).addClass("is-active");m={action:"save-widget",savewidgets:d("#_wpnonce_widgets").val(),sidebar:b};if(l){m.delete_widget=1}j+="&"+d.param(m);d.post(ajaxurl,j,function(f){var e;if(l){if(!d("input.widget_number",a).val()){e=d("input.widget-id",a).val();d("#available-widgets").find("input.widget-id").each(function(){if(d(this).val()===e){d(this).closest("div.widget").show()}})}if(k){n=0;a.slideUp("fast",function(){d(this).remove();wpWidgets.saveOrder()})}else{a.remove();if(b==="wp_inactive_widgets"){d("#inactive-widgets-control-remove").prop("disabled",!d("#wp_inactive_widgets .widget").length)}}}else{d(".spinner").removeClass("is-active");if(f&&f.length>2){d("div.widget-content",a).html(f);wpWidgets.appendTitle(a);c.trigger("widget-updated",[a]);if(b==="wp_inactive_widgets"){d("#inactive-widgets-control-remove").prop("disabled",!d("#wp_inactive_widgets .widget").length)}}}if(n){wpWidgets.saveOrder()}})},removeInactiveWidgets:function(){var b=d(".remove-inactive-widgets"),f,a;d(".spinner",b).addClass("is-active");f={action:"delete-inactive-widgets",removeinactivewidgets:d("#_wpnonce_remove_inactive_widgets").val()};a=d.param(f);d.post(ajaxurl,a,function(){d("#wp_inactive_widgets .widget").remove();d("#inactive-widgets-control-remove").prop("disabled",true);d(".spinner",b).removeClass("is-active")})},appendTitle:function(b){var a=d('input[id*="-title"]',b).val()||"";if(a){a=": "+a.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}d(b).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(a)},close:function(a){a.children(".widget-inside").slideUp("fast",function(){a.attr("style","")})},addWidget:function(a){var o,n,b,q,r,m,s,p=a.find(".widgets-chooser-selected").data("sidebarId"),t=d("#"+p);o=d("#available-widgets").find(".widget-in-question").clone();n=o.attr("id");b=o.find("input.add_new").val();q=o.find("input.multi_number").val();o.find(".widgets-chooser").remove();if("multi"===b){o.html(o.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,q)}));o.attr("id",n.replace("__i__",q));q++;d("#"+n).find("input.multi_number").val(q)}else{if("single"===b){o.attr("id","new-"+n);d("#"+n).hide()}}t.closest(".widgets-holder-wrap").removeClass("closed");t.append(o);t.sortable("refresh");wpWidgets.save(o,0,0,1);o.find("input.add_new").val("");c.trigger("widget-added",[o]);r=d(window).scrollTop();m=r+d(window).height();s=t.offset();s.bottom=s.top+t.outerHeight();if(r>s.bottom||m<s.top){d("html, body").animate({scrollTop:s.top-130},200)}window.setTimeout(function(){o.find(".widget-title").trigger("click")},250)},closeChooser:function(){var a=this;d(".widgets-chooser").slideUp(200,function(){d("#wpbody-content").append(this);a.clearWidgetSelection()})},clearWidgetSelection:function(){d("#widgets-left").removeClass("chooser");d(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(a){this.hoveredSidebar.addClass("closed");d(a.target).css("min-height","");this.hoveredSidebar=null}};c.ready(function(){wpWidgets.init()})})(jQuery);
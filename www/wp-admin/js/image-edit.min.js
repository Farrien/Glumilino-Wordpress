(function(a){var b=window.imageEdit={iasapi:{},hold:{},postid:"",_view:false,intval:function(c){return c|0},setDisabled:function(d,c){if(c){d.removeClass("disabled").prop("disabled",false)}else{d.addClass("disabled").prop("disabled",true)}},init:function(g){var e=this,d=a("#image-editor-"+e.postid),c=e.intval(a("#imgedit-x-"+g).val()),f=e.intval(a("#imgedit-y-"+g).val());if(e.postid!==g&&d.length){e.close(e.postid)}e.hold.w=e.hold.ow=c;e.hold.h=e.hold.oh=f;e.hold.xy_ratio=c/f;e.hold.sizer=parseFloat(a("#imgedit-sizer-"+g).val());e.postid=g;a("#imgedit-response-"+g).empty();a('input[type="text"]',"#imgedit-panel-"+g).keypress(function(i){var h=i.keyCode;if(36<h&&h<41){a(this).blur()}if(13===h){i.preventDefault();i.stopPropagation();return false}})},toggleEditor:function(e,c){var d=a("#imgedit-wait-"+e);if(c){d.fadeIn("fast")}else{d.fadeOut("fast")}},toggleHelp:function(d){var c=a(d);c.attr("aria-expanded","false"===c.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast");return false},getTarget:function(c){return a('input[name="imgedit-target-'+c+'"]:checked',"#imgedit-save-target-"+c).val()||"full"},scaleChanged:function(k,c,i){var e=a("#imgedit-scale-width-"+k),g=a("#imgedit-scale-height-"+k),j=a("#imgedit-scale-warn-"+k),d="",f="";if(false===this.validateNumeric(i)){return}if(c){f=(e.val()!=="")?Math.round(e.val()/this.hold.xy_ratio):"";g.val(f)}else{d=(g.val()!=="")?Math.round(g.val()*this.hold.xy_ratio):"";e.val(d)}if((f&&f>this.hold.oh)||(d&&d>this.hold.ow)){j.css("visibility","visible")}else{j.css("visibility","hidden")}},getSelRatio:function(g){var c=this.hold.w,f=this.hold.h,e=this.intval(a("#imgedit-crop-width-"+g).val()),d=this.intval(a("#imgedit-crop-height-"+g).val());if(e&&d){return e+":"+d}if(c&&f){return c+":"+f}return"1:1"},filterHistory:function(k,g){var e=a("#imgedit-history-"+k).val(),c,j,f,d,h=[];if(e!==""){e=JSON.parse(e);c=this.intval(a("#imgedit-undone-"+k).val());if(c>0){while(c>0){e.pop();c--}}if(g){if(!e.length){this.hold.w=this.hold.ow;this.hold.h=this.hold.oh;return""}f=e[e.length-1];f=f.c||f.r||f.f||false;if(f){this.hold.w=f.fw;this.hold.h=f.fh}}for(j in e){d=e[j];if(d.hasOwnProperty("c")){h[j]={c:{x:d.c.x,y:d.c.y,w:d.c.w,h:d.c.h}}}else{if(d.hasOwnProperty("r")){h[j]={r:d.r.r}}else{if(d.hasOwnProperty("f")){h[j]={f:d.f.f}}}}}return JSON.stringify(h)}return""},refreshEditor:function(h,e,g){var d=this,f,c;d.toggleEditor(h,1);f={action:"imgedit-preview",_ajax_nonce:e,postid:h,history:d.filterHistory(h,1),rand:d.intval(Math.random()*1000000)};c=a('<img id="image-preview-'+h+'" alt="" />').on("load",{history:f.history},function(m){var j,i,l=a("#imgedit-crop-"+h),k=b,n;if(""!==m.data.history){n=JSON.parse(m.data.history);if(n[n.length-1].hasOwnProperty("c")){k.setDisabled(a("#image-undo-"+h),true);a("#image-undo-"+h).focus()}}l.empty().append(c);j=Math.max(k.hold.w,k.hold.h);i=Math.max(a(c).width(),a(c).height());k.hold.sizer=j>i?i/j:1;k.initCrop(h,c,l);k.setCropSelection(h,0);if((typeof g!=="undefined")&&g!==null){g()}if(a("#imgedit-history-"+h).val()&&a("#imgedit-undone-"+h).val()==="0"){a("input.imgedit-submit-btn","#imgedit-panel-"+h).removeAttr("disabled")}else{a("input.imgedit-submit-btn","#imgedit-panel-"+h).prop("disabled",true)}k.toggleEditor(h,0)}).on("error",function(){a("#imgedit-crop-"+h).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");d.toggleEditor(h,0)}).attr("src",ajaxurl+"?"+a.param(f))},action:function(c,i,d){var k=this,f,j,g,e,l;if(k.notsaved(c)){return false}f={action:"image-editor",_ajax_nonce:i,postid:c};if("scale"===d){j=a("#imgedit-scale-width-"+c),g=a("#imgedit-scale-height-"+c),e=k.intval(j.val()),l=k.intval(g.val());if(e<1){j.focus();return false}else{if(l<1){g.focus();return false}}if(e===k.hold.ow||l===k.hold.oh){return false}f["do"]="scale";f.fwidth=e;f.fheight=l}else{if("restore"===d){f["do"]="restore"}else{return false}}k.toggleEditor(c,1);a.post(ajaxurl,f,function(h){a("#image-editor-"+c).empty().append(h);k.toggleEditor(c,0);if(k._view){k._view.refresh()}})},save:function(h,d){var e,g=this.getTarget(h),f=this.filterHistory(h,0),c=this;if(""===f){return false}this.toggleEditor(h,1);e={action:"image-editor",_ajax_nonce:d,postid:h,history:f,target:g,context:a("#image-edit-context").length?a("#image-edit-context").val():null,"do":"save"};a.post(ajaxurl,e,function(j){var i=JSON.parse(j);if(i.error){a("#imgedit-response-"+h).html('<div class="error"><p>'+i.error+"</p></div>");b.close(h);return}if(i.fw&&i.fh){a("#media-dims-"+h).html(i.fw+" &times; "+i.fh)}if(i.thumbnail){a(".thumbnail","#thumbnail-head-"+h).attr("src",""+i.thumbnail)}if(i.msg){a("#imgedit-response-"+h).html('<div class="updated"><p>'+i.msg+"</p></div>")}if(c._view){c._view.save()}else{b.close(h)}})},open:function(d,h,j){this._view=j;var k,g,f=a("#image-editor-"+d),i=a("#media-head-"+d),e=a("#imgedit-open-btn-"+d),c=e.siblings(".spinner");if(e.hasClass("button-activated")){return}c.addClass("is-active");g={action:"image-editor",_ajax_nonce:h,postid:d,"do":"open"};k=a.ajax({url:ajaxurl,type:"post",data:g,beforeSend:function(){e.addClass("button-activated")}}).done(function(l){f.html(l);i.fadeOut("fast",function(){f.fadeIn("fast");e.removeClass("button-activated");c.removeClass("is-active")});b.init(d)});return k},imgLoaded:function(e){var c=a("#image-preview-"+e),d=a("#imgedit-crop-"+e);this.initCrop(e,c,d);this.setCropSelection(e,0);this.toggleEditor(e,0);a(".imgedit-wrap .imgedit-help-toggle").eq(0).focus()},initCrop:function(i,g,e){var d=this,f=a("#imgedit-sel-width-"+i),h=a("#imgedit-sel-height-"+i),c;d.iasapi=a(g).imgAreaSelect({parent:e,instance:true,handles:true,keys:true,minWidth:3,minHeight:3,onInit:function(j){c=a(j);c.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute");e.children().mousedown(function(n){var l=false,m,k;if(n.shiftKey){m=d.iasapi.getSelection();k=d.getSelRatio(i);l=(m&&m.width&&m.height)?m.width+":"+m.height:k}d.iasapi.setOptions({aspectRatio:l})})},onSelectStart:function(){b.setDisabled(a("#imgedit-crop-sel-"+i),1)},onSelectEnd:function(j,k){b.setCropSelection(i,k)},onSelectChange:function(j,l){var k=b.hold.sizer;f.val(b.round(l.width/k));h.val(b.round(l.height/k))}})},setCropSelection:function(f,e){var d;e=e||0;if(!e||(e.width<3&&e.height<3)){this.setDisabled(a(".imgedit-crop","#imgedit-panel-"+f),0);this.setDisabled(a("#imgedit-crop-sel-"+f),0);a("#imgedit-sel-width-"+f).val("");a("#imgedit-sel-height-"+f).val("");a("#imgedit-selection-"+f).val("");return false}d={x:e.x1,y:e.y1,w:e.width,h:e.height};this.setDisabled(a(".imgedit-crop","#imgedit-panel-"+f),1);a("#imgedit-selection-"+f).val(JSON.stringify(d))},close:function(d,c){c=c||false;if(c&&this.notsaved(d)){return false}this.iasapi={};this.hold={};if(this._view){this._view.back()}else{a("#image-editor-"+d).fadeOut("fast",function(){a("#media-head-"+d).fadeIn("fast",function(){a("#imgedit-open-btn-"+d).focus()});a(this).empty()})}},notsaved:function(f){var d=a("#imgedit-history-"+f).val(),e=(d!=="")?JSON.parse(d):[],c=this.intval(a("#imgedit-undone-"+f).val());if(c<e.length){if(confirm(a("#imgedit-leaving-"+f).html())){return false}return true}return false},addStep:function(j,i,e){var d=this,f=a("#imgedit-history-"+i),h=(f.val()!=="")?JSON.parse(f.val()):[],g=a("#imgedit-undone-"+i),c=d.intval(g.val());while(c>0){h.pop();c--}g.val(0);h.push(j);f.val(JSON.stringify(h));d.refreshEditor(i,e,function(){d.setDisabled(a("#image-undo-"+i),true);d.setDisabled(a("#image-redo-"+i),false)})},rotate:function(e,f,d,c){if(a(c).hasClass("disabled")){return false}this.addStep({r:{r:e,fw:this.hold.h,fh:this.hold.w}},f,d)},flip:function(e,f,d,c){if(a(c).hasClass("disabled")){return false}this.addStep({f:{f:e,fw:this.hold.w,fh:this.hold.h}},f,d)},crop:function(i,f,d){var g=a("#imgedit-selection-"+i).val(),c=this.intval(a("#imgedit-sel-width-"+i).val()),e=this.intval(a("#imgedit-sel-height-"+i).val());if(a(d).hasClass("disabled")||g===""){return false}g=JSON.parse(g);if(g.w>0&&g.h>0&&c>0&&e>0){g.fw=c;g.fh=e;this.addStep({c:g},i,f)}},undo:function(h,f){var e=this,d=a("#image-undo-"+h),g=a("#imgedit-undone-"+h),c=e.intval(g.val())+1;if(d.hasClass("disabled")){return}g.val(c);e.refreshEditor(h,f,function(){var i=a("#imgedit-history-"+h),j=(i.val()!=="")?JSON.parse(i.val()):[];e.setDisabled(a("#image-redo-"+h),true);e.setDisabled(d,c<j.length);if(j.length===c){a("#image-redo-"+h).focus()}})},redo:function(h,f){var e=this,d=a("#image-redo-"+h),g=a("#imgedit-undone-"+h),c=e.intval(g.val())-1;if(d.hasClass("disabled")){return}g.val(c);e.refreshEditor(h,f,function(){e.setDisabled(a("#image-undo-"+h),true);e.setDisabled(d,c>0);if(0===c){a("#image-undo-"+h).focus()}})},setNumSelection:function(d,i){var h,m=a("#imgedit-sel-width-"+d),l=a("#imgedit-sel-height-"+d),q=this.intval(m.val()),o=this.intval(l.val()),k=a("#image-preview-"+d),r=k.height(),j=k.width(),c=this.hold.sizer,g,p,f,n,e=this.iasapi;if(false===this.validateNumeric(i)){return}if(q<1){m.val("");return false}if(o<1){l.val("");return false}if(q&&o&&(h=e.getSelection())){f=h.x1+Math.round(q*c);n=h.y1+Math.round(o*c);g=h.x1;p=h.y1;if(f>j){g=0;f=j;m.val(Math.round(f/c))}if(n>r){p=0;n=r;l.val(Math.round(n/c))}e.setSelection(g,p,f,n);e.update();this.setCropSelection(d,e.getSelection())}},round:function(c){var d;c=Math.round(c);if(this.hold.sizer>0.6){return c}d=c.toString().slice(-1);if("1"===d){return c-1}else{if("9"===d){return c+1}}return c},setRatioSelection:function(k,j,e){var g,f,c=this.intval(a("#imgedit-crop-width-"+k).val()),i=this.intval(a("#imgedit-crop-height-"+k).val()),d=a("#image-preview-"+k).height();if(false===this.validateNumeric(e)){return}if(c&&i){this.iasapi.setOptions({aspectRatio:c+":"+i});if(g=this.iasapi.getSelection(true)){f=Math.ceil(g.y1+((g.x2-g.x1)/(c/i)));if(f>d){f=d;if(j){a("#imgedit-crop-height-"+k).val("")}else{a("#imgedit-crop-width-"+k).val("")}}this.iasapi.setSelection(g.x1,g.y1,g.x2,f);this.iasapi.update()}}},validateNumeric:function(c){if(!this.intval(a(c).val())){a(c).val("");return false}}}})(jQuery);
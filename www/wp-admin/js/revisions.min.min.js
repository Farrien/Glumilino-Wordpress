window.wp=window.wp||{};(function(c){var d;d=wp.revisions={model:{},view:{},controller:{}};d.settings=window._wpRevisionsSettings||{};d.debug=false;d.log=function(){if(window.console&&d.debug){window.console.log.apply(window.console,arguments)}};c.fn.allOffsets=function(){var a=this.offset()||{top:0,left:0},b=c(window);return _.extend(a,{right:b.width()-a.left-this.outerWidth(),bottom:b.height()-a.top-this.outerHeight()})};c.fn.allPositions=function(){var b=this.position()||{top:0,left:0},a=this.parent();return _.extend(b,{right:a.outerWidth()-b.left-this.outerWidth(),bottom:a.outerHeight()-b.top-this.outerHeight()})};d.model.Slider=Backbone.Model.extend({defaults:{value:null,values:null,min:0,max:1,step:1,range:false,compareTwoMode:false},initialize:function(a){this.frame=a.frame;this.revisions=a.revisions;this.listenTo(this.frame,"update:revisions",this.receiveRevisions);this.listenTo(this.frame,"change:compareTwoMode",this.updateMode);this.on("change:from",this.handleLocalChanges);this.on("change:to",this.handleLocalChanges);this.on("change:compareTwoMode",this.updateSliderSettings);this.on("update:revisions",this.updateSliderSettings);this.on("change:hoveredRevision",this.hoverRevision);this.set({max:this.revisions.length-1,compareTwoMode:this.frame.get("compareTwoMode"),from:this.frame.get("from"),to:this.frame.get("to")});this.updateSliderSettings()},getSliderValue:function(a,b){return isRtl?this.revisions.length-this.revisions.indexOf(this.get(a))-1:this.revisions.indexOf(this.get(b))},updateSliderSettings:function(){if(this.get("compareTwoMode")){this.set({values:[this.getSliderValue("to","from"),this.getSliderValue("from","to")],value:null,range:true})}else{this.set({value:this.getSliderValue("to","to"),values:null,range:false})}this.trigger("update:slider")},hoverRevision:function(b,a){this.trigger("hovered:revision",a)},updateMode:function(b,a){this.set({compareTwoMode:a})},handleLocalChanges:function(){this.frame.set({from:this.get("from"),to:this.get("to")})},receiveRevisions:function(a,b){if(this.get("from")===a&&this.get("to")===b){return}this.set({from:a,to:b},{silent:true});this.trigger("update:revisions",a,b)}});d.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,offset:{},hovering:false,scrubbing:false},initialize:function(a){this.frame=a.frame;this.revisions=a.revisions;this.slider=a.slider;this.listenTo(this.slider,"hovered:revision",this.updateRevision);this.listenTo(this.slider,"change:hovering",this.setHovering);this.listenTo(this.slider,"change:scrubbing",this.setScrubbing)},updateRevision:function(a){this.set({revision:a})},setHovering:function(b,a){this.set({hovering:a})},setScrubbing:function(b,a){this.set({scrubbing:a})}});d.model.Revision=Backbone.Model.extend({});d.model.Revisions=Backbone.Collection.extend({model:d.model.Revision,initialize:function(){_.bindAll(this,"next","prev")},next:function(a){var b=this.indexOf(a);if(b!==-1&&b!==this.length-1){return this.at(b+1)}},prev:function(a){var b=this.indexOf(a);if(b!==-1&&b!==0){return this.at(b-1)}}});d.model.Field=Backbone.Model.extend({});d.model.Fields=Backbone.Collection.extend({model:d.model.Field});d.model.Diff=Backbone.Model.extend({initialize:function(){var a=this.get("fields");this.unset("fields");this.fields=new d.model.Fields(a)}});d.model.Diffs=Backbone.Collection.extend({initialize:function(a,b){_.bindAll(this,"getClosestUnloaded");this.loadAll=_.once(this._loadAll);this.revisions=b.revisions;this.postId=b.postId;this.requests={}},model:d.model.Diff,ensure:function(a,o){var l=this.get(a),m=this.requests[a],p=c.Deferred(),n={},b=a.split(":")[0],k=a.split(":")[1];n[a]=true;wp.revisions.log("ensure",a);this.trigger("ensure",n,b,k,p.promise());if(l){p.resolveWith(o,[l])}else{this.trigger("ensure:load",n,b,k,p.promise());_.each(n,_.bind(function(e){if(this.requests[e]){delete n[e]}if(this.get(e)){delete n[e]}},this));if(!m){n[a]=true;m=this.load(_.keys(n))}m.done(_.bind(function(){p.resolveWith(o,[this.get(a)])},this)).fail(_.bind(function(){p.reject()}))}return p.promise()},getClosestUnloaded:function(a,f){var b=this;return _.chain([0].concat(a)).initial().zip(a).sortBy(function(e){return Math.abs(f-e[1])}).map(function(e){return e.join(":")}).filter(function(e){return _.isUndefined(b.get(e))&&!b.requests[e]}).value()},_loadAll:function(b,l,i){var j=this,k=c.Deferred(),a=_.first(this.getClosestUnloaded(b,l),i);if(_.size(a)>0){this.load(a).done(function(){j._loadAll(b,l,i).done(function(){k.resolve()})}).fail(function(){if(1===i){k.reject()}else{j._loadAll(b,l,Math.ceil(i/2)).done(function(){k.resolve()})}})}else{k.resolve()}return k},load:function(a){wp.revisions.log("load",a);return this.fetch({data:{compare:a},remove:false}).done(function(){wp.revisions.log("load:complete",a)})},sync:function(a,h,i){if("read"===a){i=i||{};i.context=this;i.data=_.extend(i.data||{},{action:"get-revision-diffs",post_id:this.postId});var j=wp.ajax.send(i),b=this.requests;if(i.data.compare){_.each(i.data.compare,function(e){b[e]=j})}j.always(function(){if(i.data.compare){_.each(i.data.compare,function(e){delete b[e]})}});return j}else{return Backbone.Model.prototype.sync.apply(this,arguments)}}});d.model.FrameState=Backbone.Model.extend({defaults:{loading:false,error:false,compareTwoMode:false},initialize:function(f,b){var a=this.get("initialDiffState");_.bindAll(this,"receiveDiff");this._debouncedEnsureDiff=_.debounce(this._ensureDiff,200);this.revisions=b.revisions;this.diffs=new d.model.Diffs([],{revisions:this.revisions,postId:this.get("postId")});this.diffs.set(this.get("diffData"));this.listenTo(this,"change:from",this.changeRevisionHandler);this.listenTo(this,"change:to",this.changeRevisionHandler);this.listenTo(this,"change:compareTwoMode",this.changeMode);this.listenTo(this,"update:revisions",this.updatedRevisions);this.listenTo(this.diffs,"ensure:load",this.updateLoadingStatus);this.listenTo(this,"update:diff",this.updateLoadingStatus);this.set({to:this.revisions.get(a.to),from:this.revisions.get(a.from),compareTwoMode:a.compareTwoMode});if(window.history&&window.history.pushState){this.router=new d.Router({model:this});Backbone.history.start({pushState:true})}},updateLoadingStatus:function(){this.set("error",false);this.set("loading",!this.diff())},changeMode:function(f,b){var a=this.revisions.indexOf(this.get("to"));if(b&&0===a){this.set({from:this.revisions.at(a),to:this.revisions.at(a+1)})}if(!b&&0!==a){this.set({from:this.revisions.at(a-1),to:this.revisions.at(a)})}},updatedRevisions:function(a,b){if(this.get("compareTwoMode")){}else{this.diffs.loadAll(this.revisions.pluck("id"),b.id,40)}},diff:function(){return this.diffs.get(this._diffId)},updateDiff:function(j){var a,b,i,h;j=j||{};a=this.get("from");b=this.get("to");i=(a?a.id:0)+":"+b.id;if(this._diffId===i){return c.Deferred().reject().promise()}this._diffId=i;this.trigger("update:revisions",a,b);h=this.diffs.get(i);if(h){this.receiveDiff(h);return c.Deferred().resolve().promise()}else{if(j.immediate){return this._ensureDiff()}else{this._debouncedEnsureDiff();return c.Deferred().reject().promise()}}},changeRevisionHandler:function(){this.updateDiff()},receiveDiff:function(a){if(_.isUndefined(a)||_.isUndefined(a.id)){this.set({loading:false,error:true})}else{if(this._diffId===a.id){this.trigger("update:diff",a)}}},_ensureDiff:function(){return this.diffs.ensure(this._diffId,this).always(this.receiveDiff)}});d.view.Frame=wp.Backbone.View.extend({className:"revisions",template:wp.template("revisions-frame"),initialize:function(){this.listenTo(this.model,"update:diff",this.renderDiff);this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode);this.listenTo(this.model,"change:loading",this.updateLoadingStatus);this.listenTo(this.model,"change:error",this.updateErrorStatus);this.views.set(".revisions-control-frame",new d.view.Controls({model:this.model}))},render:function(){wp.Backbone.View.prototype.render.apply(this,arguments);c("html").css("overflow-y","scroll");c("#wpbody-content .wrap").append(this.el);this.updateCompareTwoMode();this.renderDiff(this.model.diff());this.views.ready();return this},renderDiff:function(a){this.views.set(".revisions-diff-frame",new d.view.Diff({model:a}))},updateLoadingStatus:function(){this.$el.toggleClass("loading",this.model.get("loading"))},updateErrorStatus:function(){this.$el.toggleClass("diff-error",this.model.get("error"))},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions",this.model.get("compareTwoMode"))}});d.view.Controls=wp.Backbone.View.extend({className:"revisions-controls",initialize:function(){_.bindAll(this,"setWidth");this.views.add(new d.view.Buttons({model:this.model}));this.views.add(new d.view.Checkbox({model:this.model}));var b=new d.model.Slider({frame:this.model,revisions:this.model.revisions}),a=new d.model.Tooltip({frame:this.model,revisions:this.model.revisions,slider:b});this.views.add(new d.view.Tooltip({model:a}));this.views.add(new d.view.Tickmarks({model:a}));this.views.add(new d.view.Slider({model:b}));this.views.add(new d.view.Metabox({model:this.model}))},ready:function(){this.top=this.$el.offset().top;this.window=c(window);this.window.on("scroll.wp.revisions",{controls:this},function(b){var i=b.data.controls,j=i.$el.parent(),e=i.window.scrollTop(),a=i.views.parent;if(e>=i.top){if(!a.$el.hasClass("pinned")){i.setWidth();j.css("height",j.height()+"px");i.window.on("resize.wp.revisions.pinning click.wp.revisions.pinning",{controls:i},function(f){f.data.controls.setWidth()})}a.$el.addClass("pinned")}else{if(a.$el.hasClass("pinned")){i.window.off(".wp.revisions.pinning");i.$el.css("width","auto");a.$el.removeClass("pinned");j.css("height","auto");i.top=i.$el.offset().top}else{i.top=i.$el.offset().top}}})},setWidth:function(){this.$el.css("width",this.$el.parent().width()+"px")}});d.view.Tickmarks=wp.Backbone.View.extend({className:"revisions-tickmarks",direction:isRtl?"right":"left",initialize:function(){this.listenTo(this.model,"change:revision",this.reportTickPosition)},reportTickPosition:function(k,l){var a,b,n,j,m=this.model.revisions.indexOf(l);b=this.$el.allOffsets();n=this.$el.parent().allOffsets();if(m===this.model.revisions.length-1){a={rightPlusWidth:b.left-n.left+1,leftPlusWidth:b.right-n.right+1}}else{j=this.$("div:nth-of-type("+(m+1)+")");a=j.allPositions();_.extend(a,{left:a.left+b.left-n.left,right:a.right+b.right-n.right});_.extend(a,{leftPlusWidth:a.left+j.outerWidth(),rightPlusWidth:a.right+j.outerWidth()})}this.model.set({offset:a})},ready:function(){var a,b;a=this.model.revisions.length-1;b=1/a;this.$el.css("width",(this.model.revisions.length*50)+"px");_(a).times(function(f){this.$el.append('<div style="'+this.direction+": "+(100*b*f)+'%"></div>')},this)}});d.view.Metabox=wp.Backbone.View.extend({className:"revisions-meta",initialize:function(){this.views.add(new d.view.MetaFrom({model:this.model,className:"diff-meta diff-meta-from"}));this.views.add(new d.view.MetaTo({model:this.model}))}});d.view.Meta=wp.Backbone.View.extend({template:wp.template("revisions-meta"),events:{"click .restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.render)},prepare:function(){return _.extend(this.model.toJSON()[this.type]||{},{type:this.type})},restoreRevision:function(){document.location=this.model.get("to").attributes.restoreUrl}});d.view.MetaFrom=d.view.Meta.extend({className:"diff-meta diff-meta-from",type:"from"});d.view.MetaTo=d.view.Meta.extend({className:"diff-meta diff-meta-to",type:"to"});d.view.Checkbox=wp.Backbone.View.extend({className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode)},ready:function(){if(this.model.revisions.length<3){c(".revision-toggle-compare-mode").hide()}},updateCompareTwoMode:function(){this.$(".compare-two-revisions").prop("checked",this.model.get("compareTwoMode"))},compareTwoToggle:function(){this.model.set({compareTwoMode:c(".compare-two-revisions").prop("checked")})}});d.view.Tooltip=wp.Backbone.View.extend({className:"revisions-tooltip",template:wp.template("revisions-meta"),initialize:function(){this.listenTo(this.model,"change:offset",this.render);this.listenTo(this.model,"change:hovering",this.toggleVisibility);this.listenTo(this.model,"change:scrubbing",this.toggleVisibility)},prepare:function(){if(_.isNull(this.model.get("revision"))){return}else{return _.extend({type:"tooltip"},{attributes:this.model.get("revision").toJSON()})}},render:function(){var a,b,j,i,k={},l=this.model.revisions.indexOf(this.model.get("revision"))+1;i=(l/this.model.revisions.length)>0.5;if(isRtl){b=i?"left":"right";j=i?"leftPlusWidth":b}else{b=i?"right":"left";j=i?"rightPlusWidth":b}a="right"===b?"left":"right";wp.Backbone.View.prototype.render.apply(this,arguments);k[b]=this.model.get("offset")[j]+"px";k[a]="";this.$el.toggleClass("flipped",i).css(k)},visible:function(){return this.model.get("scrubbing")||this.model.get("hovering")},toggleVisibility:function(){if(this.visible()){this.$el.stop().show().fadeTo(100-this.el.style.opacity*100,1)}else{this.$el.stop().fadeTo(this.el.style.opacity*300,0,function(){c(this).hide()})}return}});d.view.Buttons=wp.Backbone.View.extend({className:"revisions-buttons",template:wp.template("revisions-buttons"),events:{"click .revisions-next .button":"nextRevision","click .revisions-previous .button":"previousRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.disabledButtonCheck)},ready:function(){this.disabledButtonCheck()},gotoModel:function(a){var b={to:this.model.revisions.at(a)};if(a){b.from=this.model.revisions.at(a-1)}else{this.model.unset("from",{silent:true})}this.model.set(b)},nextRevision:function(){var a=this.model.revisions.indexOf(this.model.get("to"))+1;this.gotoModel(a)},previousRevision:function(){var a=this.model.revisions.indexOf(this.model.get("to"))-1;this.gotoModel(a)},disabledButtonCheck:function(){var a=this.model.revisions.length-1,j=0,i=c(".revisions-next .button"),h=c(".revisions-previous .button"),b=this.model.revisions.indexOf(this.model.get("to"));i.prop("disabled",(a===b));h.prop("disabled",(j===b))}});d.view.Slider=wp.Backbone.View.extend({className:"wp-slider",direction:isRtl?"right":"left",events:{mousemove:"mouseMove"},initialize:function(){_.bindAll(this,"start","slide","stop","mouseMove","mouseEnter","mouseLeave");this.listenTo(this.model,"update:slider",this.applySliderSettings)},ready:function(){this.$el.css("width",(this.model.revisions.length*50)+"px");this.$el.slider(_.extend(this.model.toJSON(),{start:this.start,slide:this.slide,stop:this.stop}));this.$el.hoverIntent({over:this.mouseEnter,out:this.mouseLeave,timeout:800});this.applySliderSettings()},mouseMove:function(a){var m=this.model.revisions.length-1,b=this.$el.allOffsets()[this.direction],k=this.$el.width(),n=k/m,e=(isRtl?c(window).width()-a.pageX:a.pageX)-b,l=Math.floor((e+(n/2))/n);if(l<0){l=0}else{if(l>=this.model.revisions.length){l=this.model.revisions.length-1}}this.model.set({hoveredRevision:this.model.revisions.at(l)})},mouseLeave:function(){this.model.set({hovering:false})},mouseEnter:function(){this.model.set({hovering:true})},applySliderSettings:function(){this.$el.slider(_.pick(this.model.toJSON(),"value","values","range"));var a=this.$("a.ui-slider-handle");if(this.model.get("compareTwoMode")){a.first().toggleClass("to-handle",!!isRtl).toggleClass("from-handle",!isRtl);a.last().toggleClass("from-handle",!!isRtl).toggleClass("to-handle",!isRtl)}else{a.removeClass("from-handle to-handle")}},start:function(b,a){this.model.set({scrubbing:true});c(window).on("mousemove.wp.revisions",{view:this},function(u){var e,t=u.data.view,p=t.$el.offset().left,x=p,w=p+t.$el.width(),s=w,r="0",q="100%",v=c(a.handle);if(t.model.get("compareTwoMode")){e=v.parent().find(".ui-slider-handle");if(v.is(e.first())){s=e.last().offset().left;q=s-x}else{p=e.first().offset().left+e.first().width();r=p-x}}if(u.pageX<p){v.css("left",r)}else{if(u.pageX>s){v.css("left",q)}else{v.css("left",u.pageX-x)}}})},getPosition:function(a){return isRtl?this.model.revisions.length-a-1:a},slide:function(g,a){var h,b;if(this.model.get("compareTwoMode")){if(a.values[1]===a.values[0]){return false}if(isRtl){a.values.reverse()}h={from:this.model.revisions.at(this.getPosition(a.values[0])),to:this.model.revisions.at(this.getPosition(a.values[1]))}}else{h={to:this.model.revisions.at(this.getPosition(a.value))};if(this.getPosition(a.value)>0){h.from=this.model.revisions.at(this.getPosition(a.value)-1)}else{h.from=undefined}}b=this.model.revisions.at(this.getPosition(a.value));if(this.model.get("scrubbing")){h.hoveredRevision=b}this.model.set(h)},stop:function(){c(window).off("mousemove.wp.revisions");this.model.updateSliderSettings();this.model.set({scrubbing:false})}});d.view.Diff=wp.Backbone.View.extend({className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},this.options)}});d.Router=Backbone.Router.extend({initialize:function(a){this.model=a.model;this.listenTo(this.model,"update:diff",_.debounce(this.updateUrl,250));this.listenTo(this.model,"change:compareTwoMode",this.updateUrl)},baseUrl:function(a){return this.model.get("baseUrl")+a},updateUrl:function(){var a=this.model.has("from")?this.model.get("from").id:0,b=this.model.get("to").id;if(this.model.get("compareTwoMode")){this.navigate(this.baseUrl("?from="+a+"&to="+b),{replace:true})}else{this.navigate(this.baseUrl("?revision="+b),{replace:true})}},handleRoute:function(b,f){var a=_.isUndefined(f);if(!a){f=this.model.revisions.get(b);b=this.model.revisions.prev(f);f=f?f.id:0;b=b?b.id:0}}});d.init=function(){var a;if(!window.adminpage||"revision-php"!==window.adminpage){return}a=new d.model.FrameState({initialDiffState:{to:parseInt(d.settings.to,10),from:parseInt(d.settings.from,10),compareTwoMode:(d.settings.compareTwoMode==="1")},diffData:d.settings.diffData,baseUrl:d.settings.baseUrl,postId:parseInt(d.settings.postId,10)},{revisions:new d.model.Revisions(d.settings.revisionData)});d.view.frame=new d.view.Frame({model:a}).render()};c(d.init)}(jQuery));
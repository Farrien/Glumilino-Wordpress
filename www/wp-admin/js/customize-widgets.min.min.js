(function(m,k){if(!m||!m.customize){return}var l=m.customize,n;l.Widgets=l.Widgets||{};l.Widgets.savedWidgetIds={};l.Widgets.data=_wpCustomizeWidgetsSettings||{};n=l.Widgets.data.l10n;delete l.Widgets.data.l10n;l.Widgets.WidgetModel=Backbone.Model.extend({id:null,temp_id:null,classname:null,control_tpl:null,description:null,is_disabled:null,is_multi:null,multi_number:null,name:null,id_base:null,transport:null,params:[],width:null,height:null,search_matched:true});l.Widgets.WidgetCollection=Backbone.Collection.extend({model:l.Widgets.WidgetModel,doSearch:function(a){if(this.terms===a){return}this.terms=a;if(this.terms.length>0){this.search(this.terms)}if(this.terms===""){this.each(function(b){b.set("search_matched",true)})}},search:function(b){var c,a;b=b.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");b=b.replace(/ /g,")(?=.*");c=new RegExp("^(?=.*"+b+").+","i");this.each(function(d){a=[d.get("name"),d.get("id"),d.get("description")].join(" ");d.set("search_matched",c.test(a))})}});l.Widgets.availableWidgets=new l.Widgets.WidgetCollection(l.Widgets.data.availableWidgets);l.Widgets.SidebarModel=Backbone.Model.extend({after_title:null,after_widget:null,before_title:null,before_widget:null,"class":null,description:null,id:null,name:null,is_rendered:false});l.Widgets.SidebarCollection=Backbone.Collection.extend({model:l.Widgets.SidebarModel});l.Widgets.registeredSidebars=new l.Widgets.SidebarCollection(l.Widgets.data.registeredSidebars);l.Widgets.AvailableWidgetsPanelView=m.Backbone.View.extend({el:"#available-widgets",events:{"input #widgets-search":"search","keyup #widgets-search":"search","focus .widget-tpl":"focus","click .widget-tpl":"_submit","keypress .widget-tpl":"_submit",keydown:"keyboardAccessible"},selected:null,currentSidebarControl:null,$search:null,$clearResults:null,searchMatchesCount:null,initialize:function(){var a=this;this.$search=k("#widgets-search");this.$clearResults=this.$el.find(".clear-results");_.bindAll(this,"close");this.listenTo(this.collection,"change",this.updateList);this.updateList();this.searchMatchesCount=this.collection.length;k("#customize-controls, #available-widgets .customize-section-title").on("click keydown",function(b){var c=k(b.target).is(".add-new-widget, .add-new-widget *");if(k("body").hasClass("adding-widget")&&!c){a.close()}});this.$clearResults.on("click",function(){a.$search.val("").focus().trigger("keyup")});l.previewer.bind("url",this.close)},search:function(b){var a;this.collection.doSearch(b.target.value);this.updateSearchMatchesCount();this.announceSearchMatches();if(this.selected&&!this.selected.is(":visible")){this.selected.removeClass("selected");this.selected=null}if(this.selected&&!b.target.value){this.selected.removeClass("selected");this.selected=null}if(!this.selected&&b.target.value){a=this.$el.find("> .widget-tpl:visible:first");if(a.length){this.select(a)}}if(""!==b.target.value){this.$clearResults.addClass("is-visible")}else{if(""===b.target.value){this.$clearResults.removeClass("is-visible")}}if(!this.searchMatchesCount){this.$el.addClass("no-widgets-found")}else{this.$el.removeClass("no-widgets-found")}},updateSearchMatchesCount:function(){this.searchMatchesCount=this.collection.where({search_matched:true}).length},announceSearchMatches:_.debounce(function(){var a=n.widgetsFound.replace("%d",this.searchMatchesCount);if(!this.searchMatchesCount){a=n.noWidgetsFound}m.a11y.speak(a)},500),updateList:function(){this.collection.each(function(b){var a=k("#widget-tpl-"+b.id);a.toggle(b.get("search_matched")&&!b.get("is_disabled"));if(b.get("is_disabled")&&a.is(this.selected)){this.selected=null}})},select:function(a){this.selected=k(a);this.selected.siblings(".widget-tpl").removeClass("selected");this.selected.addClass("selected")},focus:function(a){this.select(k(a.currentTarget))},_submit:function(a){if(a.type==="keypress"&&(a.which!==13&&a.which!==32)){return}this.submit(k(a.currentTarget))},submit:function(a){var c,b,d;if(!a){a=this.selected}if(!a||!this.currentSidebarControl){return}this.select(a);c=k(this.selected).data("widget-id");b=this.collection.findWhere({id:c});if(!b){return}d=this.currentSidebarControl.addWidget(b.get("id_base"));if(d){d.focus()}this.close()},open:function(a){this.currentSidebarControl=a;_(this.currentSidebarControl.getWidgetFormControls()).each(function(b){if(b.params.is_wide){b.collapseForm()}});k("body").addClass("adding-widget");this.$el.find(".selected").removeClass("selected");this.collection.doSearch("");if(!l.settings.browser.mobile){this.$search.focus()}},close:function(a){a=a||{};if(a.returnFocus&&this.currentSidebarControl){this.currentSidebarControl.container.find(".add-new-widget").focus()}this.currentSidebarControl=null;this.selected=null;k("body").removeClass("adding-widget");this.$search.val("")},keyboardAccessible:function(w){var b=(w.which===13),c=(w.which===27),e=(w.which===40),t=(w.which===38),u=(w.which===9),v=(w.shiftKey),g=null,d=this.$el.find("> .widget-tpl:visible:first"),f=this.$el.find("> .widget-tpl:visible:last"),a=k(w.target).is(this.$search),x=k(w.target).is(".widget-tpl:visible:last");if(e||t){if(e){if(a){g=d}else{if(this.selected&&this.selected.nextAll(".widget-tpl:visible").length!==0){g=this.selected.nextAll(".widget-tpl:visible:first")}}}else{if(t){if(a){g=f}else{if(this.selected&&this.selected.prevAll(".widget-tpl:visible").length!==0){g=this.selected.prevAll(".widget-tpl:visible:first")}}}}this.select(g);if(g){g.focus()}else{this.$search.focus()}return}if(b&&!this.$search.val()){return}if(b){this.submit()}else{if(c){this.close({returnFocus:true})}}if(this.currentSidebarControl&&u&&(v&&a||!v&&x)){this.currentSidebarControl.container.find(".add-new-widget").focus();w.preventDefault()}}});l.Widgets.formSyncHandlers={rss:function(a,b,d){var c=b.find(".widget-error:first"),e=k("<div>"+d+"</div>").find(".widget-error:first");if(c.length&&e.length){c.replaceWith(e)}else{if(c.length){c.remove()}else{if(e.length){b.find(".widget-content:first").prepend(e)}}}}};l.Widgets.WidgetControl=l.Control.extend({defaultExpandedArguments:{duration:"fast",completeCallback:k.noop},initialize:function(a,c){var b=this;b.widgetControlEmbedded=false;b.widgetContentEmbedded=false;b.expanded=new l.Value(false);b.expandedArgumentsQueue=[];b.expanded.bind(function(e){var d=b.expandedArgumentsQueue.shift();d=k.extend({},b.defaultExpandedArguments,d);b.onChangeExpanded(e,d)});b.altNotice=true;l.Control.prototype.initialize.call(b,a,c)},ready:function(){var a=this;if(!a.section()){a.embedWidgetControl()}else{l.section(a.section(),function(b){var c=function(d){if(d){a.embedWidgetControl();b.expanded.unbind(c)}};if(b.expanded()){c(true)}else{b.expanded.bind(c)}})}},embedWidgetControl:function(){var a=this,b;if(a.widgetControlEmbedded){return}a.widgetControlEmbedded=true;b=k(a.params.widget_control);a.container.append(b);a._setupModel();a._setupWideWidget();a._setupControlToggle();a._setupWidgetTitle();a._setupReorderUI();a._setupHighlightEffects();a._setupUpdateUI();a._setupRemoveUI()},embedWidgetContent:function(){var a=this,b;a.embedWidgetControl();if(a.widgetContentEmbedded){return}a.widgetContentEmbedded=true;b=k(a.params.widget_content);a.container.find(".widget-content:first").append(b);k(document).trigger("widget-added",[a.container.find(".widget:first")])},_setupModel:function(){var b=this,a;a=function(){l.Widgets.savedWidgetIds[b.params.widget_id]=true};l.bind("ready",a);l.bind("saved",a);this._updateCount=0;this.isWidgetUpdating=false;this.liveUpdateMode=true;this.setting.bind(function(c,d){if(!_(d).isEqual(c)&&!b.isWidgetUpdating){b.updateWidget({instance:c})}})},_setupWideWidget:function(){var e=this,c,a,b,d,f;if(!this.params.is_wide){return}c=this.container.find(".widget-inside");a=c.find("> .form");b=k(".wp-full-overlay-sidebar-content:first");this.container.addClass("wide-widget-control");this.container.find(".widget-content:first").css({"max-width":this.params.width,"min-height":this.params.height});f=function(){var t=e.container.offset().top,g=k(window).height(),s=a.outerHeight(),r;c.css("max-height",g);r=Math.max(0,Math.min(Math.max(t,0),g-s));c.css("top",r)};d=k("#customize-theme-controls");this.container.on("expand",function(){f();b.on("scroll",f);k(window).on("resize",f);d.on("expanded collapsed",f)});this.container.on("collapsed",function(){b.off("scroll",f);k(window).off("resize",f);d.off("expanded collapsed",f)});l.each(function(g){if(0===g.id.indexOf("sidebars_widgets[")){g.bind(function(){if(e.container.hasClass("expanded")){f()}})}})},_setupControlToggle:function(){var b=this,a;this.container.find(".widget-top").on("click",function(c){c.preventDefault();var d=b.getSidebarWidgetsControl();if(d.isReordering){return}b.expanded(!b.expanded())});a=this.container.find(".widget-control-close");a.on("click",function(c){c.preventDefault();b.collapse();b.container.find(".widget-top .widget-action:first").focus()})},_setupWidgetTitle:function(){var b=this,a;a=function(){var c=b.setting().title,d=b.container.find(".in-widget-title");if(c){d.text(": "+c)}else{d.text("")}};this.setting.bind(a);a()},_setupReorderUI:function(){var d=this,a,b,e,f,c;a=function(p){p.siblings(".selected").removeClass("selected");p.addClass("selected");var g=(p.data("id")===d.params.sidebar_id);d.container.find(".move-widget-btn").prop("disabled",g)};this.container.find(".widget-title-action").after(k(l.Widgets.data.tpl.widgetReorderNav));c=_.template(l.Widgets.data.tpl.moveWidgetArea);b=k(c({sidebars:_(l.Widgets.registeredSidebars.toArray()).pluck("attributes")}));this.container.find(".widget-top").after(b);f=function(){var q=b.find("li"),g,r=0;g=q.filter(function(){return k(this).data("id")===d.params.sidebar_id});q.each(function(){var v=k(this),p,u,o;p=v.data("id");u=l.Widgets.registeredSidebars.get(p);o=u.get("is_rendered");v.toggle(o);if(o){r+=1}if(v.hasClass("selected")&&!o){a(g)}});if(r>1){d.container.find(".move-widget").show()}else{d.container.find(".move-widget").hide()}};f();l.Widgets.registeredSidebars.on("change:is_rendered",f);e=this.container.find(".widget-reorder-nav");e.find(".move-widget, .move-widget-down, .move-widget-up").each(function(){k(this).prepend(d.container.find(".widget-title").text()+": ")}).on("click keypress",function(s){if(s.type==="keypress"&&(s.which!==13&&s.which!==32)){return}k(this).focus();if(k(this).is(".move-widget")){d.toggleWidgetMoveArea()}else{var r=k(this).is(".move-widget-down"),g=k(this).is(".move-widget-up"),t=d.getWidgetSidebarPosition();if((g&&t===0)||(r&&t===d.getSidebarWidgetsControl().setting().length-1)){return}if(g){d.moveUp();m.a11y.speak(n.widgetMovedUp)}else{d.moveDown();m.a11y.speak(n.widgetMovedDown)}k(this).focus()}});this.container.find(".widget-area-select").on("click keypress","li",function(g){if(g.type==="keypress"&&(g.which!==13&&g.which!==32)){return}g.preventDefault();a(k(this))});this.container.find(".move-widget-btn").click(function(){d.getSidebarWidgetsControl().toggleReordering(false);var w=d.params.sidebar_id,x=d.container.find(".widget-area-select li.selected").data("id"),z,y,u,g,v;z=l("sidebars_widgets["+w+"]");y=l("sidebars_widgets["+x+"]");u=Array.prototype.slice.call(z());g=Array.prototype.slice.call(y());v=d.getWidgetSidebarPosition();u.splice(v,1);g.push(d.params.widget_id);z(u);y(g);d.focus()})},_setupHighlightEffects:function(){var a=this;this.container.on("mouseenter click",function(){a.setting.previewer.send("highlight-widget",a.params.widget_id)});this.setting.bind(function(){a.setting.previewer.send("highlight-widget",a.params.widget_id)})},_setupUpdateUI:function(){var e=this,d,b,a,f,c;d=this.container.find(".widget:first");b=d.find(".widget-content:first");a=this.container.find(".widget-control-save");a.val(n.saveBtnLabel);a.attr("title",n.saveBtnTooltip);a.removeClass("button-primary");a.on("click",function(g){g.preventDefault();e.updateWidget({disable_form:true})});f=_.debounce(function(){e.updateWidget()},250);b.on("keydown","input",function(g){if(13===g.which){g.preventDefault();e.updateWidget({ignoreActiveElement:true})}});b.on("change input propertychange",":input",function(g){if(!e.liveUpdateMode){return}if(g.type==="change"||(this.checkValidity&&this.checkValidity())){f()}});this.setting.previewer.channel.bind("synced",function(){e.container.removeClass("previewer-loading")});l.previewer.bind("widget-updated",function(g){if(g===e.params.widget_id){e.container.removeClass("previewer-loading")}});c=l.Widgets.formSyncHandlers[this.params.widget_id_base];if(c){k(document).on("widget-synced",function(g,p){if(d.is(p)){c.apply(document,arguments)}})}},onChangeActive:function(a,b){this.container.toggleClass("widget-rendered",a);if(b.completeCallback){b.completeCallback()}},_setupRemoveUI:function(){var b=this,c,a;c=this.container.find("a.widget-control-remove");c.on("click",function(e){e.preventDefault();var d;if(b.container.next().is(".customize-control-widget_form")){d=b.container.next().find(".widget-action:first")}else{if(b.container.prev().is(".customize-control-widget_form")){d=b.container.prev().find(".widget-action:first")}else{d=b.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first")}}b.container.slideUp(function(){var g=l.Widgets.getSidebarWidgetControlContainingWidget(b.params.widget_id),p,f;if(!g){return}p=g.setting().slice();f=_.indexOf(p,b.params.widget_id);if(-1===f){return}p.splice(f,1);g.setting(p);d.focus()})});a=function(){c.text(n.removeBtnLabel);c.attr("title",n.removeBtnTooltip)};if(this.params.is_new){l.bind("saved",a)}else{a()}},_getInputs:function(a){return k(a).find(":input[name]")},_getInputsSignature:function(b){var a=_(b).map(function(e){var c=k(e),d;if(c.is(":checkbox, :radio")){d=[c.attr("id"),c.attr("name"),c.prop("value")]}else{d=[c.attr("id"),c.attr("name")]}return d.join(",")});return a.join(";")},_getInputState:function(a){a=k(a);if(a.is(":radio, :checkbox")){return a.prop("checked")}else{if(a.is("select[multiple]")){return a.find("option:selected").map(function(){return k(this).val()}).get()}else{return a.val()}}},_setInputState:function(b,a){b=k(b);if(b.is(":radio, :checkbox")){b.prop("checked",a)}else{if(b.is("select[multiple]")){if(!k.isArray(a)){a=[]}else{a=_.map(a,function(c){return String(c)})}b.find("option").each(function(){k(this).prop("selected",-1!==_.indexOf(a,String(this.value)))})}else{b.val(a)}}},getSidebarWidgetsControl:function(){var a,b;a="sidebars_widgets["+this.params.sidebar_id+"]";b=l.control(a);if(!b){return}return b},updateWidget:function(e){var y=this,x,a,c,d,b,g,f,w,u,v,z;y.embedWidgetContent();e=k.extend({instance:null,complete:null,ignoreActiveElement:false},e);x=e.instance;a=e.complete;this._updateCount+=1;b=this._updateCount;c=this.container.find(".widget:first");d=c.find(".widget-content:first");d.find(".widget-error").remove();this.container.addClass("widget-form-loading");this.container.addClass("previewer-loading");u=l.state("processing");u(u()+1);if(!this.liveUpdateMode){this.container.addClass("widget-form-disabled")}g={};g.action="update-widget";g.wp_customize="on";g.nonce=l.settings.nonce["update-widget"];g.customize_theme=l.settings.theme.stylesheet;g.customized=m.customize.previewer.query().customized;f=k.param(g);w=this._getInputs(d);w.each(function(){k(this).data("state"+b,y._getInputState(this))});if(x){f+="&"+k.param({sanitized_widget_setting:JSON.stringify(x)})}else{f+="&"+w.serialize()}f+="&"+d.find("~ :input").serialize();if(this._previousUpdateRequest){this._previousUpdateRequest.abort()}v=k.post(m.ajax.settings.url,f);this._previousUpdateRequest=v;v.done(function(s){var t,r,o,p,q=false;if("0"===s){l.previewer.preview.iframe.hide();l.previewer.login().done(function(){y.updateWidget(e);l.previewer.preview.iframe.show()});return}if("-1"===s){l.previewer.cheatin();return}if(s.success){r=k("<div>"+s.data.form+"</div>");o=y._getInputs(r);p=y._getInputsSignature(w)===y._getInputsSignature(o);if(p&&!y.liveUpdateMode){y.liveUpdateMode=true;y.container.removeClass("widget-form-disabled");y.container.find('input[name="savewidget"]').hide()}if(p&&y.liveUpdateMode){w.each(function(K){var H=k(this),L=k(o[K]),G,J,I;G=H.data("state"+b);J=y._getInputState(L);H.data("sanitized",J);I=(!_.isEqual(G,J)&&(e.ignoreActiveElement||!H.is(document.activeElement)));if(I){y._setInputState(H,J)}});k(document).trigger("widget-synced",[c,s.data.form])}else{if(y.liveUpdateMode){y.liveUpdateMode=false;y.container.find('input[name="savewidget"]').show();q=true}else{d.html(s.data.form);y.container.removeClass("widget-form-disabled");k(document).trigger("widget-updated",[c])}}z=!q&&!_(y.setting()).isEqual(s.data.instance);if(z){y.isWidgetUpdating=true;y.setting(s.data.instance);y.isWidgetUpdating=false}else{y.container.removeClass("previewer-loading")}if(a){a.call(y,null,{noChange:!z,ajaxFinished:true})}}else{t=n.error;if(s.data&&s.data.message){t=s.data.message}if(a){a.call(y,t)}else{d.prepend('<p class="widget-error"><strong>'+t+"</strong></p>")}}});v.fail(function(p,o){if(a){a.call(y,o)}});v.always(function(){y.container.removeClass("widget-form-loading");w.each(function(){k(this).removeData("state"+b)});u(u()-1)})},expandControlSection:function(){l.Control.prototype.expand.call(this)},_toggleExpanded:l.Section.prototype._toggleExpanded,expand:l.Section.prototype.expand,expandForm:function(){this.expand()},collapse:l.Section.prototype.collapse,collapseForm:function(){this.collapse()},toggleForm:function(a){if(typeof a==="undefined"){a=!this.expanded()}this.expanded(a)},onChangeExpanded:function(c,a){var d=this,g,b,e,p,f;d.embedWidgetControl();if(c){d.embedWidgetContent()}if(a.unchanged){if(c){l.Control.prototype.expand.call(d,{completeCallback:a.completeCallback})}return}g=this.container.find("div.widget:first");b=g.find(".widget-inside:first");f=function(){l.control.each(function(o){if(d.params.type===o.params.type&&d!==o){o.collapse()}});e=function(){d.container.removeClass("expanding");d.container.addClass("expanded");d.container.trigger("expanded")};if(a.completeCallback){p=e;e=function(){p();a.completeCallback()}}if(d.params.is_wide){b.fadeIn(a.duration,e)}else{b.slideDown(a.duration,e)}d.container.trigger("expand");d.container.addClass("expanding")};if(c){if(l.section.has(d.section())){l.section(d.section()).expand({completeCallback:f})}else{f()}}else{e=function(){d.container.removeClass("collapsing");d.container.removeClass("expanded");d.container.trigger("collapsed")};if(a.completeCallback){p=e;e=function(){p();a.completeCallback()}}d.container.trigger("collapse");d.container.addClass("collapsing");if(d.params.is_wide){b.fadeOut(a.duration,e)}else{b.slideUp(a.duration,function(){g.css({width:"",margin:""});e()})}}},getWidgetSidebarPosition:function(){var a,b;a=this.getSidebarWidgetsControl().setting();b=_.indexOf(a,this.params.widget_id);if(b===-1){return}return b},moveUp:function(){this._moveWidgetByOne(-1)},moveDown:function(){this._moveWidgetByOne(1)},_moveWidgetByOne:function(a){var b,e,c,d;b=this.getWidgetSidebarPosition();e=this.getSidebarWidgetsControl().setting;c=Array.prototype.slice.call(e());d=c[b+a];c[b+a]=this.params.widget_id;c[b]=d;e(c)},toggleWidgetMoveArea:function(c){var b=this,a;a=this.container.find(".move-widget-area");if(typeof c==="undefined"){c=!a.hasClass("active")}if(c){a.find(".selected").removeClass("selected");a.find("li").filter(function(){return k(this).data("id")===b.params.sidebar_id}).addClass("selected");this.container.find(".move-widget-btn").prop("disabled",true)}a.toggleClass("active",c)},highlightSectionAndControl:function(){var a;if(this.container.is(":hidden")){a=this.container.closest(".control-section")}else{a=this.container}k(".highlighted").removeClass("highlighted");a.addClass("highlighted");setTimeout(function(){a.removeClass("highlighted")},500)}});l.Widgets.WidgetsPanel=l.Panel.extend({ready:function(){var a=this;l.Panel.prototype.ready.call(a);a.deferred.embedded.done(function(){var b,c,d;b=a.container.find(".panel-meta");c=k("<div></div>",{"class":"no-widget-areas-rendered-notice"});c.append(k("<em></em>",{text:n.noAreasRendered}));b.append(c);d=function(){return(0===_.filter(a.sections(),function(e){return e.active()}).length)};c.toggle(d());l.previewer.deferred.active.done(function(){c.toggle(d())});l.bind("pane-contents-reflowed",function(){var e=("resolved"===l.previewer.deferred.active.state())?"fast":0;if(d()){c.slideDown(e)}else{c.slideUp(e)}})})},isContextuallyActive:function(){var a=this;return a.active()}});l.Widgets.SidebarSection=l.Section.extend({ready:function(){var b=this,a;l.Section.prototype.ready.call(this);a=l.Widgets.registeredSidebars.get(b.params.sidebarId);b.active.bind(function(c){a.set("is_rendered",c)});a.set("is_rendered",b.active())}});l.Widgets.SidebarControl=l.Control.extend({ready:function(){this.$controlSection=this.container.closest(".control-section");this.$sectionContent=this.container.closest(".accordion-section-content");this._setupModel();this._setupSortable();this._setupAddition();this._applyCardinalOrderClassNames()},_setupModel:function(){var a=this;this.setting.bind(function(c,b){var e,f,d;f=_(b).difference(c);c=_(c).filter(function(g){var p=i(g);return !!l.Widgets.availableWidgets.findWhere({id_base:p.id_base})});e=_(c).map(function(g){var p=l.Widgets.getWidgetFormControlForWidget(g);if(!p){p=a.addWidget(g)}return p});e.sort(function(r,t){var g=_.indexOf(c,r.params.widget_id),s=_.indexOf(c,t.params.widget_id);return g-s});d=0;_(e).each(function(g){g.priority(d);g.section(a.section());d+=1});a.priority(d);a._applyCardinalOrderClassNames();_(e).each(function(g){g.params.sidebar_id=a.params.sidebar_id});_(f).each(function(g){setTimeout(function(){var u,y,v,z,w,x=false;l.each(function(o){if(o.id===a.setting.id||0!==o.id.indexOf("sidebars_widgets[")||o.id==="sidebars_widgets[wp_inactive_widgets]"){return}var p=o(),q;q=_.indexOf(p,g);if(-1!==q){x=true}});if(x){return}u=l.Widgets.getWidgetFormControlForWidget(g);y=u&&k.contains(document,u.container[0])&&!k.contains(a.$sectionContent[0],u.container[0]);if(u&&!y){l.control.remove(u.id);u.container.remove()}if(l.Widgets.savedWidgetIds[g]){v=l.value("sidebars_widgets[wp_inactive_widgets]")().slice();v.push(g);l.value("sidebars_widgets[wp_inactive_widgets]")(_(v).unique())}z=i(g).id_base;w=l.Widgets.availableWidgets.findWhere({id_base:z});if(w&&!w.get("is_multi")){w.set("is_disabled",false)}})})})},_setupSortable:function(){var a=this;this.isReordering=false;this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",connectWith:".accordion-section-content:has(.customize-control-sidebar_widgets)",update:function(){var b=a.$sectionContent.sortable("toArray"),c;c=k.map(b,function(d){return k("#"+d).find(":input[name=widget-id]").val()});a.setting(c)}});this.$controlSection.find(".accordion-section-title").droppable({accept:".customize-control-widget_form",over:function(){var b=l.section(a.section.get());b.expand({allowMultiple:true,completeCallback:function(){l.section.each(function(c){if(c.container.find(".customize-control-sidebar_widgets").length){c.container.find(".accordion-section-content:first").sortable("refreshPositions")}})}})}});this.container.find(".reorder-toggle").on("click",function(){a.toggleReordering(!a.isReordering)})},_setupAddition:function(){var a=this;this.container.find(".add-new-widget").on("click",function(){var b=k(this);if(a.$sectionContent.hasClass("reordering")){return}if(!k("body").hasClass("adding-widget")){b.attr("aria-expanded","true");l.Widgets.availableWidgetsPanel.open(a)}else{b.attr("aria-expanded","false");l.Widgets.availableWidgetsPanel.close()}})},_applyCardinalOrderClassNames:function(){var a=[];_.each(this.setting(),function(b){var c=l.Widgets.getWidgetFormControlForWidget(b);if(c){a.push(c)}});if(0===a.length||(1===l.Widgets.registeredSidebars.length&&a.length<=1)){this.container.find(".reorder-toggle").hide();return}else{this.container.find(".reorder-toggle").show()}k(a).each(function(){k(this.container).removeClass("first-widget").removeClass("last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)});_.first(a).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1);_.last(a).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1)},toggleReordering:function(d){var c=this.$sectionContent.find(".add-new-widget"),a=this.container.find(".reorder-toggle"),b=this.$sectionContent.find(".widget-title");d=Boolean(d);if(d===this.$sectionContent.hasClass("reordering")){return}this.isReordering=d;this.$sectionContent.toggleClass("reordering",d);if(d){_(this.getWidgetFormControls()).each(function(e){e.collapse()});c.attr({tabindex:"-1","aria-hidden":"true"});a.attr("aria-label",n.reorderLabelOff);m.a11y.speak(n.reorderModeOn);b.attr("aria-hidden","true")}else{c.removeAttr("tabindex aria-hidden");a.attr("aria-label",n.reorderLabelOn);m.a11y.speak(n.reorderModeOff);b.attr("aria-hidden","false")}},getWidgetFormControls:function(){var a=[];_(this.setting()).each(function(d){var c=h(d),b=l.control(c);if(b){a.push(b)}});return a},addWidget:function(d){var D=this,H,B,A="widget_form",c,E,y=i(d),a=y.number,e=y.id_base,f=l.Widgets.availableWidgets.findWhere({id_base:e}),F,G,z,b,g,C;if(!f){return false}if(a&&!f.get("is_multi")){return false}if(f.get("is_multi")&&!a){f.set("multi_number",f.get("multi_number")+1);a=f.get("multi_number")}H=k.trim(k("#widget-tpl-"+f.get("id")).html());if(f.get("is_multi")){H=H.replace(/<[^<>]+>/g,function(o){return o.replace(/__i__|%i%/g,a)})}else{f.set("is_disabled",true)}B=k(H);c=k("<li/>").addClass("customize-control").addClass("customize-control-"+A).append(B);c.find("> .widget-icon").remove();if(f.get("is_multi")){c.find('input[name="widget_number"]').val(a);c.find('input[name="multi_number"]').val(a)}d=c.find('[name="widget-id"]').val();c.hide();F="widget_"+f.get("id_base");if(f.get("is_multi")){F+="["+a+"]"}c.attr("id","customize-control-"+F.replace(/\]/g,"").replace(/\[/g,"-"));G=l.has(F);if(!G){g={transport:l.Widgets.data.selectiveRefreshableWidgets[f.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer};C=l.create(F,F,"",g);C.set({})}E=l.controlConstructor[A];z=new E(F,{params:{settings:{"default":F},content:c,sidebar_id:D.params.sidebar_id,widget_id:d,widget_id_base:f.get("id_base"),type:A,is_new:!G,width:f.get("width"),height:f.get("height"),is_wide:f.get("is_wide"),active:true},previewer:D.setting.previewer});l.control.add(F,z);l.each(function(o){if(o.id===D.setting.id){return}if(0!==o.id.indexOf("sidebars_widgets[")){return}var p=o().slice(),q=_.indexOf(p,d);if(-1!==q){p.splice(q);o(p)}});b=this.setting().slice();if(-1===_.indexOf(b,d)){b.push(d);this.setting(b)}c.slideDown(function(){if(G){z.updateWidget({instance:z.setting()})}});return z}});k.extend(l.panelConstructor,{widgets:l.Widgets.WidgetsPanel});k.extend(l.sectionConstructor,{sidebar:l.Widgets.SidebarSection});k.extend(l.controlConstructor,{widget_form:l.Widgets.WidgetControl,sidebar_widgets:l.Widgets.SidebarControl});l.bind("ready",function(){l.Widgets.availableWidgetsPanel=new l.Widgets.AvailableWidgetsPanelView({collection:l.Widgets.availableWidgets});l.previewer.bind("highlight-widget-control",l.Widgets.highlightWidgetFormControl);l.previewer.bind("focus-widget-control",l.Widgets.focusWidgetFormControl)});l.Widgets.highlightWidgetFormControl=function(b){var a=l.Widgets.getWidgetFormControlForWidget(b);if(a){a.highlightSectionAndControl()}},l.Widgets.focusWidgetFormControl=function(b){var a=l.Widgets.getWidgetFormControlForWidget(b);if(a){a.focus()}},l.Widgets.getSidebarWidgetControlContainingWidget=function(b){var a=null;l.control.each(function(c){if(c.params.type==="sidebar_widgets"&&-1!==_.indexOf(c.setting(),b)){a=c}});return a};l.Widgets.getWidgetFormControlForWidget=function(b){var a=null;l.control.each(function(c){if(c.params.type==="widget_form"&&c.params.widget_id===b){a=c}});return a};k(document).on("widget-added",function(c,d){var a,e,b,f;a=i(d.find("> .widget-inside > .form > .widget-id").val());if("nav_menu"!==a.id_base){return}e=l.control("widget_nav_menu["+String(a.number)+"]");if(!e){return}b=d.find('select[name*="nav_menu"]');f=d.find(".edit-selected-nav-menu > button");if(0===b.length||0===f.length){return}b.on("change",function(){if(l.section.has("nav_menu["+b.val()+"]")){f.parent().show()}else{f.parent().hide()}});f.on("click",function(){var g=l.section("nav_menu["+b.val()+"]");if(g){j(g,e)}})});function j(b,a){b.focus();function c(d){if(!d){b.expanded.unbind(c);a.focus()}}b.expanded.bind(c)}function i(b){var a,c={number:null,id_base:null};a=b.match(/^(.+)-(\d+)$/);if(a){c.id_base=a[1];c.number=parseInt(a[2],10)}else{c.id_base=b}return c}function h(b){var c=i(b),a;a="widget_"+c.id_base;if(c.number){a+="["+c.number+"]"}return a}})(window.wp,jQuery);